{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":96,"name":"21-Charter-PostType","code":"\/**\n * ============================================================================\n * Snippet: 21-Charter-PostType\n * Title: \u5305\u8eca\u9810\u7d04\u6587\u7ae0\u985e\u578b\n * Description: \u8a3b\u518a\u5305\u8eca\u9810\u7d04\u7684\u81ea\u8a02\u6587\u7ae0\u985e\u578b\u8207\u7ba1\u7406\u4ecb\u9762\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 21\n * Dependencies: 20-Charter-Settings\n * Hook: init\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ \u6aa2\u67e5\u4f9d\u8cf4\nif (!class_exists('NineOVan_Charter_Settings')) {\n    error_log('[21-Charter-PostType] \u932f\u8aa4\uff1a\u7f3a\u5c11\u5fc5\u8981\u7684\u8a2d\u5b9a\u985e\u5225');\n    return;\n}\n\n\/**\n * \u5305\u8eca\u9810\u7d04\u6587\u7ae0\u985e\u578b\u985e\u5225\n *\/\nclass NineOVan_Charter_PostType {\n    \n    private static $instance = null;\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        $this->init_hooks();\n    }\n    \n    \/**\n     * \u521d\u59cb\u5316\u9264\u5b50\n     *\/\n    private function init_hooks() {\n        \/\/ \u8a3b\u518a\u6587\u7ae0\u985e\u578b\n        add_action('init', array($this, 'register_post_type'));\n        \n        \/\/ \u81ea\u8a02\u6b04\u4f4d\n        add_action('add_meta_boxes', array($this, 'add_meta_boxes'));\n        add_action('save_post_charter_booking', array($this, 'save_meta_boxes'));\n        \n        \/\/ \u5217\u8868\u6b04\u4f4d\n        add_filter('manage_charter_booking_posts_columns', array($this, 'set_custom_columns'));\n        add_action('manage_charter_booking_posts_custom_column', array($this, 'custom_column_content'), 10, 2);\n        add_filter('manage_edit-charter_booking_sortable_columns', array($this, 'sortable_columns'));\n        \n        \/\/ \u67e5\u8a62\u904e\u6ffe\n        add_action('pre_get_posts', array($this, 'custom_orderby'));\n        add_filter('posts_clauses', array($this, 'search_custom_fields'), 10, 2);\n        \n        \/\/ \u6279\u6b21\u52d5\u4f5c\n        add_filter('bulk_actions-edit-charter_booking', array($this, 'register_bulk_actions'));\n        add_filter('handle_bulk_actions-edit-charter_booking', array($this, 'handle_bulk_actions'), 10, 3);\n        \n        \/\/ \u7ba1\u7406\u901a\u77e5\n        add_action('admin_notices', array($this, 'admin_notices'));\n    }\n    \n    \/**\n     * \u8a3b\u518a\u6587\u7ae0\u985e\u578b\n     *\/\n    public function register_post_type() {\n        $labels = array(\n            'name'                  => '\u5305\u8eca\u65c5\u904a\u9810\u7d04',\n            'singular_name'         => '\u5305\u8eca\u9810\u7d04',\n            'menu_name'             => '\u5305\u8eca\u65c5\u904a',\n            'name_admin_bar'        => '\u5305\u8eca\u9810\u7d04',\n            'add_new'               => '\u65b0\u589e\u9810\u7d04',\n            'add_new_item'          => '\u65b0\u589e\u5305\u8eca\u9810\u7d04',\n            'new_item'              => '\u65b0\u5305\u8eca\u9810\u7d04',\n            'edit_item'             => '\u7de8\u8f2f\u9810\u7d04',\n            'view_item'             => '\u67e5\u770b\u9810\u7d04',\n            'all_items'             => '\u6240\u6709\u9810\u7d04',\n            'search_items'          => '\u641c\u5c0b\u9810\u7d04',\n            'parent_item_colon'     => '\u7236\u9810\u7d04:',\n            'not_found'             => '\u6c92\u6709\u627e\u5230\u9810\u7d04',\n            'not_found_in_trash'    => '\u56de\u6536\u6876\u4e2d\u6c92\u6709\u9810\u7d04',\n            'featured_image'        => '\u9810\u7d04\u5716\u7247',\n            'set_featured_image'    => '\u8a2d\u5b9a\u9810\u7d04\u5716\u7247',\n            'remove_featured_image' => '\u79fb\u9664\u9810\u7d04\u5716\u7247',\n            'use_featured_image'    => '\u4f7f\u7528\u9810\u7d04\u5716\u7247',\n            'archives'              => '\u9810\u7d04\u6a94\u6848',\n            'insert_into_item'      => '\u63d2\u5165\u5230\u9810\u7d04',\n            'uploaded_to_this_item' => '\u4e0a\u50b3\u5230\u6b64\u9810\u7d04',\n            'filter_items_list'     => '\u904e\u6ffe\u9810\u7d04\u5217\u8868',\n            'items_list_navigation' => '\u9810\u7d04\u5217\u8868\u5c0e\u822a',\n            'items_list'            => '\u9810\u7d04\u5217\u8868',\n        );\n        \n        $args = array(\n            'labels'              => $labels,\n            'public'              => false,\n            'publicly_queryable'  => false,\n            'show_ui'             => true,\n            'show_in_menu'        => true,\n            'query_var'           => false,\n            'rewrite'             => false,\n            'capability_type'     => 'post',\n            'has_archive'         => false,\n            'hierarchical'        => false,\n            'menu_position'       => 26,\n            'menu_icon'           => 'dashicons-location-alt',\n            'supports'            => array('title'),\n            'capabilities'        => array(\n                'create_posts' => 'do_not_allow', \/\/ \u7981\u6b62\u5f9e\u5f8c\u53f0\u65b0\u589e\n            ),\n            'map_meta_cap'        => true,\n        );\n        \n        register_post_type('charter_booking', $args);\n    }\n    \n    \/**\n     * \u65b0\u589e\u81ea\u8a02\u6b04\u4f4d\n     *\/\n    public function add_meta_boxes() {\n        \/\/ \u5ba2\u6236\u8cc7\u8a0a\n        add_meta_box(\n            'charter_customer_info',\n            '\u5ba2\u6236\u8cc7\u8a0a',\n            array($this, 'render_customer_info_meta_box'),\n            'charter_booking',\n            'normal',\n            'high'\n        );\n        \n        \/\/ \u884c\u7a0b\u8cc7\u8a0a\n        add_meta_box(\n            'charter_trip_info',\n            '\u884c\u7a0b\u8cc7\u8a0a',\n            array($this, 'render_trip_info_meta_box'),\n            'charter_booking',\n            'normal',\n            'high'\n        );\n        \n        \/\/ \u50f9\u683c\u660e\u7d30\n        add_meta_box(\n            'charter_price_info',\n            '\u50f9\u683c\u660e\u7d30',\n            array($this, 'render_price_info_meta_box'),\n            'charter_booking',\n            'side',\n            'default'\n        );\n        \n        \/\/ \u72c0\u614b\u7ba1\u7406\n        add_meta_box(\n            'charter_status',\n            '\u9810\u7d04\u72c0\u614b',\n            array($this, 'render_status_meta_box'),\n            'charter_booking',\n            'side',\n            'high'\n        );\n    }\n    \n    \/**\n     * \u6e32\u67d3\u5ba2\u6236\u8cc7\u8a0a\u6b04\u4f4d\n     *\/\n    public function render_customer_info_meta_box($post) {\n        $booking_data = get_post_meta($post->ID, '_booking_data', true);\n        if (!$booking_data) {\n            $booking_data = array();\n        }\n        \n        wp_nonce_field('charter_booking_meta', 'charter_booking_meta_nonce');\n        ?>\n        <table class=\"form-table\">\n            <tr>\n                <th><label>\u5ba2\u6236\u59d3\u540d<\/label><\/th>\n                <td>\n                    <input type=\"text\" name=\"customer_name\" \n                           value=\"<?php echo esc_attr($booking_data['customer_name'] ?? ''); ?>\" \n                           class=\"regular-text\" \/>\n                <\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u806f\u7d61\u96fb\u8a71<\/label><\/th>\n                <td>\n                    <input type=\"text\" name=\"customer_phone\" \n                           value=\"<?php echo esc_attr($booking_data['customer_phone'] ?? ''); ?>\" \n                           class=\"regular-text\" \/>\n                <\/td>\n            <\/tr>\n            <tr>\n                <th><label>Email<\/label><\/th>\n                <td>\n                    <input type=\"email\" name=\"customer_email\" \n                           value=\"<?php echo esc_attr($booking_data['customer_email'] ?? ''); ?>\" \n                           class=\"regular-text\" \/>\n                    <?php if (empty($booking_data['customer_email'])): ?>\n                        <p class=\"description\" style=\"color: #d63638;\">\u26a0\ufe0f \u5ba2\u6236\u672a\u63d0\u4f9b Email<\/p>\n                    <?php endif; ?>\n                <\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u4e58\u5ba2\u4eba\u6578<\/label><\/th>\n                <td>\n                    <input type=\"number\" name=\"passengers\" \n                           value=\"<?php echo esc_attr($booking_data['passengers'] ?? 1); ?>\" \n                           min=\"1\" max=\"8\" \/>\n                <\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u5099\u8a3b<\/label><\/th>\n                <td>\n                    <textarea name=\"notes\" rows=\"3\" class=\"large-text\"><?php \n                        echo esc_textarea($booking_data['notes'] ?? ''); \n                    ?><\/textarea>\n                <\/td>\n            <\/tr>\n        <\/table>\n        <?php\n    }\n    \n    \/**\n     * \u6e32\u67d3\u884c\u7a0b\u8cc7\u8a0a\u6b04\u4f4d\n     *\/\n    public function render_trip_info_meta_box($post) {\n        $booking_data = get_post_meta($post->ID, '_booking_data', true);\n        if (!$booking_data) {\n            $booking_data = array();\n        }\n        ?>\n        <table class=\"form-table\">\n            <tr>\n                <th><label>\u884c\u7a0b\u5929\u6578<\/label><\/th>\n                <td><?php echo esc_html($booking_data['trip_days'] ?? 1); ?> \u5929<\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u51fa\u767c\u65e5\u671f<\/label><\/th>\n                <td><?php echo esc_html($booking_data['start_date'] ?? ''); ?><\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u51fa\u767c\u6642\u9593<\/label><\/th>\n                <td><?php echo esc_html($booking_data['start_time'] ?? ''); ?><\/td>\n            <\/tr>\n            <tr>\n                <th><label>\u7d50\u675f\u65e5\u671f<\/label><\/th>\n                <td><?php echo esc_html($booking_data['end_date'] ?? ''); ?><\/td>\n            <\/tr>\n        <\/table>\n        \n        <?php if (!empty($booking_data['daily_routes'])): ?>\n            <h4>\u6bcf\u65e5\u884c\u7a0b<\/h4>\n            <?php foreach ($booking_data['daily_routes'] as $day => $route): ?>\n                <div style=\"background: #f6f7f7; padding: 10px; margin: 10px 0; border-radius: 5px;\">\n                    <strong>Day <?php echo $day + 1; ?><\/strong><br>\n                    \u8d77\u9ede\uff1a<?php echo esc_html($route['origin'] ?? ''); ?><br>\n                    \u7d42\u9ede\uff1a<?php echo esc_html($route['destination'] ?? ''); ?><br>\n                    <?php if (!empty($route['stops'])): ?>\n                        \u505c\u9760\u9ede\uff1a<?php echo esc_html(implode('\u3001', $route['stops'])); ?>\n                    <?php endif; ?>\n                <\/div>\n            <?php endforeach; ?>\n        <?php endif; ?>\n        \n        <?php if (!empty($booking_data['mountain_detection'])): ?>\n            <h4>\u5c71\u5340\u6aa2\u6e2c<\/h4>\n            <div style=\"background: #fff8e5; padding: 10px; border-left: 3px solid #f59e0b;\">\n                <?php if (!empty($booking_data['mountain_detection']['needs_manual_check'])): ?>\n                    <strong style=\"color: #92400e;\">\u26a0\ufe0f \u9700\u8981\u4eba\u5de5\u78ba\u8a8d\u5c71\u5340\u8def\u7dda<\/strong>\n                <?php endif; ?>\n            <\/div>\n        <?php endif; ?>\n        <?php\n    }\n    \n    \/**\n     * \u6e32\u67d3\u50f9\u683c\u8cc7\u8a0a\u6b04\u4f4d\n     *\/\n    public function render_price_info_meta_box($post) {\n        $booking_data = get_post_meta($post->ID, '_booking_data', true);\n        if (!$booking_data) {\n            $booking_data = array();\n        }\n        ?>\n        <p>\n            <strong>\u7e3d\u91d1\u984d\uff1a<\/strong><br>\n            <span style=\"font-size: 24px; color: #2271b1;\">\n                NT$ <?php echo number_format($booking_data['total_price'] ?? 0); ?>\n            <\/span>\n        <\/p>\n        \n        <?php if (!empty($booking_data['deposit'])): ?>\n            <p>\n                <strong>\u8a02\u91d1 (30%)\uff1a<\/strong><br>\n                NT$ <?php echo number_format($booking_data['deposit']); ?>\n            <\/p>\n            <p>\n                <strong>\u5c3e\u6b3e (70%)\uff1a<\/strong><br>\n                NT$ <?php echo number_format($booking_data['balance'] ?? 0); ?>\n            <\/p>\n        <?php endif; ?>\n        \n        <hr>\n        \n        <p>\n            <strong>\u53f8\u6a5f\u5b89\u6392\uff1a<\/strong><br>\n            <?php \n            if (($booking_data['driver_accommodation'] ?? '') === 'book') {\n                echo '\u9700\u4ee3\u8a02\u4f4f\u5bbf';\n            } else {\n                echo '\u5ba2\u6236\u63d0\u4f9b\u4f4f\u5bbf';\n            }\n            ?><br>\n            <?php \n            if (($booking_data['driver_meals'] ?? '') === 'allowance') {\n                echo '\u9700\u9910\u8cbb\u88dc\u8cbc';\n            } else {\n                echo '\u5ba2\u6236\u63d0\u4f9b\u9910\u9ede';\n            }\n            ?>\n        <\/p>\n        \n        <?php if (!empty($booking_data['child_seats']) || !empty($booking_data['booster_seats'])): ?>\n            <hr>\n            <p>\n                <strong>\u52a0\u8cfc\u9805\u76ee\uff1a<\/strong><br>\n                <?php if (!empty($booking_data['child_seats'])): ?>\n                    \u5b30\u5152\u5ea7\u6905 x <?php echo $booking_data['child_seats']; ?><br>\n                <?php endif; ?>\n                <?php if (!empty($booking_data['booster_seats'])): ?>\n                    \u589e\u9ad8\u588a x <?php echo $booking_data['booster_seats']; ?><br>\n                <?php endif; ?>\n            <\/p>\n        <?php endif; ?>\n        <?php\n    }\n    \n    \/**\n     * \u6e32\u67d3\u72c0\u614b\u6b04\u4f4d\n     *\/\n    public function render_status_meta_box($post) {\n        $booking_status = get_post_meta($post->ID, '_booking_status', true) ?: 'pending';\n        $payment_status = get_post_meta($post->ID, '_payment_status', true) ?: 'unpaid';\n        ?>\n        <p>\n            <label><strong>\u9810\u7d04\u72c0\u614b\uff1a<\/strong><\/label><br>\n            <select name=\"booking_status\" style=\"width: 100%;\">\n                <option value=\"pending\" <?php selected($booking_status, 'pending'); ?>>\u5f85\u78ba\u8a8d<\/option>\n                <option value=\"confirmed\" <?php selected($booking_status, 'confirmed'); ?>>\u5df2\u78ba\u8a8d<\/option>\n                <option value=\"in_service\" <?php selected($booking_status, 'in_service'); ?>>\u670d\u52d9\u4e2d<\/option>\n                <option value=\"completed\" <?php selected($booking_status, 'completed'); ?>>\u5df2\u5b8c\u6210<\/option>\n                <option value=\"cancelled\" <?php selected($booking_status, 'cancelled'); ?>>\u5df2\u53d6\u6d88<\/option>\n            <\/select>\n        <\/p>\n        \n        <p>\n            <label><strong>\u4ed8\u6b3e\u72c0\u614b\uff1a<\/strong><\/label><br>\n            <select name=\"payment_status\" style=\"width: 100%;\">\n                <option value=\"unpaid\" <?php selected($payment_status, 'unpaid'); ?>>\u672a\u4ed8\u6b3e<\/option>\n                <option value=\"deposit_paid\" <?php selected($payment_status, 'deposit_paid'); ?>>\u5df2\u4ed8\u8a02\u91d1<\/option>\n                <option value=\"paid\" <?php selected($payment_status, 'paid'); ?>>\u5df2\u4ed8\u5168\u984d<\/option>\n                <option value=\"refunded\" <?php selected($payment_status, 'refunded'); ?>>\u5df2\u9000\u6b3e<\/option>\n            <\/select>\n        <\/p>\n        \n        <hr>\n        \n        <p>\n            <strong>\u9810\u7d04\u7de8\u865f\uff1a<\/strong><br>\n            CHT<?php echo str_pad($post->ID, 6, '0', STR_PAD_LEFT); ?>\n        <\/p>\n        \n        <p>\n            <strong>\u9810\u7d04\u6642\u9593\uff1a<\/strong><br>\n            <?php echo get_the_date('Y-m-d H:i', $post); ?>\n        <\/p>\n        <?php\n    }\n    \n    \/**\n     * \u5132\u5b58\u81ea\u8a02\u6b04\u4f4d\n     *\/\n    public function save_meta_boxes($post_id) {\n        \/\/ \u6aa2\u67e5 nonce\n        if (!isset($_POST['charter_booking_meta_nonce']) || \n            !wp_verify_nonce($_POST['charter_booking_meta_nonce'], 'charter_booking_meta')) {\n            return;\n        }\n        \n        \/\/ \u6aa2\u67e5\u81ea\u52d5\u5132\u5b58\n        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {\n            return;\n        }\n        \n        \/\/ \u6aa2\u67e5\u6b0a\u9650\n        if (!current_user_can('edit_post', $post_id)) {\n            return;\n        }\n        \n        \/\/ \u66f4\u65b0\u72c0\u614b\n        if (isset($_POST['booking_status'])) {\n            update_post_meta($post_id, '_booking_status', sanitize_text_field($_POST['booking_status']));\n        }\n        \n        if (isset($_POST['payment_status'])) {\n            update_post_meta($post_id, '_payment_status', sanitize_text_field($_POST['payment_status']));\n        }\n        \n        \/\/ \u66f4\u65b0\u5ba2\u6236\u8cc7\u6599\n        $booking_data = get_post_meta($post_id, '_booking_data', true);\n        if (!$booking_data) {\n            $booking_data = array();\n        }\n        \n        if (isset($_POST['customer_name'])) {\n            $booking_data['customer_name'] = sanitize_text_field($_POST['customer_name']);\n            update_post_meta($post_id, '_customer_name', $booking_data['customer_name']);\n        }\n        \n        if (isset($_POST['customer_phone'])) {\n            $booking_data['customer_phone'] = sanitize_text_field($_POST['customer_phone']);\n            update_post_meta($post_id, '_customer_phone', $booking_data['customer_phone']);\n        }\n        \n        if (isset($_POST['customer_email'])) {\n            $booking_data['customer_email'] = sanitize_email($_POST['customer_email']);\n            update_post_meta($post_id, '_customer_email', $booking_data['customer_email']);\n        }\n        \n        if (isset($_POST['passengers'])) {\n            $booking_data['passengers'] = intval($_POST['passengers']);\n        }\n        \n        if (isset($_POST['notes'])) {\n            $booking_data['notes'] = sanitize_textarea_field($_POST['notes']);\n        }\n        \n        \/\/ \u66f4\u65b0\u9810\u7d04\u8cc7\u6599\n        update_post_meta($post_id, '_booking_data', $booking_data);\n    }\n    \n    \/**\n     * \u8a2d\u5b9a\u81ea\u8a02\u6b04\u4f4d\n     *\/\n    public function set_custom_columns($columns) {\n        $new_columns = array();\n        \n        $new_columns['cb'] = $columns['cb'];\n        $new_columns['title'] = '\u9810\u7d04\u7de8\u865f';\n        $new_columns['customer'] = '\u5ba2\u6236';\n        $new_columns['trip_info'] = '\u884c\u7a0b';\n        $new_columns['price'] = '\u91d1\u984d';\n        $new_columns['status'] = '\u72c0\u614b';\n        $new_columns['date'] = '\u9810\u7d04\u6642\u9593';\n        \n        return $new_columns;\n    }\n    \n    \/**\n     * \u81ea\u8a02\u6b04\u4f4d\u5167\u5bb9\n     *\/\n    public function custom_column_content($column, $post_id) {\n        $booking_data = get_post_meta($post_id, '_booking_data', true);\n        \n        switch ($column) {\n            case 'customer':\n                echo esc_html($booking_data['customer_name'] ?? '');\n                echo '<br><small>' . esc_html($booking_data['customer_phone'] ?? '') . '<\/small>';\n                if (empty($booking_data['customer_email'])) {\n                    echo '<br><small style=\"color: #d63638;\">\u7121 Email<\/small>';\n                }\n                break;\n                \n            case 'trip_info':\n                echo esc_html($booking_data['trip_days'] ?? 1) . ' \u5929<br>';\n                echo '<small>' . esc_html($booking_data['start_date'] ?? '') . '<\/small>';\n                break;\n                \n            case 'price':\n                echo 'NT$ ' . number_format($booking_data['total_price'] ?? 0);\n                break;\n                \n            case 'status':\n                $booking_status = get_post_meta($post_id, '_booking_status', true) ?: 'pending';\n                $payment_status = get_post_meta($post_id, '_payment_status', true) ?: 'unpaid';\n                \n                $status_labels = array(\n                    'pending' => '<span style=\"color: #996800;\">\u5f85\u78ba\u8a8d<\/span>',\n                    'confirmed' => '<span style=\"color: #0073aa;\">\u5df2\u78ba\u8a8d<\/span>',\n                    'in_service' => '<span style=\"color: #00a32a;\">\u670d\u52d9\u4e2d<\/span>',\n                    'completed' => '<span style=\"color: #135e96;\">\u5df2\u5b8c\u6210<\/span>',\n                    'cancelled' => '<span style=\"color: #d63638;\">\u5df2\u53d6\u6d88<\/span>'\n                );\n                \n                $payment_labels = array(\n                    'unpaid' => '<span style=\"color: #996800;\">\u672a\u4ed8\u6b3e<\/span>',\n                    'deposit_paid' => '<span style=\"color: #0073aa;\">\u5df2\u4ed8\u8a02\u91d1<\/span>',\n                    'paid' => '<span style=\"color: #00a32a;\">\u5df2\u4ed8\u5168\u984d<\/span>',\n                    'refunded' => '<span style=\"color: #d63638;\">\u5df2\u9000\u6b3e<\/span>'\n                );\n                \n                echo $status_labels[$booking_status] ?? $booking_status;\n                echo '<br>';\n                echo $payment_labels[$payment_status] ?? $payment_status;\n                break;\n        }\n    }\n    \n    \/**\n     * \u53ef\u6392\u5e8f\u6b04\u4f4d\n     *\/\n    public function sortable_columns($columns) {\n        $columns['price'] = 'price';\n        $columns['trip_info'] = 'trip_days';\n        return $columns;\n    }\n    \n    \/**\n     * \u81ea\u8a02\u6392\u5e8f\n     *\/\n    public function custom_orderby($query) {\n        if (!is_admin() || !$query->is_main_query()) {\n            return;\n        }\n        \n        if ($query->get('post_type') !== 'charter_booking') {\n            return;\n        }\n        \n        $orderby = $query->get('orderby');\n        \n        if ($orderby === 'price') {\n            $query->set('meta_key', '_total_price');\n            $query->set('orderby', 'meta_value_num');\n        }\n        \n        if ($orderby === 'trip_days') {\n            $query->set('meta_key', '_trip_days');\n            $query->set('orderby', 'meta_value_num');\n        }\n    }\n    \n    \/**\n     * \u641c\u5c0b\u81ea\u8a02\u6b04\u4f4d\n     *\/\n    public function search_custom_fields($clauses, $query) {\n        global $wpdb;\n        \n        if (!is_admin() || !$query->is_main_query() || !$query->is_search()) {\n            return $clauses;\n        }\n        \n        if ($query->get('post_type') !== 'charter_booking') {\n            return $clauses;\n        }\n        \n        $search_term = $query->get('s');\n        if (empty($search_term)) {\n            return $clauses;\n        }\n        \n        \/\/ \u641c\u5c0b\u5ba2\u6236\u59d3\u540d\u3001\u96fb\u8a71\n        $clauses['join'] .= \" LEFT JOIN {$wpdb->postmeta} pm1 ON {$wpdb->posts}.ID = pm1.post_id \";\n        $clauses['join'] .= \" LEFT JOIN {$wpdb->postmeta} pm2 ON {$wpdb->posts}.ID = pm2.post_id \";\n        \n        $clauses['where'] = preg_replace(\n            \"\/\\({$wpdb->posts}.post_title LIKE\/\",\n            \"(pm1.meta_key = '_customer_name' AND pm1.meta_value LIKE '%{$search_term}%') OR \" .\n            \"(pm2.meta_key = '_customer_phone' AND pm2.meta_value LIKE '%{$search_term}%') OR \" .\n            \"({$wpdb->posts}.post_title LIKE\",\n            $clauses['where']\n        );\n        \n        return $clauses;\n    }\n    \n    \/**\n     * \u8a3b\u518a\u6279\u6b21\u52d5\u4f5c\n     *\/\n    public function register_bulk_actions($bulk_actions) {\n        $bulk_actions['mark_confirmed'] = '\u6a19\u8a18\u70ba\u5df2\u78ba\u8a8d';\n        $bulk_actions['mark_completed'] = '\u6a19\u8a18\u70ba\u5df2\u5b8c\u6210';\n        $bulk_actions['export_csv'] = '\u532f\u51fa CSV';\n        return $bulk_actions;\n    }\n    \n    \/**\n     * \u8655\u7406\u6279\u6b21\u52d5\u4f5c\n     *\/\n    public function handle_bulk_actions($redirect_to, $action, $post_ids) {\n        if ($action === 'mark_confirmed') {\n            foreach ($post_ids as $post_id) {\n                update_post_meta($post_id, '_booking_status', 'confirmed');\n            }\n            $redirect_to = add_query_arg('bulk_confirmed', count($post_ids), $redirect_to);\n        }\n        \n        if ($action === 'mark_completed') {\n            foreach ($post_ids as $post_id) {\n                update_post_meta($post_id, '_booking_status', 'completed');\n            }\n            $redirect_to = add_query_arg('bulk_completed', count($post_ids), $redirect_to);\n        }\n        \n        if ($action === 'export_csv') {\n            \/\/ \u5be6\u4f5c CSV \u532f\u51fa\n            $this->export_bookings_csv($post_ids);\n        }\n        \n        return $redirect_to;\n    }\n    \n    \/**\n     * \u7ba1\u7406\u54e1\u901a\u77e5\n     *\/\n    public function admin_notices() {\n        if (!empty($_REQUEST['bulk_confirmed'])) {\n            $count = intval($_REQUEST['bulk_confirmed']);\n            printf(\n                '<div class=\"notice notice-success is-dismissible\"><p>%d \u7b46\u9810\u7d04\u5df2\u6a19\u8a18\u70ba\u5df2\u78ba\u8a8d\u3002<\/p><\/div>',\n                $count\n            );\n        }\n        \n        if (!empty($_REQUEST['bulk_completed'])) {\n            $count = intval($_REQUEST['bulk_completed']);\n            printf(\n                '<div class=\"notice notice-success is-dismissible\"><p>%d \u7b46\u9810\u7d04\u5df2\u6a19\u8a18\u70ba\u5df2\u5b8c\u6210\u3002<\/p><\/div>',\n                $count\n            );\n        }\n    }\n    \n    \/**\n     * \u532f\u51fa CSV\n     *\/\n    private function export_bookings_csv($post_ids) {\n        \/\/ \u8a2d\u5b9a CSV headers\n        header('Content-Type: text\/csv; charset=UTF-8');\n        header('Content-Disposition: attachment; filename=\"charter-bookings-' . date('Y-m-d') . '.csv\"');\n        header('Pragma: no-cache');\n        header('Expires: 0');\n        \n        \/\/ \u52a0\u5165 BOM \u4ee5\u652f\u63f4 Excel \u4e2d\u6587\n        echo \"\\xEF\\xBB\\xBF\";\n        \n        \/\/ \u958b\u555f\u8f38\u51fa\u4e32\u6d41\n        $output = fopen('php:\/\/output', 'w');\n        \n        \/\/ CSV \u6a19\u984c\u5217\n        fputcsv($output, array(\n            '\u9810\u7d04\u7de8\u865f',\n            '\u5ba2\u6236\u59d3\u540d',\n            '\u96fb\u8a71',\n            'Email',\n            '\u884c\u7a0b\u5929\u6578',\n            '\u51fa\u767c\u65e5\u671f',\n            '\u7e3d\u91d1\u984d',\n            '\u9810\u7d04\u72c0\u614b',\n            '\u4ed8\u6b3e\u72c0\u614b',\n            '\u9810\u7d04\u6642\u9593'\n        ));\n        \n        \/\/ \u8f38\u51fa\u8cc7\u6599\n        foreach ($post_ids as $post_id) {\n            $booking_data = get_post_meta($post_id, '_booking_data', true);\n            $booking_status = get_post_meta($post_id, '_booking_status', true);\n            $payment_status = get_post_meta($post_id, '_payment_status', true);\n            \n            fputcsv($output, array(\n                'CHT' . str_pad($post_id, 6, '0', STR_PAD_LEFT),\n                $booking_data['customer_name'] ?? '',\n                $booking_data['customer_phone'] ?? '',\n                $booking_data['customer_email'] ?? '',\n                $booking_data['trip_days'] ?? '',\n                $booking_data['start_date'] ?? '',\n                $booking_data['total_price'] ?? 0,\n                $booking_status,\n                $payment_status,\n                get_the_date('Y-m-d H:i', $post_id)\n            ));\n        }\n        \n        fclose($output);\n        exit;\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\nNineOVan_Charter_PostType::get_instance();\n\n\/\/ \u8a18\u9304\u6a21\u7d44\u8f09\u5165\nif (defined('_9O_VAN_DEBUG') && _9O_VAN_DEBUG) {\n    error_log('[21-Charter-PostType] \u6a21\u7d44\u5df2\u8f09\u5165 - v1.0.0');\n}","active":true,"priority":21,"modified":"2025-09-14 02:50:58","revision":"1"}]}