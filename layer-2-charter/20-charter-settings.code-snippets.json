{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":95,"name":"20-Charter-Settings","code":"\/**\n * ============================================================================\n * Snippet: 20-Charter-Settings\n * Title: \u5305\u8eca\u65c5\u904a\u50f9\u683c\u8a2d\u5b9a\n * Description: \u5b9a\u7fa9\u5305\u8eca\u670d\u52d9\u7684\u50f9\u683c\u898f\u5247\u3001\u5c71\u5340\u8a2d\u5b9a\u3001\u53f8\u6a5f\u88dc\u8cbc\u7b49\u914d\u7f6e\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 20\n * Dependencies: 00-Global-Constants\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ \u6aa2\u67e5\u4f9d\u8cf4\nif (!defined('_9O_VAN_VERSION')) {\n    error_log('[20-Charter-Settings] \u932f\u8aa4\uff1a\u7f3a\u5c11\u5fc5\u8981\u7684\u5168\u57df\u5e38\u6578\u5b9a\u7fa9');\n    return;\n}\n\n\/**\n * \u5305\u8eca\u65c5\u904a\u8a2d\u5b9a\u985e\u5225\n *\/\nclass NineOVan_Charter_Settings {\n    \n    private static $instance = null;\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        $this->define_constants();\n        $this->init_hooks();\n    }\n    \n    \/**\n     * \u5b9a\u7fa9\u5e38\u6578\n     *\/\n    private function define_constants() {\n        \/\/ Google Maps API Key (\u5982\u679c\u5c1a\u672a\u5b9a\u7fa9)\n        if (!defined('GOOGLE_MAPS_API_KEY')) {\n            define('GOOGLE_MAPS_API_KEY', 'AIzaSyD7m-umnnMHhXTi11_uvI14Rel6mCN1Dz4');\n        }\n        \n        \/\/ \u5305\u8eca\u670d\u52d9\u5e38\u6578\n        if (!defined('_9O_VAN_CHARTER_VERSION')) {\n            define('_9O_VAN_CHARTER_VERSION', '1.0.0');\n        }\n        \n        \/\/ \u6700\u5927\u5929\u6578\u9650\u5236\n        if (!defined('_9O_VAN_CHARTER_MAX_DAYS')) {\n            define('_9O_VAN_CHARTER_MAX_DAYS', 7);\n        }\n        \n        \/\/ \u6bcf\u65e5\u6700\u5927\u505c\u9760\u9ede\n        if (!defined('_9O_VAN_CHARTER_MAX_STOPS_PER_DAY')) {\n            define('_9O_VAN_CHARTER_MAX_STOPS_PER_DAY', 6);\n        }\n        \n        \/\/ \u5c71\u5340\u6d77\u62d4\u9580\u6abb (\u516c\u5c3a)\n        if (!defined('_9O_VAN_CHARTER_MOUNTAIN_ELEVATION')) {\n            define('_9O_VAN_CHARTER_MOUNTAIN_ELEVATION', 500);\n        }\n        \n        \/\/ \u6700\u5c0f\u9810\u7d04\u5929\u6578\n        if (!defined('_9O_VAN_CHARTER_MIN_BOOKING_DAYS')) {\n            define('_9O_VAN_CHARTER_MIN_BOOKING_DAYS', 2);\n        }\n    }\n    \n    \/**\n     * \u521d\u59cb\u5316\u9264\u5b50\n     *\/\n    private function init_hooks() {\n        \/\/ \u8a3b\u518a\u8a2d\u5b9a\u9801\u9762\n        add_action('admin_menu', array($this, 'add_settings_page'), 30);\n        \n        \/\/ \u8a3b\u518a\u8a2d\u5b9a\n        add_action('admin_init', array($this, 'register_settings'));\n        \n        \/\/ AJAX \u7aef\u9ede\n        add_action('wp_ajax_9o_van_save_charter_settings', array($this, 'ajax_save_settings'));\n        add_action('wp_ajax_9o_van_reset_charter_settings', array($this, 'ajax_reset_settings'));\n    }\n    \n    \/**\n     * \u57fa\u672c\u50f9\u683c\u8a2d\u5b9a\n     *\/\n    public static function get_base_rates() {\n        return apply_filters('9o_van_charter_base_rates', array(\n            'north' => 12000,        \/\/ \u5609\u7fa9(\u542b)\u4ee5\u5317\n            'south' => 14000,        \/\/ \u5609\u7fa9\u4ee5\u5357\/\u82b1\u6771\n            'daily_discount' => 1000 \/\/ \u7b2c\u4e8c\u5929\u8d77\u6bcf\u65e5\u6298\u6263\n        ));\n    }\n    \n    \/**\n     * \u5730\u5340\u5206\u985e - 14,000\u5143\u5340\u57df\n     *\/\n    public static function get_south_14k_cities() {\n        return array(\n            '\u53f0\u5357\u5e02', '\u81fa\u5357\u5e02',\n            '\u9ad8\u96c4\u5e02',\n            '\u5c4f\u6771\u7e23',\n            '\u82b1\u84ee\u7e23',\n            '\u53f0\u6771\u7e23', '\u81fa\u6771\u7e23'\n        );\n    }\n    \n    \/**\n     * \u5c71\u5340\u95dc\u9375\u5b57\u5b9a\u7fa9\n     *\/\n    public static function get_mountain_keywords() {\n        return apply_filters('9o_van_charter_mountain_keywords', array(\n            '\u5c71', '\u5dba', '\u5cf0', '\u8c37', '\u6eaa', '\u7011\u5e03', '\u68ee\u6797', '\u8fb2\u5834'\n        ));\n    }\n    \n    \/**\n     * \u5c71\u5340\u5730\u9ede\u5b9a\u7fa9\uff08\u9ad8\u4fe1\u5fc3\u5ea6\uff09\n     *\/\n    public static function get_mountain_areas() {\n        return array(\n            '\u6b66\u5dba' => 99, \n            '\u5408\u6b61\u5c71' => 98, \n            '\u963f\u91cc\u5c71' => 98, \n            '\u62c9\u62c9\u5c71' => 97, \n            '\u8c37\u95dc' => 96, \n            '\u6e05\u5883\u8fb2\u5834' => 95,\n            '\u6b66\u9675\u8fb2\u5834' => 95, \n            '\u592a\u9b6f\u95a3' => 95\n        );\n    }\n    \n    \/**\n     * \u6392\u9664\u5730\u5340\u5217\u8868\uff08\u9700\u53e6\u884c\u5831\u50f9\uff09\n     *\/\n    public static function get_excluded_areas() {\n        return apply_filters('9o_van_charter_excluded_areas', array(\n            '\u53f8\u99ac\u5eab\u65af', \n            '\u93ae\u897f\u5821', \n            '\u795e\u6728\u7fa4'\n        ));\n    }\n    \n    \/**\n     * \u53f8\u6a5f\u88dc\u8cbc\u8a2d\u5b9a\n     *\/\n    public static function get_driver_subsidy() {\n        return apply_filters('9o_van_charter_driver_subsidy', array(\n            'accommodation' => 2000,  \/\/ \u4f4f\u5bbf\u88dc\u8cbc\/\u665a\n            'meal' => 400            \/\/ \u9910\u8cbb\u88dc\u8cbc\/\u65e5\n        ));\n    }\n    \n    \/**\n     * \u52a0\u8cfc\u9805\u76ee\u50f9\u683c\n     *\/\n    public static function get_addon_prices() {\n        return apply_filters('9o_van_charter_addon_prices', array(\n            'child_seat' => 100,     \/\/ \u5b30\u5152\u5ea7\u6905\/\u5f35\/\u65e5\n            'booster_seat' => 100    \/\/ \u589e\u9ad8\u588a\/\u5f35\/\u65e5\n        ));\n    }\n    \n    \/**\n     * \u53d6\u5f97\u8a2d\u5b9a\u503c\n     *\/\n    public static function get_setting($key, $default = null) {\n        $settings = get_option('9o_van_charter_settings', array());\n        return isset($settings[$key]) ? $settings[$key] : $default;\n    }\n    \n    \/**\n     * \u66f4\u65b0\u8a2d\u5b9a\u503c\n     *\/\n    public static function update_setting($key, $value) {\n        $settings = get_option('9o_van_charter_settings', array());\n        $settings[$key] = $value;\n        return update_option('9o_van_charter_settings', $settings);\n    }\n    \n    \/**\n     * \u53d6\u5f97\u6240\u6709\u8a2d\u5b9a\n     *\/\n    public static function get_all_settings() {\n        return array(\n            'base_rates' => self::get_base_rates(),\n            'south_14k_cities' => self::get_south_14k_cities(),\n            'mountain_keywords' => self::get_mountain_keywords(),\n            'mountain_areas' => self::get_mountain_areas(),\n            'excluded_areas' => self::get_excluded_areas(),\n            'driver_subsidy' => self::get_driver_subsidy(),\n            'addon_prices' => self::get_addon_prices(),\n            'max_days' => _9O_VAN_CHARTER_MAX_DAYS,\n            'max_stops_per_day' => _9O_VAN_CHARTER_MAX_STOPS_PER_DAY,\n            'mountain_elevation' => _9O_VAN_CHARTER_MOUNTAIN_ELEVATION,\n            'min_booking_days' => _9O_VAN_CHARTER_MIN_BOOKING_DAYS,\n            'google_maps_api_key' => GOOGLE_MAPS_API_KEY\n        );\n    }\n    \n    \/**\n     * \u65b0\u589e\u8a2d\u5b9a\u9801\u9762\n     *\/\n    public function add_settings_page() {\n        add_submenu_page(\n            '9o-van-dashboard',\n            '\u5305\u8eca\u65c5\u904a\u8a2d\u5b9a',\n            '\u5305\u8eca\u65c5\u904a\u8a2d\u5b9a',\n            'manage_options',\n            '9o-van-charter-settings',\n            array($this, 'render_settings_page')\n        );\n    }\n    \n    \/**\n     * \u8a3b\u518a\u8a2d\u5b9a\n     *\/\n    public function register_settings() {\n        register_setting(\n            '9o_van_charter_settings_group',\n            '9o_van_charter_settings',\n            array($this, 'sanitize_settings')\n        );\n    }\n    \n    \/**\n     * \u6e05\u7406\u8a2d\u5b9a\u503c\n     *\/\n    public function sanitize_settings($input) {\n        $sanitized = array();\n        \n        \/\/ \u50f9\u683c\u8a2d\u5b9a\n        if (isset($input['base_rate_north'])) {\n            $sanitized['base_rate_north'] = intval($input['base_rate_north']);\n        }\n        if (isset($input['base_rate_south'])) {\n            $sanitized['base_rate_south'] = intval($input['base_rate_south']);\n        }\n        if (isset($input['daily_discount'])) {\n            $sanitized['daily_discount'] = intval($input['daily_discount']);\n        }\n        \n        \/\/ \u53f8\u6a5f\u88dc\u8cbc\n        if (isset($input['driver_accommodation'])) {\n            $sanitized['driver_accommodation'] = intval($input['driver_accommodation']);\n        }\n        if (isset($input['driver_meal'])) {\n            $sanitized['driver_meal'] = intval($input['driver_meal']);\n        }\n        \n        \/\/ \u52a0\u8cfc\u9805\u76ee\n        if (isset($input['child_seat_price'])) {\n            $sanitized['child_seat_price'] = intval($input['child_seat_price']);\n        }\n        if (isset($input['booster_seat_price'])) {\n            $sanitized['booster_seat_price'] = intval($input['booster_seat_price']);\n        }\n        \n        return $sanitized;\n    }\n    \n    \/**\n     * \u6e32\u67d3\u8a2d\u5b9a\u9801\u9762\n     *\/\n    public function render_settings_page() {\n        $settings = self::get_all_settings();\n        ?>\n        <div class=\"wrap\">\n            <h1>\u5305\u8eca\u65c5\u904a\u8a2d\u5b9a<\/h1>\n            \n            <form method=\"post\" action=\"options.php\">\n                <?php settings_fields('9o_van_charter_settings_group'); ?>\n                \n                <h2>\u57fa\u672c\u50f9\u683c\u8a2d\u5b9a<\/h2>\n                <table class=\"form-table\">\n                    <tr>\n                        <th scope=\"row\">\u5609\u7fa9(\u542b)\u4ee5\u5317\u57fa\u672c\u50f9<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[base_rate_north]\" \n                                   value=\"<?php echo esc_attr($settings['base_rates']['north']); ?>\" \n                                   min=\"0\" step=\"100\" \/> \u5143\/\u65e5\n                        <\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u5609\u7fa9\u4ee5\u5357\/\u82b1\u6771\u57fa\u672c\u50f9<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[base_rate_south]\" \n                                   value=\"<?php echo esc_attr($settings['base_rates']['south']); ?>\" \n                                   min=\"0\" step=\"100\" \/> \u5143\/\u65e5\n                        <\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u591a\u65e5\u6298\u6263<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[daily_discount]\" \n                                   value=\"<?php echo esc_attr($settings['base_rates']['daily_discount']); ?>\" \n                                   min=\"0\" step=\"100\" \/> \u5143\/\u65e5\uff08\u7b2c\u4e8c\u5929\u8d77\uff09\n                        <\/td>\n                    <\/tr>\n                <\/table>\n                \n                <h2>\u5c71\u5340\u8a2d\u5b9a<\/h2>\n                <table class=\"form-table\">\n                    <tr>\n                        <th scope=\"row\">\u5c71\u5340\u6d77\u62d4\u9580\u6abb<\/th>\n                        <td><?php echo esc_html($settings['mountain_elevation']); ?> \u516c\u5c3a<\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u5c71\u5340\u52a0\u50f9<\/th>\n                        <td>1,000 \u5143\/\u65e5<\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u6392\u9664\u5730\u5340<\/th>\n                        <td><?php echo implode('\u3001', $settings['excluded_areas']); ?><\/td>\n                    <\/tr>\n                <\/table>\n                \n                <h2>\u53f8\u6a5f\u88dc\u8cbc<\/h2>\n                <table class=\"form-table\">\n                    <tr>\n                        <th scope=\"row\">\u4f4f\u5bbf\u88dc\u8cbc<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[driver_accommodation]\" \n                                   value=\"<?php echo esc_attr($settings['driver_subsidy']['accommodation']); ?>\" \n                                   min=\"0\" step=\"100\" \/> \u5143\/\u665a\n                        <\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u9910\u8cbb\u88dc\u8cbc<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[driver_meal]\" \n                                   value=\"<?php echo esc_attr($settings['driver_subsidy']['meal']); ?>\" \n                                   min=\"0\" step=\"50\" \/> \u5143\/\u65e5\n                        <\/td>\n                    <\/tr>\n                <\/table>\n                \n                <h2>\u52a0\u8cfc\u9805\u76ee<\/h2>\n                <table class=\"form-table\">\n                    <tr>\n                        <th scope=\"row\">\u5b30\u5152\u5ea7\u6905<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[child_seat_price]\" \n                                   value=\"<?php echo esc_attr($settings['addon_prices']['child_seat']); ?>\" \n                                   min=\"0\" step=\"10\" \/> \u5143\/\u5f35\/\u65e5\n                        <\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u589e\u9ad8\u588a<\/th>\n                        <td>\n                            <input type=\"number\" name=\"9o_van_charter_settings[booster_seat_price]\" \n                                   value=\"<?php echo esc_attr($settings['addon_prices']['booster_seat']); ?>\" \n                                   min=\"0\" step=\"10\" \/> \u5143\/\u5f35\/\u65e5\n                        <\/td>\n                    <\/tr>\n                <\/table>\n                \n                <h2>\u7cfb\u7d71\u9650\u5236<\/h2>\n                <table class=\"form-table\">\n                    <tr>\n                        <th scope=\"row\">\u6700\u5927\u5929\u6578<\/th>\n                        <td><?php echo esc_html($settings['max_days']); ?> \u5929<\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u6bcf\u65e5\u6700\u5927\u505c\u9760\u9ede<\/th>\n                        <td><?php echo esc_html($settings['max_stops_per_day']); ?> \u500b<\/td>\n                    <\/tr>\n                    <tr>\n                        <th scope=\"row\">\u6700\u5c0f\u9810\u7d04\u63d0\u524d\u5929\u6578<\/th>\n                        <td><?php echo esc_html($settings['min_booking_days']); ?> \u5929<\/td>\n                    <\/tr>\n                <\/table>\n                \n                <?php submit_button('\u5132\u5b58\u8a2d\u5b9a'); ?>\n            <\/form>\n        <\/div>\n        <?php\n    }\n    \n    \/**\n     * AJAX: \u5132\u5b58\u8a2d\u5b9a\n     *\/\n    public function ajax_save_settings() {\n        \/\/ \u6aa2\u67e5\u6b0a\u9650\n        if (!current_user_can('manage_options')) {\n            wp_send_json_error('\u6b0a\u9650\u4e0d\u8db3');\n        }\n        \n        \/\/ \u6aa2\u67e5 nonce\n        if (!wp_verify_nonce($_POST['nonce'], '9o_van_charter_settings')) {\n            wp_send_json_error('\u5b89\u5168\u9a57\u8b49\u5931\u6557');\n        }\n        \n        \/\/ \u8655\u7406\u8a2d\u5b9a\u5132\u5b58\n        $settings = isset($_POST['settings']) ? $_POST['settings'] : array();\n        \n        foreach ($settings as $key => $value) {\n            self::update_setting($key, $value);\n        }\n        \n        wp_send_json_success('\u8a2d\u5b9a\u5df2\u5132\u5b58');\n    }\n    \n    \/**\n     * AJAX: \u91cd\u7f6e\u8a2d\u5b9a\n     *\/\n    public function ajax_reset_settings() {\n        \/\/ \u6aa2\u67e5\u6b0a\u9650\n        if (!current_user_can('manage_options')) {\n            wp_send_json_error('\u6b0a\u9650\u4e0d\u8db3');\n        }\n        \n        \/\/ \u522a\u9664\u8a2d\u5b9a\n        delete_option('9o_van_charter_settings');\n        \n        wp_send_json_success('\u8a2d\u5b9a\u5df2\u91cd\u7f6e');\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\nNineOVan_Charter_Settings::get_instance();\n\n\/**\n * \u5168\u57df\u8f14\u52a9\u51fd\u5f0f\n *\/\n\n\/\/ \u53d6\u5f97\u5305\u8eca\u57fa\u672c\u8cbb\u7387\nif (!function_exists('_9o_van_get_charter_base_rate')) {\n    function _9o_van_get_charter_base_rate($region = 'north') {\n        $rates = NineOVan_Charter_Settings::get_base_rates();\n        return isset($rates[$region]) ? $rates[$region] : $rates['north'];\n    }\n}\n\n\/\/ \u6aa2\u67e5\u662f\u5426\u70ba\u5357\u90e8\u5730\u5340\nif (!function_exists('_9o_van_is_south_region')) {\n    function _9o_van_is_south_region($address) {\n        $south_cities = NineOVan_Charter_Settings::get_south_14k_cities();\n        foreach ($south_cities as $city) {\n            if (mb_strpos($address, $city) !== false) {\n                return true;\n            }\n        }\n        return false;\n    }\n}\n\n\/\/ \u6aa2\u67e5\u662f\u5426\u70ba\u5c71\u5340\nif (!function_exists('_9o_van_is_mountain_area')) {\n    function _9o_van_is_mountain_area($address) {\n        \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n        $excluded = NineOVan_Charter_Settings::get_excluded_areas();\n        foreach ($excluded as $area) {\n            if (mb_strpos($address, $area) !== false) {\n                return 'excluded';\n            }\n        }\n        \n        \/\/ \u6aa2\u67e5\u5df2\u77e5\u5c71\u5340\n        $mountain_areas = NineOVan_Charter_Settings::get_mountain_areas();\n        foreach ($mountain_areas as $area => $confidence) {\n            if (mb_strpos($address, $area) !== false) {\n                return true;\n            }\n        }\n        \n        \/\/ \u6aa2\u67e5\u5c71\u5340\u95dc\u9375\u5b57\n        $keywords = NineOVan_Charter_Settings::get_mountain_keywords();\n        foreach ($keywords as $keyword) {\n            if (mb_strpos($address, $keyword) !== false) {\n                return 'maybe'; \/\/ \u9700\u8981\u9032\u4e00\u6b65\u78ba\u8a8d\n            }\n        }\n        \n        return false;\n    }\n}\n\n\/\/ \u8a18\u9304\u6a21\u7d44\u8f09\u5165\nif (defined('_9O_VAN_DEBUG') && _9O_VAN_DEBUG) {\n    error_log('[20-Charter-Settings] \u6a21\u7d44\u5df2\u8f09\u5165 - v1.0.0');\n}","active":true,"priority":20,"modified":"2025-09-14 02:50:02","revision":"1"}]}