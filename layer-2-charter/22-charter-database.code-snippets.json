{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":97,"name":"22-Charter-Database","code":"\/**\n * ============================================================================\n * Snippet: 22-Charter-Database\n * Title: \u5305\u8eca\u8cc7\u6599\u5eab\u64cd\u4f5c\n * Description: \u8655\u7406\u5305\u8eca\u9810\u7d04\u7684\u8cc7\u6599\u5eab CRUD \u64cd\u4f5c\u8207\u67e5\u8a62\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 22\n * Dependencies: 01-Database-Schema, 20-Charter-Settings\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ \u6aa2\u67e5\u4f9d\u8cf4\nif (!function_exists('_9o_van_table')) {\n    error_log('[22-Charter-Database] \u932f\u8aa4\uff1a\u7f3a\u5c11\u8cc7\u6599\u5eab\u67b6\u69cb\u51fd\u5f0f');\n    return;\n}\n\n\/**\n * \u5305\u8eca\u8cc7\u6599\u5eab\u64cd\u4f5c\u985e\u5225\n *\/\nclass NineOVan_Charter_Database {\n    \n    private static $instance = null;\n    private $table_name;\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        global $wpdb;\n        $this->table_name = $wpdb->prefix . '9o_van_bookings';\n    }\n    \n    \/**\n     * \u5efa\u7acb\u5305\u8eca\u9810\u7d04\n     *\/\n    public function create_booking($data) {\n        global $wpdb;\n        \n        try {\n            \/\/ \u751f\u6210\u9810\u7d04\u7de8\u865f\n            $booking_number = $this->generate_booking_number();\n            \n            \/\/ \u6e96\u5099\u8cc7\u6599\n            $insert_data = array(\n                'booking_number' => $booking_number,\n                'service_type' => 'charter',\n                'status' => 'pending',\n                'customer_name' => $data['customer_name'],\n                'customer_phone' => $data['customer_phone'],\n                'customer_email' => $data['customer_email'] ?? '',\n                'service_date' => $data['start_date'],\n                'service_time' => $data['start_time'],\n                'service_data' => json_encode(array(\n                    'trip_days' => $data['trip_days'],\n                    'end_date' => $data['end_date'],\n                    'passengers' => $data['passengers'],\n                    'daily_routes' => $data['daily_routes'],\n                    'driver_accommodation' => $data['driver_accommodation'],\n                    'driver_meals' => $data['driver_meals'],\n                    'child_seats' => $data['child_seats'] ?? 0,\n                    'booster_seats' => $data['booster_seats'] ?? 0,\n                    'mountain_detection' => $data['mountain_detection'] ?? null\n                ), JSON_UNESCAPED_UNICODE),\n                'price_data' => json_encode($data['price_breakdown'] ?? array(), JSON_UNESCAPED_UNICODE),\n                'total_amount' => $data['total_price'],\n                'deposit_amount' => $data['deposit'] ?? 0,\n                'payment_status' => 'unpaid',\n                'notes' => $data['notes'] ?? '',\n                'created_at' => current_time('mysql'),\n                'created_by' => get_current_user_id() ?: 0\n            );\n            \n            \/\/ \u63d2\u5165\u8cc7\u6599\n            $result = $wpdb->insert(\n                $this->table_name,\n                $insert_data,\n                array(\n                    '%s', \/\/ booking_number\n                    '%s', \/\/ service_type\n                    '%s', \/\/ status\n                    '%s', \/\/ customer_name\n                    '%s', \/\/ customer_phone\n                    '%s', \/\/ customer_email\n                    '%s', \/\/ service_date\n                    '%s', \/\/ service_time\n                    '%s', \/\/ service_data\n                    '%s', \/\/ price_data\n                    '%f', \/\/ total_amount\n                    '%f', \/\/ deposit_amount\n                    '%s', \/\/ payment_status\n                    '%s', \/\/ notes\n                    '%s', \/\/ created_at\n                    '%d'  \/\/ created_by\n                )\n            );\n            \n            if ($result === false) {\n                throw new Exception('\u8cc7\u6599\u5eab\u63d2\u5165\u5931\u6557: ' . $wpdb->last_error);\n            }\n            \n            $booking_id = $wpdb->insert_id;\n            \n            \/\/ \u8a18\u9304\u6d3b\u52d5\n            $this->log_activity($booking_id, 'created', '\u5efa\u7acb\u65b0\u9810\u7d04');\n            \n            \/\/ \u89f8\u767c\u9264\u5b50\n            do_action('9o_van_charter_booking_created', $booking_id, $data);\n            \n            return array(\n                'success' => true,\n                'booking_id' => $booking_id,\n                'booking_number' => $booking_number\n            );\n            \n        } catch (Exception $e) {\n            error_log('[22-Charter-Database] \u5efa\u7acb\u9810\u7d04\u5931\u6557: ' . $e->getMessage());\n            return array(\n                'success' => false,\n                'error' => $e->getMessage()\n            );\n        }\n    }\n    \n    \/**\n     * \u53d6\u5f97\u5305\u8eca\u9810\u7d04\n     *\/\n    public function get_booking($booking_id) {\n        global $wpdb;\n        \n        $query = $wpdb->prepare(\n            \"SELECT * FROM {$this->table_name} WHERE id = %d AND service_type = 'charter'\",\n            $booking_id\n        );\n        \n        $booking = $wpdb->get_row($query, ARRAY_A);\n        \n        if ($booking) {\n            \/\/ \u89e3\u6790 JSON \u6b04\u4f4d\n            $booking['service_data'] = json_decode($booking['service_data'], true);\n            $booking['price_data'] = json_decode($booking['price_data'], true);\n            \n            \/\/ \u53d6\u5f97\u76f8\u95dc\u8cc7\u6599\n            $booking['activities'] = $this->get_booking_activities($booking_id);\n            $booking['payments'] = $this->get_booking_payments($booking_id);\n        }\n        \n        return $booking;\n    }\n    \n    \/**\n     * \u900f\u904e\u9810\u7d04\u7de8\u865f\u53d6\u5f97\n     *\/\n    public function get_booking_by_number($booking_number) {\n        global $wpdb;\n        \n        $query = $wpdb->prepare(\n            \"SELECT * FROM {$this->table_name} WHERE booking_number = %s\",\n            $booking_number\n        );\n        \n        $booking = $wpdb->get_row($query, ARRAY_A);\n        \n        if ($booking) {\n            $booking['service_data'] = json_decode($booking['service_data'], true);\n            $booking['price_data'] = json_decode($booking['price_data'], true);\n        }\n        \n        return $booking;\n    }\n    \n    \/**\n     * \u66f4\u65b0\u5305\u8eca\u9810\u7d04\n     *\/\n    public function update_booking($booking_id, $data) {\n        global $wpdb;\n        \n        try {\n            \/\/ \u53d6\u5f97\u73fe\u6709\u8cc7\u6599\n            $existing = $this->get_booking($booking_id);\n            if (!$existing) {\n                throw new Exception('\u9810\u7d04\u4e0d\u5b58\u5728');\n            }\n            \n            \/\/ \u6e96\u5099\u66f4\u65b0\u8cc7\u6599\n            $update_data = array();\n            $update_format = array();\n            \n            \/\/ \u53ef\u66f4\u65b0\u6b04\u4f4d\n            $updatable_fields = array(\n                'status' => '%s',\n                'customer_name' => '%s',\n                'customer_phone' => '%s',\n                'customer_email' => '%s',\n                'service_date' => '%s',\n                'service_time' => '%s',\n                'total_amount' => '%f',\n                'deposit_amount' => '%f',\n                'payment_status' => '%s',\n                'notes' => '%s'\n            );\n            \n            foreach ($updatable_fields as $field => $format) {\n                if (isset($data[$field])) {\n                    $update_data[$field] = $data[$field];\n                    $update_format[] = $format;\n                }\n            }\n            \n            \/\/ \u66f4\u65b0 service_data\n            if (isset($data['service_data'])) {\n                $update_data['service_data'] = json_encode($data['service_data'], JSON_UNESCAPED_UNICODE);\n                $update_format[] = '%s';\n            }\n            \n            \/\/ \u66f4\u65b0 price_data\n            if (isset($data['price_data'])) {\n                $update_data['price_data'] = json_encode($data['price_data'], JSON_UNESCAPED_UNICODE);\n                $update_format[] = '%s';\n            }\n            \n            \/\/ \u52a0\u5165\u66f4\u65b0\u6642\u9593\n            $update_data['updated_at'] = current_time('mysql');\n            $update_format[] = '%s';\n            \n            \/\/ \u57f7\u884c\u66f4\u65b0\n            $result = $wpdb->update(\n                $this->table_name,\n                $update_data,\n                array('id' => $booking_id),\n                $update_format,\n                array('%d')\n            );\n            \n            if ($result === false) {\n                throw new Exception('\u8cc7\u6599\u5eab\u66f4\u65b0\u5931\u6557: ' . $wpdb->last_error);\n            }\n            \n            \/\/ \u8a18\u9304\u6d3b\u52d5\n            $changes = array_diff_assoc($update_data, $existing);\n            if (!empty($changes)) {\n                $this->log_activity($booking_id, 'updated', '\u66f4\u65b0\u9810\u7d04\u8cc7\u6599', json_encode($changes));\n            }\n            \n            \/\/ \u89f8\u767c\u9264\u5b50\n            do_action('9o_van_charter_booking_updated', $booking_id, $data, $existing);\n            \n            return array(\n                'success' => true,\n                'booking_id' => $booking_id\n            );\n            \n        } catch (Exception $e) {\n            error_log('[22-Charter-Database] \u66f4\u65b0\u9810\u7d04\u5931\u6557: ' . $e->getMessage());\n            return array(\n                'success' => false,\n                'error' => $e->getMessage()\n            );\n        }\n    }\n    \n    \/**\n     * \u522a\u9664\u5305\u8eca\u9810\u7d04\n     *\/\n    public function delete_booking($booking_id) {\n        global $wpdb;\n        \n        try {\n            \/\/ \u6aa2\u67e5\u9810\u7d04\u662f\u5426\u5b58\u5728\n            $booking = $this->get_booking($booking_id);\n            if (!$booking) {\n                throw new Exception('\u9810\u7d04\u4e0d\u5b58\u5728');\n            }\n            \n            \/\/ \u8edf\u522a\u9664\uff08\u6a19\u8a18\u70ba\u5df2\u522a\u9664\uff09\n            $result = $wpdb->update(\n                $this->table_name,\n                array(\n                    'status' => 'deleted',\n                    'deleted_at' => current_time('mysql')\n                ),\n                array('id' => $booking_id),\n                array('%s', '%s'),\n                array('%d')\n            );\n            \n            if ($result === false) {\n                throw new Exception('\u8cc7\u6599\u5eab\u522a\u9664\u5931\u6557');\n            }\n            \n            \/\/ \u8a18\u9304\u6d3b\u52d5\n            $this->log_activity($booking_id, 'deleted', '\u522a\u9664\u9810\u7d04');\n            \n            \/\/ \u89f8\u767c\u9264\u5b50\n            do_action('9o_van_charter_booking_deleted', $booking_id, $booking);\n            \n            return array(\n                'success' => true,\n                'booking_id' => $booking_id\n            );\n            \n        } catch (Exception $e) {\n            error_log('[22-Charter-Database] \u522a\u9664\u9810\u7d04\u5931\u6557: ' . $e->getMessage());\n            return array(\n                'success' => false,\n                'error' => $e->getMessage()\n            );\n        }\n    }\n    \n    \/**\n     * \u67e5\u8a62\u5305\u8eca\u9810\u7d04\u5217\u8868\n     *\/\n    public function get_bookings($args = array()) {\n        global $wpdb;\n        \n        \/\/ \u9810\u8a2d\u53c3\u6578\n        $defaults = array(\n            'status' => '',\n            'payment_status' => '',\n            'customer_name' => '',\n            'customer_phone' => '',\n            'date_from' => '',\n            'date_to' => '',\n            'orderby' => 'created_at',\n            'order' => 'DESC',\n            'limit' => 20,\n            'offset' => 0\n        );\n        \n        $args = wp_parse_args($args, $defaults);\n        \n        \/\/ \u5efa\u7acb\u67e5\u8a62\n        $where = array(\"service_type = 'charter'\");\n        $where_values = array();\n        \n        if (!empty($args['status'])) {\n            $where[] = \"status = %s\";\n            $where_values[] = $args['status'];\n        }\n        \n        if (!empty($args['payment_status'])) {\n            $where[] = \"payment_status = %s\";\n            $where_values[] = $args['payment_status'];\n        }\n        \n        if (!empty($args['customer_name'])) {\n            $where[] = \"customer_name LIKE %s\";\n            $where_values[] = '%' . $wpdb->esc_like($args['customer_name']) . '%';\n        }\n        \n        if (!empty($args['customer_phone'])) {\n            $where[] = \"customer_phone LIKE %s\";\n            $where_values[] = '%' . $wpdb->esc_like($args['customer_phone']) . '%';\n        }\n        \n        if (!empty($args['date_from'])) {\n            $where[] = \"service_date >= %s\";\n            $where_values[] = $args['date_from'];\n        }\n        \n        if (!empty($args['date_to'])) {\n            $where[] = \"service_date <= %s\";\n            $where_values[] = $args['date_to'];\n        }\n        \n        \/\/ \u7d44\u5408\u67e5\u8a62\n        $where_clause = implode(' AND ', $where);\n        \n        \/\/ \u8a08\u7b97\u7e3d\u6578\n        $count_query = \"SELECT COUNT(*) FROM {$this->table_name} WHERE {$where_clause}\";\n        if (!empty($where_values)) {\n            $count_query = $wpdb->prepare($count_query, $where_values);\n        }\n        $total = $wpdb->get_var($count_query);\n        \n        \/\/ \u67e5\u8a62\u8cc7\u6599\n        $query = \"SELECT * FROM {$this->table_name} \n                 WHERE {$where_clause} \n                 ORDER BY {$args['orderby']} {$args['order']} \n                 LIMIT %d OFFSET %d\";\n        \n        $query_values = array_merge($where_values, array($args['limit'], $args['offset']));\n        $query = $wpdb->prepare($query, $query_values);\n        \n        $bookings = $wpdb->get_results($query, ARRAY_A);\n        \n        \/\/ \u89e3\u6790 JSON \u6b04\u4f4d\n        foreach ($bookings as &$booking) {\n            $booking['service_data'] = json_decode($booking['service_data'], true);\n            $booking['price_data'] = json_decode($booking['price_data'], true);\n        }\n        \n        return array(\n            'bookings' => $bookings,\n            'total' => $total,\n            'page' => ($args['offset'] \/ $args['limit']) + 1,\n            'total_pages' => ceil($total \/ $args['limit'])\n        );\n    }\n    \n    \/**\n     * \u53d6\u5f97\u7d71\u8a08\u8cc7\u6599\n     *\/\n    public function get_statistics($date_from = null, $date_to = null) {\n        global $wpdb;\n        \n        $where = \"service_type = 'charter'\";\n        $where_values = array();\n        \n        if ($date_from) {\n            $where .= \" AND service_date >= %s\";\n            $where_values[] = $date_from;\n        }\n        \n        if ($date_to) {\n            $where .= \" AND service_date <= %s\";\n            $where_values[] = $date_to;\n        }\n        \n        \/\/ \u7e3d\u9810\u7d04\u6578\n        $total_query = \"SELECT COUNT(*) FROM {$this->table_name} WHERE {$where}\";\n        if (!empty($where_values)) {\n            $total_query = $wpdb->prepare($total_query, $where_values);\n        }\n        $total_bookings = $wpdb->get_var($total_query);\n        \n        \/\/ \u7e3d\u6536\u5165\n        $revenue_query = \"SELECT SUM(total_amount) FROM {$this->table_name} \n                         WHERE {$where} AND payment_status IN ('paid', 'deposit_paid')\";\n        if (!empty($where_values)) {\n            $revenue_query = $wpdb->prepare($revenue_query, $where_values);\n        }\n        $total_revenue = $wpdb->get_var($revenue_query) ?: 0;\n        \n        \/\/ \u72c0\u614b\u7d71\u8a08\n        $status_query = \"SELECT status, COUNT(*) as count \n                        FROM {$this->table_name} \n                        WHERE {$where} \n                        GROUP BY status\";\n        if (!empty($where_values)) {\n            $status_query = $wpdb->prepare($status_query, $where_values);\n        }\n        $status_stats = $wpdb->get_results($status_query, ARRAY_A);\n        \n        \/\/ \u6bcf\u65e5\u5e73\u5747\n        $days_query = \"SELECT DATEDIFF(MAX(service_date), MIN(service_date)) + 1 \n                      FROM {$this->table_name} WHERE {$where}\";\n        if (!empty($where_values)) {\n            $days_query = $wpdb->prepare($days_query, $where_values);\n        }\n        $total_days = $wpdb->get_var($days_query) ?: 1;\n        \n        return array(\n            'total_bookings' => $total_bookings,\n            'total_revenue' => $total_revenue,\n            'average_per_day' => $total_bookings \/ $total_days,\n            'average_revenue_per_day' => $total_revenue \/ $total_days,\n            'status_breakdown' => $status_stats\n        );\n    }\n    \n    \/**\n     * \u6aa2\u67e5\u885d\u7a81\n     *\/\n    public function check_conflicts($date, $trip_days = 1) {\n        global $wpdb;\n        \n        $end_date = date('Y-m-d', strtotime($date . ' + ' . ($trip_days - 1) . ' days'));\n        \n        $query = $wpdb->prepare(\n            \"SELECT * FROM {$this->table_name} \n             WHERE service_type = 'charter' \n             AND status IN ('confirmed', 'in_service')\n             AND (\n                 (service_date <= %s AND JSON_EXTRACT(service_data, '$.end_date') >= %s)\n                 OR (service_date <= %s AND JSON_EXTRACT(service_data, '$.end_date') >= %s)\n             )\",\n            $date, $date,\n            $end_date, $end_date\n        );\n        \n        $conflicts = $wpdb->get_results($query, ARRAY_A);\n        \n        return !empty($conflicts) ? $conflicts : false;\n    }\n    \n    \/**\n     * \u751f\u6210\u9810\u7d04\u7de8\u865f\n     *\/\n    private function generate_booking_number() {\n        global $wpdb;\n        \n        $prefix = 'CHT';\n        $date = date('ymd');\n        \n        \/\/ \u53d6\u5f97\u4eca\u65e5\u6700\u5f8c\u7de8\u865f\n        $query = $wpdb->prepare(\n            \"SELECT booking_number FROM {$this->table_name} \n             WHERE booking_number LIKE %s \n             ORDER BY id DESC LIMIT 1\",\n            $prefix . $date . '%'\n        );\n        \n        $last_number = $wpdb->get_var($query);\n        \n        if ($last_number) {\n            $sequence = intval(substr($last_number, -4)) + 1;\n        } else {\n            $sequence = 1;\n        }\n        \n        return $prefix . $date . str_pad($sequence, 4, '0', STR_PAD_LEFT);\n    }\n    \n    \/**\n     * \u8a18\u9304\u6d3b\u52d5\n     *\/\n    private function log_activity($booking_id, $action, $description, $data = null) {\n        global $wpdb;\n        \n        $table = $wpdb->prefix . '9o_van_activities';\n        \n        return $wpdb->insert(\n            $table,\n            array(\n                'booking_id' => $booking_id,\n                'action' => $action,\n                'description' => $description,\n                'data' => $data,\n                'user_id' => get_current_user_id(),\n                'created_at' => current_time('mysql')\n            ),\n            array('%d', '%s', '%s', '%s', '%d', '%s')\n        );\n    }\n    \n    \/**\n     * \u53d6\u5f97\u9810\u7d04\u6d3b\u52d5\u8a18\u9304\n     *\/\n    private function get_booking_activities($booking_id) {\n        global $wpdb;\n        \n        $table = $wpdb->prefix . '9o_van_activities';\n        \n        return $wpdb->get_results(\n            $wpdb->prepare(\n                \"SELECT * FROM {$table} WHERE booking_id = %d ORDER BY created_at DESC\",\n                $booking_id\n            ),\n            ARRAY_A\n        );\n    }\n    \n    \/**\n     * \u53d6\u5f97\u4ed8\u6b3e\u8a18\u9304\n     *\/\n    private function get_booking_payments($booking_id) {\n        global $wpdb;\n        \n        $table = $wpdb->prefix . '9o_van_payments';\n        \n        return $wpdb->get_results(\n            $wpdb->prepare(\n                \"SELECT * FROM {$table} WHERE booking_id = %d ORDER BY created_at DESC\",\n                $booking_id\n            ),\n            ARRAY_A\n        );\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\n$GLOBALS['9o_van_charter_db'] = NineOVan_Charter_Database::get_instance();\n\n\/**\n * \u5168\u57df\u8f14\u52a9\u51fd\u5f0f\n *\/\n\n\/\/ \u5efa\u7acb\u5305\u8eca\u9810\u7d04\nif (!function_exists('_9o_van_db_create_charter_booking')) {\n    function _9o_van_db_create_charter_booking($data) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->create_booking($data);\n    }\n}\n\n\/\/ \u53d6\u5f97\u5305\u8eca\u9810\u7d04\nif (!function_exists('_9o_van_db_get_charter_booking')) {\n    function _9o_van_db_get_charter_booking($booking_id) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->get_booking($booking_id);\n    }\n}\n\n\/\/ \u66f4\u65b0\u5305\u8eca\u9810\u7d04\nif (!function_exists('_9o_van_db_update_charter_booking')) {\n    function _9o_van_db_update_charter_booking($booking_id, $data) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->update_booking($booking_id, $data);\n    }\n}\n\n\/\/ \u67e5\u8a62\u5305\u8eca\u9810\u7d04\nif (!function_exists('_9o_van_db_get_charter_bookings')) {\n    function _9o_van_db_get_charter_bookings($args = array()) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->get_bookings($args);\n    }\n}\n\n\/\/ \u53d6\u5f97\u7d71\u8a08\u8cc7\u6599\nif (!function_exists('_9o_van_db_get_charter_statistics')) {\n    function _9o_van_db_get_charter_statistics($date_from = null, $date_to = null) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->get_statistics($date_from, $date_to);\n    }\n}\n\n\/\/ \u6aa2\u67e5\u885d\u7a81\nif (!function_exists('_9o_van_check_charter_conflict')) {\n    function _9o_van_check_charter_conflict($date, $trip_days = 1) {\n        global $GLOBALS;\n        return $GLOBALS['9o_van_charter_db']->check_conflicts($date, $trip_days);\n    }\n}\n\n\/\/ \u8a18\u9304\u6a21\u7d44\u8f09\u5165\nif (defined('_9O_VAN_DEBUG') && _9O_VAN_DEBUG) {\n    error_log('[22-Charter-Database] \u6a21\u7d44\u5df2\u8f09\u5165 - v1.0.0');\n}","active":true,"priority":22,"modified":"2025-09-14 02:52:15","revision":"1"}]}