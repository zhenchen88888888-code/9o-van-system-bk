{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":98,"name":"23-Charter-Calculator","code":"\/**\n * ============================================================================\n * Snippet: 23-Charter-Price-Calculator\n * Title: \u5305\u8eca\u50f9\u683c\u8a08\u7b97\u7cfb\u7d71 - \u4fee\u6b63\u7248\n * Description: \u8655\u7406\u5305\u8eca\u670d\u52d9\u7684\u50f9\u683c\u8a08\u7b97\uff0c\u5305\u542b\u57fa\u672c\u8cbb\u3001\u5c71\u5340\u52a0\u50f9\u3001\u53f8\u6a5f\u88dc\u8cbc\u7b49\n * Version: 2.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 23\n * Dependencies: 00-Global-Constants, 02-Google-Maps-Loader, 03-Common-Utilities\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ ====================================\n\/\/ \u50f9\u683c\u8a08\u7b97\u7cfb\u7d71 - \u4fee\u6b63\u7248\n\/\/ ====================================\nadd_action('wp_ajax_calculate_charter_price', 'handle_charter_price_calculation_v2');\nadd_action('wp_ajax_nopriv_calculate_charter_price', 'handle_charter_price_calculation_v2');\n\nfunction handle_charter_price_calculation_v2() {\n    try {\n        \/\/ 1. \u6536\u96c6\u4e26\u9a57\u8b49\u8f38\u5165\u8cc7\u6599\n        $trip_days = isset($_POST['trip_days']) ? intval($_POST['trip_days']) : 1;\n        $trip_days = max(1, min(7, $trip_days)); \/\/ \u9650\u52361-7\u5929\n        \n        $passengers = isset($_POST['passengers']) ? intval($_POST['passengers']) : 1;\n        $passengers = max(1, min(8, $passengers)); \/\/ \u9650\u52361-8\u4eba\n        \n        $child_seats = isset($_POST['child_seats']) ? intval($_POST['child_seats']) : 0;\n        $booster_seats = isset($_POST['booster_seats']) ? intval($_POST['booster_seats']) : 0;\n        \n        \/\/ \u53f8\u6a5f\u5b89\u6392\n        $driver_accommodation = isset($_POST['driver_accommodation']) ? \n            sanitize_text_field($_POST['driver_accommodation']) : 'self';\n        $driver_meals = isset($_POST['driver_meals']) ? \n            sanitize_text_field($_POST['driver_meals']) : 'provided';\n        \n        \/\/ \u89e3\u6790\u6bcf\u65e5\u884c\u7a0b\n        $daily_routes = array();\n        if (!empty($_POST['daily_routes'])) {\n            $decoded = json_decode(stripslashes($_POST['daily_routes']), true);\n            if (is_array($decoded)) {\n                $daily_routes = $decoded;\n            }\n        }\n        \n        \/\/ \u78ba\u4fdd\u8def\u7dda\u6578\u91cf\u8207\u5929\u6578\u76f8\u7b26\n        while (count($daily_routes) < $trip_days) {\n            $daily_routes[] = array('origin' => '', 'destination' => '', 'stops' => array());\n        }\n        \n        \/\/ \u50f9\u683c\u8a08\u7b97\u958b\u59cb\n        $breakdown = array();\n        $subtotal = 0;\n        \n        \/\/ ====================================\n        \/\/ 2. \u57fa\u672c\u8cbb\u7528\u8a08\u7b97\uff08\u542b\u5357\u5317\u5340\u57df\u5224\u5b9a\uff09\n        \/\/ ====================================\n        $base_daily_rate = 12000; \/\/ \u9810\u8a2d\u5317\u90e8\u50f9\u683c\n        $is_south = false;\n        $detected_areas = array();\n        \n        \/\/ \u6aa2\u67e5\u6240\u6709\u8def\u7dda\u9ede\u662f\u5426\u5728\u5357\u90e8\u6216\u82b1\u6771\n        foreach ($daily_routes as $day_index => $route) {\n            \/\/ \u6aa2\u67e5\u8d77\u9ede\n            if (!empty($route['origin'])) {\n                $origin_city = detect_city_from_address($route['origin']);\n                if (is_south_or_east($origin_city)) {\n                    $is_south = true;\n                    $detected_areas[] = $origin_city;\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u7d42\u9ede\n            if (!empty($route['destination'])) {\n                $dest_city = detect_city_from_address($route['destination']);\n                if (is_south_or_east($dest_city)) {\n                    $is_south = true;\n                    $detected_areas[] = $dest_city;\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u505c\u9760\u9ede\n            if (!empty($route['stops']) && is_array($route['stops'])) {\n                foreach ($route['stops'] as $stop) {\n                    if (!empty($stop)) {\n                        $stop_city = detect_city_from_address($stop);\n                        if (is_south_or_east($stop_city)) {\n                            $is_south = true;\n                            $detected_areas[] = $stop_city;\n                        }\n                    }\n                }\n            }\n        }\n        \n        \/\/ \u8a2d\u5b9a\u57fa\u672c\u65e5\u8cbb\u7387\n        if ($is_south) {\n            $base_daily_rate = 14000;\n        }\n        \n        \/\/ \u8a08\u7b97\u591a\u65e5\u512a\u60e0\n        $daily_rates = array();\n        for ($day = 1; $day <= $trip_days; $day++) {\n            if ($day == 1) {\n                $daily_rates[$day] = $base_daily_rate;\n            } else {\n                \/\/ \u7b2c\u4e8c\u5929\u8d77\u6bcf\u65e5\u6e1b1000\n                $daily_rates[$day] = $base_daily_rate - 1000;\n            }\n        }\n        \n        $base_total = array_sum($daily_rates);\n        $breakdown['base_price'] = $base_total;\n        $breakdown['daily_rates'] = $daily_rates;\n        $breakdown['base_daily_rate'] = $base_daily_rate;\n        $breakdown['is_south'] = $is_south;\n        $breakdown['detected_areas'] = array_unique($detected_areas);\n        $subtotal = $base_total;\n        \n        \/\/ ====================================\n        \/\/ 3. \u5c71\u5340\u52a0\u50f9\u5224\u5b9a\uff08\u4fee\u6b63\u7248\uff09\n        \/\/ ====================================\n        $mountain_surcharge = 0;\n        $mountain_days = array();\n        $needs_manual_check = false;\n        \n        foreach ($daily_routes as $day_index => $route) {\n            $day_num = $day_index + 1;\n            \n            \/\/ \u8df3\u904e\u6c92\u6709\u8def\u7dda\u7684\u65e5\u671f\n            if (empty($route['origin']) && empty($route['destination']) && \n                (empty($route['stops']) || !array_filter($route['stops']))) {\n                continue;\n            }\n            \n            $day_is_mountain = false;\n            $day_mountain_info = array(\n                'day' => $day_num,\n                'confidence' => 0,\n                'elevation' => 0,\n                'areas' => array(),\n                'requires_check' => false\n            );\n            \n            \/\/ \u6aa2\u67e5\u8d77\u9ede\n            if (!empty($route['origin'])) {\n                $origin_check = check_mountain_location($route['origin']);\n                if ($origin_check['is_mountain']) {\n                    $day_is_mountain = true;\n                    $day_mountain_info['confidence'] = max($day_mountain_info['confidence'], \n                        $origin_check['confidence']);\n                    $day_mountain_info['elevation'] = max($day_mountain_info['elevation'], \n                        $origin_check['elevation']);\n                    if (!empty($origin_check['area'])) {\n                        $day_mountain_info['areas'][] = $origin_check['area'];\n                    }\n                }\n                \n                \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                if ($origin_check['is_excluded']) {\n                    wp_send_json_error(array(\n                        'message' => $origin_check['excluded_reason'],\n                        'location' => $route['origin']\n                    ));\n                    wp_die();\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u7d42\u9ede\n            if (!empty($route['destination'])) {\n                $dest_check = check_mountain_location($route['destination']);\n                if ($dest_check['is_mountain']) {\n                    $day_is_mountain = true;\n                    $day_mountain_info['confidence'] = max($day_mountain_info['confidence'], \n                        $dest_check['confidence']);\n                    $day_mountain_info['elevation'] = max($day_mountain_info['elevation'], \n                        $dest_check['elevation']);\n                    if (!empty($dest_check['area'])) {\n                        $day_mountain_info['areas'][] = $dest_check['area'];\n                    }\n                }\n                \n                \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                if ($dest_check['is_excluded']) {\n                    wp_send_json_error(array(\n                        'message' => $dest_check['excluded_reason'],\n                        'location' => $route['destination']\n                    ));\n                    wp_die();\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u505c\u9760\u9ede\uff08\u4fee\u6b63\u7248\uff09\n            if (!empty($route['stops']) && is_array($route['stops'])) {\n                foreach ($route['stops'] as $stop_index => $stop) {\n                    \/\/ \u78ba\u4fdd\u505c\u9760\u9ede\u4e0d\u70ba\u7a7a\n                    if (empty($stop) || !is_string($stop) || trim($stop) === '') {\n                        continue;\n                    }\n                    \n                    $stop_check = check_mountain_location($stop);\n                    \n                    if ($stop_check['is_mountain']) {\n                        $day_is_mountain = true;\n                        $day_mountain_info['confidence'] = max($day_mountain_info['confidence'], \n                            $stop_check['confidence']);\n                        $day_mountain_info['elevation'] = max($day_mountain_info['elevation'], \n                            $stop_check['elevation']);\n                        if (!empty($stop_check['area'])) {\n                            $day_mountain_info['areas'][] = \"\u505c\u9760\u9ede\" . ($stop_index + 1) . \": \" . $stop_check['area'];\n                        }\n                    }\n                    \n                    \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                    if ($stop_check['is_excluded']) {\n                        wp_send_json_error(array(\n                            'message' => $stop_check['excluded_reason'],\n                            'location' => $stop\n                        ));\n                        wp_die();\n                    }\n                }\n            }\n            \n            \/\/ \u5224\u5b9a\u662f\u5426\u6536\u53d6\u5c71\u5340\u52a0\u50f9\n            if ($day_is_mountain) {\n                \/\/ \u6d77\u62d4\u8d85\u904e500\u516c\u5c3a\u6216\u4fe1\u5fc3\u5ea6\u8d85\u904e90\uff0c\u78ba\u5b9a\u6536\u53d6\u5c71\u5340\u52a0\u50f9\n                if ($day_mountain_info['elevation'] >= 500 || $day_mountain_info['confidence'] >= 90) {\n                    $mountain_surcharge += 1000;\n                    $mountain_days[] = $day_mountain_info;\n                }\n                \/\/ \u9700\u8981\u4eba\u5de5\u78ba\u8a8d\u7684\u60c5\u6cc1\n                else if ($day_mountain_info['confidence'] >= 60) {\n                    $day_mountain_info['requires_check'] = true;\n                    $needs_manual_check = true;\n                    $mountain_days[] = $day_mountain_info;\n                }\n            }\n        }\n        \n        \/\/ \u52a0\u5165\u5c71\u5340\u52a0\u50f9\u5230\u660e\u7d30\n        if ($mountain_surcharge > 0 || $needs_manual_check) {\n            $breakdown['mountain_surcharge'] = $mountain_surcharge;\n            $breakdown['mountain_days'] = $mountain_days;\n            $breakdown['mountain_needs_check'] = $needs_manual_check;\n            $subtotal += $mountain_surcharge;\n        }\n        \n        \/\/ ====================================\n        \/\/ 4. \u53f8\u6a5f\u88dc\u8cbc\u8a08\u7b97\n        \/\/ ====================================\n        $driver_allowance = 0;\n        \n        \/\/ \u4f4f\u5bbf\u88dc\u8cbc\uff08\u5929\u6578-1\u665a\uff09\n        if ($driver_accommodation === 'book' && $trip_days > 1) {\n            $nights = $trip_days - 1;\n            $accommodation_fee = $nights * 2000;\n            $breakdown['driver_accommodation'] = $accommodation_fee;\n            $driver_allowance += $accommodation_fee;\n        }\n        \n        \/\/ \u9910\u8cbb\u88dc\u8cbc\n        if ($driver_meals === 'allowance') {\n            $meals_fee = $trip_days * 400;\n            $breakdown['driver_meals'] = $meals_fee;\n            $driver_allowance += $meals_fee;\n        }\n        \n        $breakdown['driver_allowance'] = $driver_allowance;\n        $subtotal += $driver_allowance;\n        \n        \/\/ ====================================\n        \/\/ 5. \u52a0\u8cfc\u9805\u76ee\n        \/\/ ====================================\n        $addon_charge = 0;\n        \n        if ($child_seats > 0) {\n            $child_seats_fee = $child_seats * 100;\n            $breakdown['child_seats'] = $child_seats_fee;\n            $addon_charge += $child_seats_fee;\n        }\n        \n        if ($booster_seats > 0) {\n            $booster_seats_fee = $booster_seats * 100;\n            $breakdown['booster_seats'] = $booster_seats_fee;\n            $addon_charge += $booster_seats_fee;\n        }\n        \n        $breakdown['addon_charge'] = $addon_charge;\n        $subtotal += $addon_charge;\n        \n        \/\/ ====================================\n        \/\/ 6. \u7e3d\u8a08\u8207\u8a02\u91d1\u8a08\u7b97\n        \/\/ ====================================\n        $total = $subtotal; \/\/ \u50f9\u683c\u5df2\u542b5%\u71df\u696d\u7a05\n        $deposit = round($total * 0.3); \/\/ 30%\u8a02\u91d1\n        $balance = $total - $deposit;   \/\/ 70%\u5c3e\u6b3e\n        \n        \/\/ ====================================\n        \/\/ 7. \u8fd4\u56de\u7d50\u679c\n        \/\/ ====================================\n        wp_send_json_success(array(\n            'subtotal' => $subtotal,\n            'total' => $total,\n            'deposit' => $deposit,\n            'balance' => $balance,\n            'breakdown' => $breakdown,\n            'trip_days' => $trip_days,\n            'passengers' => $passengers,\n            'daily_routes' => $daily_routes,\n            'timestamp' => current_time('mysql'),\n            'debug_info' => array(\n                'base_rate' => $base_daily_rate,\n                'is_south' => $is_south,\n                'mountain_days_count' => count($mountain_days),\n                'mountain_surcharge' => $mountain_surcharge,\n                'needs_manual_check' => $needs_manual_check\n            )\n        ));\n        \n    } catch (Exception $e) {\n        error_log('Charter Price Calc Error: ' . $e->getMessage());\n        wp_send_json_error(array(\n            'message' => '\u8a08\u7b97\u932f\u8aa4\uff1a' . $e->getMessage(),\n            'code' => 'CALC_ERROR'\n        ));\n    }\n    \n    wp_die();\n}\n\n\/\/ ====================================\n\/\/ \u8f14\u52a9\u51fd\u6578\uff1a\u6aa2\u6e2c\u5730\u5740\u6240\u5728\u7e23\u5e02\n\/\/ ====================================\nfunction detect_city_from_address($address) {\n    if (empty($address)) {\n        return '';\n    }\n    \n    \/\/ \u4f7f\u7528\u667a\u80fd\u5730\u5740\u8655\u7406\uff08\u5982\u679c\u6709Google API\uff09\n    if (function_exists('smart_address_processing')) {\n        $processed = smart_address_processing($address);\n        if (!empty($processed['city'])) {\n            return $processed['city'];\n        }\n    }\n    \n    \/\/ \u5099\u7528\uff1a\u95dc\u9375\u5b57\u6aa2\u6e2c\n    $cities = array(\n        '\u53f0\u5317\u5e02', '\u81fa\u5317\u5e02', '\u65b0\u5317\u5e02', '\u57fa\u9686\u5e02', '\u6843\u5712\u5e02',\n        '\u65b0\u7af9\u5e02', '\u65b0\u7af9\u7e23', '\u82d7\u6817\u7e23', '\u53f0\u4e2d\u5e02', '\u81fa\u4e2d\u5e02',\n        '\u5f70\u5316\u7e23', '\u5357\u6295\u7e23', '\u96f2\u6797\u7e23', '\u5609\u7fa9\u5e02', '\u5609\u7fa9\u7e23',\n        '\u53f0\u5357\u5e02', '\u81fa\u5357\u5e02', '\u9ad8\u96c4\u5e02', '\u5c4f\u6771\u7e23', '\u5b9c\u862d\u7e23',\n        '\u82b1\u84ee\u7e23', '\u53f0\u6771\u7e23', '\u81fa\u6771\u7e23', '\u6f8e\u6e56\u7e23', '\u91d1\u9580\u7e23', '\u9023\u6c5f\u7e23'\n    );\n    \n    foreach ($cities as $city) {\n        if (mb_strpos($address, $city) !== false) {\n            return $city;\n        }\n    }\n    \n    return '';\n}\n\n\/\/ ====================================\n\/\/ \u8f14\u52a9\u51fd\u6578\uff1a\u5224\u65b7\u662f\u5426\u70ba\u5357\u90e8\u6216\u82b1\u6771\u5730\u5340\n\/\/ ====================================\nfunction is_south_or_east($city) {\n    if (empty($city)) {\n        return false;\n    }\n    \n    $south_east_cities = array(\n        '\u53f0\u5357\u5e02', '\u81fa\u5357\u5e02',\n        '\u9ad8\u96c4\u5e02',\n        '\u5c4f\u6771\u7e23',\n        '\u82b1\u84ee\u7e23',\n        '\u53f0\u6771\u7e23', '\u81fa\u6771\u7e23'\n    );\n    \n    foreach ($south_east_cities as $se_city) {\n        if (mb_strpos($city, $se_city) !== false) {\n            return true;\n        }\n    }\n    \n    return false;\n}\n\n\/\/ ====================================\n\/\/ \u8f14\u52a9\u51fd\u6578\uff1a\u6aa2\u67e5\u5c71\u5340\u5730\u9ede\uff08\u7c21\u5316\u7248\uff09\n\/\/ ====================================\nfunction check_mountain_location($address) {\n    $result = array(\n        'is_mountain' => false,\n        'confidence' => 0,\n        'elevation' => 0,\n        'area' => '',\n        'is_excluded' => false,\n        'excluded_reason' => ''\n    );\n    \n    if (empty($address)) {\n        return $result;\n    }\n    \n    \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n    $excluded_areas = array('\u53f8\u99ac\u5eab\u65af', '\u93ae\u897f\u5821', '\u795e\u6728\u7fa4');\n    foreach ($excluded_areas as $excluded) {\n        if (mb_strpos($address, $excluded) !== false) {\n            $result['is_excluded'] = true;\n            $result['excluded_reason'] = \"\u4e0d\u63d0\u4f9b{$excluded}\u5730\u5340\u670d\u52d9\";\n            return $result;\n        }\n    }\n    \n    \/\/ \u4f7f\u7528API\u6aa2\u67e5\uff08\u5982\u679c\u6709\uff09\n    if (function_exists('check_mountain_route')) {\n        $api_result = check_mountain_route($address);\n        \n        $result['is_mountain'] = $api_result['is_mountain'] ?? false;\n        $result['confidence'] = $api_result['confidence'] ?? 0;\n        $result['elevation'] = $api_result['elevation'] ?? 0;\n        $result['area'] = $api_result['formatted_address'] ?? $address;\n        \n        return $result;\n    }\n    \n    \/\/ \u5099\u7528\uff1a\u95dc\u9375\u5b57\u6aa2\u6e2c\n    $mountain_keywords = array(\n        '\u6b66\u5dba' => 99,\n        '\u5408\u6b61\u5c71' => 98,\n        '\u963f\u91cc\u5c71' => 98,\n        '\u62c9\u62c9\u5c71' => 97,\n        '\u8c37\u95dc' => 96,\n        '\u6e05\u5883\u8fb2\u5834' => 95,\n        '\u6b66\u9675\u8fb2\u5834' => 95,\n        '\u592a\u9b6f\u95a3' => 95,\n        '\u65e5\u6708\u6f6d' => 90,\n        '\u6eaa\u982d' => 90,\n        '\u798f\u58fd\u5c71' => 95,\n        '\u68a8\u5c71' => 95,\n        '\u5927\u96ea\u5c71' => 95,\n        '\u516b\u4ed9\u5c71' => 90,\n        '\u5967\u842c\u5927' => 90\n    );\n    \n    foreach ($mountain_keywords as $keyword => $confidence) {\n        if (mb_strpos($address, $keyword) !== false) {\n            $result['is_mountain'] = true;\n            $result['confidence'] = $confidence;\n            $result['area'] = $keyword;\n            \n            \/\/ \u4f30\u7b97\u6d77\u62d4\uff08\u6839\u64da\u5730\u9ede\uff09\n            if (in_array($keyword, array('\u6b66\u5dba', '\u5408\u6b61\u5c71'))) {\n                $result['elevation'] = 3000;\n            } elseif (in_array($keyword, array('\u963f\u91cc\u5c71', '\u68a8\u5c71', '\u798f\u58fd\u5c71'))) {\n                $result['elevation'] = 2000;\n            } elseif (in_array($keyword, array('\u6e05\u5883\u8fb2\u5834', '\u6b66\u9675\u8fb2\u5834'))) {\n                $result['elevation'] = 1500;\n            } else {\n                $result['elevation'] = 800;\n            }\n            \n            break;\n        }\n    }\n    \n    return $result;\n}\n\n\/\/ ====================================\n\/\/ AJAX\u8655\u7406\uff1a\u9a57\u8b49\u5730\u5740\uff08\u7528\u65bc\u524d\u7aef\u5373\u6642\u6aa2\u67e5\uff09\n\/\/ ====================================\nadd_action('wp_ajax_validate_charter_address', 'handle_charter_address_validation');\nadd_action('wp_ajax_nopriv_validate_charter_address', 'handle_charter_address_validation');\n\nfunction handle_charter_address_validation() {\n    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';\n    \n    if (empty($address)) {\n        wp_send_json_error(array('message' => '\u5730\u5740\u70ba\u7a7a'));\n    }\n    \n    $city = detect_city_from_address($address);\n    $is_south = is_south_or_east($city);\n    $mountain_check = check_mountain_location($address);\n    \n    wp_send_json_success(array(\n        'address' => $address,\n        'city' => $city,\n        'is_south' => $is_south,\n        'base_rate' => $is_south ? 14000 : 12000,\n        'is_mountain' => $mountain_check['is_mountain'],\n        'mountain_confidence' => $mountain_check['confidence'],\n        'elevation' => $mountain_check['elevation'],\n        'is_excluded' => $mountain_check['is_excluded'],\n        'excluded_reason' => $mountain_check['excluded_reason']\n    ));\n    \n    wp_die();\n}","active":true,"priority":23,"modified":"2025-09-14 03:32:36","revision":"1"}]}