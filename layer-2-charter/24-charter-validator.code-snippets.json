{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":99,"name":"24-Charter-Validator","code":"\/**\n * ============================================================================\n * Snippet: 24-Charter-Validator\n * Title: \u5305\u8eca\u8cc7\u6599\u9a57\u8b49\n * Description: \u9a57\u8b49\u5305\u8eca\u9810\u7d04\u8cc7\u6599\u7684\u5b8c\u6574\u6027\u8207\u6b63\u78ba\u6027\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 24\n * Dependencies: 20-Charter-Settings, 03-Common-Utilities\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ \u6aa2\u67e5\u4f9d\u8cf4\nif (!class_exists('NineOVan_Charter_Settings')) {\n    error_log('[24-Charter-Validator] \u932f\u8aa4\uff1a\u7f3a\u5c11\u8a2d\u5b9a\u985e\u5225');\n    return;\n}\n\n\/**\n * \u5305\u8eca\u8cc7\u6599\u9a57\u8b49\u985e\u5225\n *\/\nclass NineOVan_Charter_Validator {\n    \n    private static $instance = null;\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        $this->init_hooks();\n    }\n    \n    \/**\n     * \u521d\u59cb\u5316\u9264\u5b50\n     *\/\n    private function init_hooks() {\n        \/\/ AJAX \u9a57\u8b49\u7aef\u9ede\n        add_action('wp_ajax_validate_charter_booking', array($this, 'ajax_validate_booking'));\n        add_action('wp_ajax_nopriv_validate_charter_booking', array($this, 'ajax_validate_booking'));\n        \n        add_action('wp_ajax_validate_charter_route', array($this, 'ajax_validate_route'));\n        add_action('wp_ajax_nopriv_validate_charter_route', array($this, 'ajax_validate_route'));\n    }\n    \n    \/**\n     * \u9a57\u8b49\u5b8c\u6574\u9810\u7d04\u8cc7\u6599\n     *\/\n    public function validate_booking($data) {\n        $errors = array();\n        \n        \/\/ \u57fa\u672c\u8cc7\u6599\u9a57\u8b49\n        $basic_errors = $this->validate_basic_info($data);\n        if (!empty($basic_errors)) {\n            $errors = array_merge($errors, $basic_errors);\n        }\n        \n        \/\/ \u5ba2\u6236\u8cc7\u6599\u9a57\u8b49\n        $customer_errors = $this->validate_customer_info($data);\n        if (!empty($customer_errors)) {\n            $errors = array_merge($errors, $customer_errors);\n        }\n        \n        \/\/ \u884c\u7a0b\u8def\u7dda\u9a57\u8b49\n        $route_errors = $this->validate_routes($data);\n        if (!empty($route_errors)) {\n            $errors = array_merge($errors, $route_errors);\n        }\n        \n        \/\/ \u65e5\u671f\u6642\u9593\u9a57\u8b49\n        $datetime_errors = $this->validate_datetime($data);\n        if (!empty($datetime_errors)) {\n            $errors = array_merge($errors, $datetime_errors);\n        }\n        \n        \/\/ \u50f9\u683c\u9a57\u8b49\n        $price_errors = $this->validate_price($data);\n        if (!empty($price_errors)) {\n            $errors = array_merge($errors, $price_errors);\n        }\n        \n        return array(\n            'valid' => empty($errors),\n            'errors' => $errors\n        );\n    }\n    \n    \/**\n     * \u9a57\u8b49\u57fa\u672c\u8cc7\u8a0a\n     *\/\n    private function validate_basic_info($data) {\n        $errors = array();\n        \n        \/\/ \u884c\u7a0b\u5929\u6578\n        if (!isset($data['trip_days']) || empty($data['trip_days'])) {\n            $errors[] = '\u8acb\u9078\u64c7\u884c\u7a0b\u5929\u6578';\n        } else {\n            $trip_days = intval($data['trip_days']);\n            if ($trip_days < 1 || $trip_days > _9O_VAN_CHARTER_MAX_DAYS) {\n                $errors[] = sprintf('\u884c\u7a0b\u5929\u6578\u5fc5\u9808\u57281-%d\u5929\u4e4b\u9593', _9O_VAN_CHARTER_MAX_DAYS);\n            }\n        }\n        \n        \/\/ \u4e58\u5ba2\u4eba\u6578\n        if (!isset($data['passengers']) || empty($data['passengers'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u4e58\u5ba2\u4eba\u6578';\n        } else {\n            $passengers = intval($data['passengers']);\n            if ($passengers < 1 || $passengers > 8) {\n                $errors[] = '\u4e58\u5ba2\u4eba\u6578\u5fc5\u9808\u57281-8\u4eba\u4e4b\u9593';\n            }\n        }\n        \n        \/\/ \u5b30\u5152\u5ea7\u6905\u8207\u589e\u9ad8\u588a\n        if (isset($data['child_seats'])) {\n            $child_seats = intval($data['child_seats']);\n            if ($child_seats < 0 || $child_seats > 4) {\n                $errors[] = '\u5b30\u5152\u5ea7\u6905\u6578\u91cf\u4e0d\u80fd\u8d85\u904e4\u5f35';\n            }\n        }\n        \n        if (isset($data['booster_seats'])) {\n            $booster_seats = intval($data['booster_seats']);\n            if ($booster_seats < 0 || $booster_seats > 4) {\n                $errors[] = '\u589e\u9ad8\u588a\u6578\u91cf\u4e0d\u80fd\u8d85\u904e4\u5f35';\n            }\n        }\n        \n        \/\/ \u6aa2\u67e5\u7e3d\u5ea7\u4f4d\u6578\n        if (isset($data['passengers']) && isset($data['child_seats']) && isset($data['booster_seats'])) {\n            $total_seats = intval($data['passengers']) + intval($data['child_seats']) + intval($data['booster_seats']);\n            if ($total_seats > 8) {\n                $errors[] = '\u7e3d\u5ea7\u4f4d\u6578\uff08\u542b\u5b30\u5152\u5ea7\u6905\u548c\u589e\u9ad8\u588a\uff09\u4e0d\u80fd\u8d85\u904e8\u500b';\n            }\n        }\n        \n        return $errors;\n    }\n    \n    \/**\n     * \u9a57\u8b49\u5ba2\u6236\u8cc7\u8a0a\n     *\/\n    private function validate_customer_info($data) {\n        $errors = array();\n        \n        \/\/ \u59d3\u540d\n        if (!isset($data['customer_name']) || empty($data['customer_name'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u806f\u7d61\u4eba\u59d3\u540d';\n        } else {\n            $name = trim($data['customer_name']);\n            if (mb_strlen($name) < 2) {\n                $errors[] = '\u59d3\u540d\u81f3\u5c11\u9700\u89812\u500b\u5b57\u5143';\n            }\n            if (mb_strlen($name) > 50) {\n                $errors[] = '\u59d3\u540d\u4e0d\u80fd\u8d85\u904e50\u500b\u5b57\u5143';\n            }\n        }\n        \n        \/\/ \u96fb\u8a71\n        if (!isset($data['customer_phone']) || empty($data['customer_phone'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u806f\u7d61\u96fb\u8a71';\n        } else {\n            $phone = preg_replace('\/[^0-9+]\/', '', $data['customer_phone']);\n            \n            \/\/ \u9a57\u8b49\u96fb\u8a71\u683c\u5f0f\uff08\u652f\u63f4\u570b\u969b\u683c\u5f0f\uff09\n            if (!preg_match('\/^(\\+[0-9]{1,4})?[0-9]{9,15}$\/', $phone)) {\n                $errors[] = '\u96fb\u8a71\u683c\u5f0f\u4e0d\u6b63\u78ba\uff0c\u8acb\u8f38\u5165\u6709\u6548\u7684\u96fb\u8a71\u865f\u78bc';\n            }\n            \n            \/\/ \u53f0\u7063\u624b\u6a5f\u865f\u78bc\u9a57\u8b49\n            if (preg_match('\/^09[0-9]{8}$\/', $phone)) {\n                \/\/ \u6709\u6548\u7684\u53f0\u7063\u624b\u6a5f\u865f\u78bc\n            } elseif (preg_match('\/^\\+8869[0-9]{8}$\/', $phone)) {\n                \/\/ \u6709\u6548\u7684\u53f0\u7063\u570b\u969b\u683c\u5f0f\u624b\u6a5f\u865f\u78bc\n            }\n        }\n        \n        \/\/ Email\uff08\u9078\u586b\uff0c\u4f46\u5982\u679c\u6709\u586b\u8981\u9a57\u8b49\u683c\u5f0f\uff09\n        if (isset($data['customer_email']) && !empty($data['customer_email'])) {\n            if (!filter_var($data['customer_email'], FILTER_VALIDATE_EMAIL)) {\n                $errors[] = 'Email \u683c\u5f0f\u4e0d\u6b63\u78ba';\n            }\n            \n            \/\/ \u6aa2\u67e5 Email \u9577\u5ea6\n            if (strlen($data['customer_email']) > 100) {\n                $errors[] = 'Email \u9577\u5ea6\u4e0d\u80fd\u8d85\u904e100\u500b\u5b57\u5143';\n            }\n        }\n        \n        \/\/ \u5099\u8a3b\uff08\u9078\u586b\uff0c\u4f46\u6709\u9577\u5ea6\u9650\u5236\uff09\n        if (isset($data['notes']) && !empty($data['notes'])) {\n            if (mb_strlen($data['notes']) > 500) {\n                $errors[] = '\u5099\u8a3b\u5167\u5bb9\u4e0d\u80fd\u8d85\u904e500\u500b\u5b57';\n            }\n        }\n        \n        return $errors;\n    }\n    \n    \/**\n     * \u9a57\u8b49\u884c\u7a0b\u8def\u7dda\n     *\/\n    private function validate_routes($data) {\n        $errors = array();\n        \n        if (!isset($data['daily_routes']) || !is_array($data['daily_routes'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u6bcf\u65e5\u884c\u7a0b';\n            return $errors;\n        }\n        \n        $trip_days = intval($data['trip_days'] ?? 1);\n        $daily_routes = $data['daily_routes'];\n        \n        \/\/ \u6aa2\u67e5\u8def\u7dda\u6578\u91cf\n        if (count($daily_routes) !== $trip_days) {\n            $errors[] = '\u6bcf\u65e5\u884c\u7a0b\u6578\u91cf\u8207\u884c\u7a0b\u5929\u6578\u4e0d\u7b26';\n        }\n        \n        \/\/ \u9a57\u8b49\u6bcf\u65e5\u8def\u7dda\n        foreach ($daily_routes as $day => $route) {\n            $day_num = $day + 1;\n            \n            \/\/ \u6aa2\u67e5\u8d77\u9ede\n            if (empty($route['origin'])) {\n                $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u8d77\u9ede\u672a\u586b\u5beb\";\n            } else {\n                \/\/ \u9a57\u8b49\u5730\u5740\u9577\u5ea6\n                if (mb_strlen($route['origin']) < 5) {\n                    $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u8d77\u9ede\u5730\u5740\u592a\u77ed\";\n                }\n                if (mb_strlen($route['origin']) > 200) {\n                    $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u8d77\u9ede\u5730\u5740\u592a\u9577\";\n                }\n                \n                \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                $excluded_check = $this->check_excluded_area($route['origin']);\n                if ($excluded_check) {\n                    $errors[] = $excluded_check;\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u7d42\u9ede\n            if (empty($route['destination'])) {\n                $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u7d42\u9ede\u672a\u586b\u5beb\";\n            } else {\n                \/\/ \u9a57\u8b49\u5730\u5740\u9577\u5ea6\n                if (mb_strlen($route['destination']) < 5) {\n                    $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u7d42\u9ede\u5730\u5740\u592a\u77ed\";\n                }\n                if (mb_strlen($route['destination']) > 200) {\n                    $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u7d42\u9ede\u5730\u5740\u592a\u9577\";\n                }\n                \n                \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                $excluded_check = $this->check_excluded_area($route['destination']);\n                if ($excluded_check) {\n                    $errors[] = $excluded_check;\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u505c\u9760\u9ede\n            if (!empty($route['stops']) && is_array($route['stops'])) {\n                \/\/ \u6aa2\u67e5\u505c\u9760\u9ede\u6578\u91cf\n                if (count($route['stops']) > _9O_VAN_CHARTER_MAX_STOPS_PER_DAY) {\n                    $errors[] = sprintf(\n                        \"\u7b2c%d\u5929\u7684\u505c\u9760\u9ede\u4e0d\u80fd\u8d85\u904e%d\u500b\",\n                        $day_num,\n                        _9O_VAN_CHARTER_MAX_STOPS_PER_DAY\n                    );\n                }\n                \n                \/\/ \u9a57\u8b49\u6bcf\u500b\u505c\u9760\u9ede\n                foreach ($route['stops'] as $stop_index => $stop) {\n                    if (!empty($stop)) {\n                        \/\/ \u9a57\u8b49\u5730\u5740\u9577\u5ea6\n                        if (mb_strlen($stop) < 3) {\n                            $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u505c\u9760\u9ede{$stop_index}\u5730\u5740\u592a\u77ed\";\n                        }\n                        if (mb_strlen($stop) > 200) {\n                            $errors[] = \"\u7b2c{$day_num}\u5929\u7684\u505c\u9760\u9ede{$stop_index}\u5730\u5740\u592a\u9577\";\n                        }\n                        \n                        \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                        $excluded_check = $this->check_excluded_area($stop);\n                        if ($excluded_check) {\n                            $errors[] = $excluded_check;\n                        }\n                    }\n                }\n            }\n        }\n        \n        return $errors;\n    }\n    \n    \/**\n     * \u9a57\u8b49\u65e5\u671f\u6642\u9593\n     *\/\n    private function validate_datetime($data) {\n        $errors = array();\n        \n        \/\/ \u51fa\u767c\u65e5\u671f\n        if (!isset($data['start_date']) || empty($data['start_date'])) {\n            $errors[] = '\u8acb\u9078\u64c7\u51fa\u767c\u65e5\u671f';\n        } else {\n            $start_date = $data['start_date'];\n            \n            \/\/ \u6aa2\u67e5\u65e5\u671f\u683c\u5f0f\n            if (!preg_match('\/^\\d{4}-\\d{2}-\\d{2}$\/', $start_date)) {\n                $errors[] = '\u51fa\u767c\u65e5\u671f\u683c\u5f0f\u4e0d\u6b63\u78ba';\n            } else {\n                \/\/ \u6aa2\u67e5\u662f\u5426\u70ba\u6709\u6548\u65e5\u671f\n                $date_parts = explode('-', $start_date);\n                if (!checkdate($date_parts[1], $date_parts[2], $date_parts[0])) {\n                    $errors[] = '\u51fa\u767c\u65e5\u671f\u7121\u6548';\n                } else {\n                    \/\/ \u6aa2\u67e5\u6700\u5c0f\u9810\u7d04\u5929\u6578\n                    $min_date = date('Y-m-d', strtotime('+' . _9O_VAN_CHARTER_MIN_BOOKING_DAYS . ' days'));\n                    if ($start_date < $min_date) {\n                        $errors[] = sprintf(\n                            '\u8acb\u81f3\u5c11\u63d0\u524d%d\u5929\u9810\u7d04\uff0c\u4ee5\u4fbf\u5b89\u6392\u8eca\u8f1b\u8207\u53f8\u6a5f',\n                            _9O_VAN_CHARTER_MIN_BOOKING_DAYS\n                        );\n                    }\n                    \n                    \/\/ \u6aa2\u67e5\u6700\u5927\u9810\u7d04\u5929\u6578\uff08\u4f8b\u5982\uff1a\u4e0d\u80fd\u9810\u7d04\u8d85\u904e6\u500b\u6708\u5f8c\uff09\n                    $max_date = date('Y-m-d', strtotime('+6 months'));\n                    if ($start_date > $max_date) {\n                        $errors[] = '\u9810\u7d04\u65e5\u671f\u4e0d\u80fd\u8d85\u904e6\u500b\u6708\u5f8c';\n                    }\n                }\n            }\n        }\n        \n        \/\/ \u51fa\u767c\u6642\u9593\n        if (!isset($data['start_time']) || empty($data['start_time'])) {\n            $errors[] = '\u8acb\u9078\u64c7\u51fa\u767c\u6642\u9593';\n        } else {\n            $start_time = $data['start_time'];\n            \n            \/\/ \u6aa2\u67e5\u6642\u9593\u683c\u5f0f\n            if (!preg_match('\/^([01][0-9]|2[0-3]):[0-5][0-9]$\/', $start_time)) {\n                $errors[] = '\u51fa\u767c\u6642\u9593\u683c\u5f0f\u4e0d\u6b63\u78ba';\n            }\n        }\n        \n        \/\/ \u7d50\u675f\u65e5\u671f\u8a08\u7b97\u8207\u9a57\u8b49\n        if (isset($data['start_date']) && isset($data['trip_days'])) {\n            $trip_days = intval($data['trip_days']);\n            $end_date = date('Y-m-d', strtotime($data['start_date'] . ' + ' . ($trip_days - 1) . ' days'));\n            \n            \/\/ \u6aa2\u67e5\u662f\u5426\u8de8\u5e74\n            $start_year = date('Y', strtotime($data['start_date']));\n            $end_year = date('Y', strtotime($end_date));\n            if ($start_year !== $end_year) {\n                \/\/ \u5141\u8a31\u8de8\u5e74\uff0c\u4f46\u8981\u8a18\u9304\n                \/\/ $errors[] = '\u884c\u7a0b\u8de8\u5e74\u5ea6\u9700\u8981\u7279\u5225\u78ba\u8a8d';\n            }\n        }\n        \n        return $errors;\n    }\n    \n    \/**\n     * \u9a57\u8b49\u50f9\u683c\n     *\/\n    private function validate_price($data) {\n        $errors = array();\n        \n        \/\/ \u7e3d\u50f9\n        if (!isset($data['total_price']) || empty($data['total_price'])) {\n            $errors[] = '\u7f3a\u5c11\u7e3d\u50f9\u8cc7\u8a0a';\n        } else {\n            $total_price = floatval($data['total_price']);\n            if ($total_price <= 0) {\n                $errors[] = '\u7e3d\u50f9\u5fc5\u9808\u5927\u65bc0';\n            }\n            \n            \/\/ \u6aa2\u67e5\u6700\u4f4e\u50f9\u683c\uff08\u4f8b\u5982\uff1a\u81f3\u5c11\u8981\u6709\u57fa\u672c\u8cbb\u7528\uff09\n            $min_price = _9o_van_get_charter_base_rate('north');\n            if ($total_price < $min_price) {\n                $errors[] = sprintf('\u7e3d\u50f9\u4e0d\u80fd\u4f4e\u65bc\u57fa\u672c\u8cbb\u7528 NT$ %s', number_format($min_price));\n            }\n        }\n        \n        \/\/ \u8a02\u91d1\n        if (isset($data['deposit'])) {\n            $deposit = floatval($data['deposit']);\n            $total_price = floatval($data['total_price'] ?? 0);\n            \n            if ($deposit < 0) {\n                $errors[] = '\u8a02\u91d1\u4e0d\u80fd\u70ba\u8ca0\u6578';\n            }\n            \n            if ($deposit > $total_price) {\n                $errors[] = '\u8a02\u91d1\u4e0d\u80fd\u8d85\u904e\u7e3d\u50f9';\n            }\n            \n            \/\/ \u6aa2\u67e5\u8a02\u91d1\u6bd4\u4f8b\uff08\u61c9\u8a72\u662f30%\uff09\n            $expected_deposit = round($total_price * 0.3);\n            if (abs($deposit - $expected_deposit) > 10) { \/\/ \u5141\u8a3110\u5143\u8aa4\u5dee\n                \/\/ \u53ea\u662f\u8b66\u544a\uff0c\u4e0d\u662f\u932f\u8aa4\n                \/\/ $errors[] = '\u8a02\u91d1\u8a08\u7b97\u53ef\u80fd\u6709\u8aa4';\n            }\n        }\n        \n        return $errors;\n    }\n    \n    \/**\n     * \u6aa2\u67e5\u6392\u9664\u5730\u5340\n     *\/\n    private function check_excluded_area($address) {\n        $excluded_areas = NineOVan_Charter_Settings::get_excluded_areas();\n        \n        foreach ($excluded_areas as $excluded) {\n            if (mb_strpos($address, $excluded) !== false) {\n                return \"\u62b1\u6b49\uff0c\u6211\u5011\u76ee\u524d\u4e0d\u63d0\u4f9b{$excluded}\u5730\u5340\u7684\u670d\u52d9\uff0c\u8acb\u53e6\u884c\u806f\u7e6b\u5831\u50f9\";\n            }\n        }\n        \n        return false;\n    }\n    \n    \/**\n     * \u9a57\u8b49\u55ae\u65e5\u8def\u7dda\n     *\/\n    public function validate_daily_route($route_data) {\n        $errors = array();\n        \n        \/\/ \u6aa2\u67e5\u5fc5\u8981\u6b04\u4f4d\n        if (empty($route_data['origin'])) {\n            $errors[] = '\u8d77\u9ede\u4e0d\u80fd\u70ba\u7a7a';\n        }\n        \n        if (empty($route_data['destination'])) {\n            $errors[] = '\u7d42\u9ede\u4e0d\u80fd\u70ba\u7a7a';\n        }\n        \n        \/\/ \u6aa2\u67e5\u8d77\u9ede\u7d42\u9ede\u662f\u5426\u76f8\u540c\n        if (!empty($route_data['origin']) && !empty($route_data['destination'])) {\n            if ($route_data['origin'] === $route_data['destination']) {\n                $errors[] = '\u8d77\u9ede\u548c\u7d42\u9ede\u4e0d\u80fd\u76f8\u540c';\n            }\n        }\n        \n        \/\/ \u6aa2\u67e5\u505c\u9760\u9ede\n        if (isset($route_data['stops']) && is_array($route_data['stops'])) {\n            $valid_stops = array_filter($route_data['stops'], function($stop) {\n                return !empty(trim($stop));\n            });\n            \n            if (count($valid_stops) > _9O_VAN_CHARTER_MAX_STOPS_PER_DAY) {\n                $errors[] = sprintf('\u505c\u9760\u9ede\u4e0d\u80fd\u8d85\u904e%d\u500b', _9O_VAN_CHARTER_MAX_STOPS_PER_DAY);\n            }\n        }\n        \n        return array(\n            'valid' => empty($errors),\n            'errors' => $errors\n        );\n    }\n    \n    \/**\n     * \u9a57\u8b49\u53f8\u6a5f\u5b89\u6392\n     *\/\n    public function validate_driver_arrangement($data) {\n        $errors = array();\n        \n        $trip_days = intval($data['trip_days'] ?? 1);\n        \n        \/\/ \u591a\u65e5\u884c\u7a0b\u5fc5\u9808\u5b89\u6392\u4f4f\u5bbf\n        if ($trip_days > 1) {\n            if (!isset($data['driver_accommodation']) || \n                !in_array($data['driver_accommodation'], array('self', 'book'))) {\n                $errors[] = '\u591a\u65e5\u884c\u7a0b\u8acb\u9078\u64c7\u53f8\u6a5f\u4f4f\u5bbf\u5b89\u6392\u65b9\u5f0f';\n            }\n        }\n        \n        \/\/ \u9a57\u8b49\u9910\u8cbb\u9078\u9805\n        if (isset($data['driver_meals'])) {\n            if (!in_array($data['driver_meals'], array('provided', 'allowance'))) {\n                $errors[] = '\u8acb\u9078\u64c7\u6b63\u78ba\u7684\u53f8\u6a5f\u7528\u9910\u5b89\u6392\u65b9\u5f0f';\n            }\n        }\n        \n        return array(\n            'valid' => empty($errors),\n            'errors' => $errors\n        );\n    }\n    \n    \/**\n     * \u9a57\u8b49\u885d\u7a81\n     *\/\n    public function check_booking_conflict($start_date, $trip_days) {\n        \/\/ \u4f7f\u7528\u8cc7\u6599\u5eab\u51fd\u5f0f\u6aa2\u67e5\u885d\u7a81\n        if (function_exists('_9o_van_check_charter_conflict')) {\n            $conflicts = _9o_van_check_charter_conflict($start_date, $trip_days);\n            \n            if ($conflicts) {\n                return array(\n                    'has_conflict' => true,\n                    'conflicts' => $conflicts,\n                    'message' => '\u9078\u64c7\u7684\u65e5\u671f\u5df2\u6709\u5176\u4ed6\u9810\u7d04\uff0c\u8acb\u9078\u64c7\u5176\u4ed6\u65e5\u671f'\n                );\n            }\n        }\n        \n        return array(\n            'has_conflict' => false\n        );\n    }\n    \n    \/**\n     * AJAX: \u9a57\u8b49\u9810\u7d04\n     *\/\n    public function ajax_validate_booking() {\n        \/\/ \u6536\u96c6\u8cc7\u6599\n        $data = array();\n        foreach ($_POST as $key => $value) {\n            if ($key !== 'action') {\n                $data[$key] = $value;\n            }\n        }\n        \n        \/\/ \u89e3\u6790 JSON \u6b04\u4f4d\n        if (isset($data['daily_routes']) && is_string($data['daily_routes'])) {\n            $data['daily_routes'] = json_decode(stripslashes($data['daily_routes']), true);\n        }\n        \n        \/\/ \u57f7\u884c\u9a57\u8b49\n        $result = $this->validate_booking($data);\n        \n        if ($result['valid']) {\n            wp_send_json_success(array(\n                'message' => '\u8cc7\u6599\u9a57\u8b49\u901a\u904e'\n            ));\n        } else {\n            wp_send_json_error(array(\n                'errors' => $result['errors']\n            ));\n        }\n        \n        wp_die();\n    }\n    \n    \/**\n     * AJAX: \u9a57\u8b49\u8def\u7dda\n     *\/\n    public function ajax_validate_route() {\n        $route_data = isset($_POST['route']) ? $_POST['route'] : array();\n        \n        if (is_string($route_data)) {\n            $route_data = json_decode(stripslashes($route_data), true);\n        }\n        \n        $result = $this->validate_daily_route($route_data);\n        \n        if ($result['valid']) {\n            wp_send_json_success(array(\n                'message' => '\u8def\u7dda\u9a57\u8b49\u901a\u904e'\n            ));\n        } else {\n            wp_send_json_error(array(\n                'errors' => $result['errors']\n            ));\n        }\n        \n        wp_die();\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\nNineOVan_Charter_Validator::get_instance();\n\n\/**\n * \u5168\u57df\u8f14\u52a9\u51fd\u5f0f\n *\/\n\n\/\/ \u9a57\u8b49\u5305\u8eca\u9810\u7d04\nif (!function_exists('_9o_van_validate_charter_booking')) {\n    function _9o_van_validate_charter_booking($data) {\n        return NineOVan_Charter_Validator::get_instance()->validate_booking($data);\n    }\n}\n\n\/\/ \u9a57\u8b49\u55ae\u65e5\u8def\u7dda\nif (!function_exists('_9o_van_validate_charter_route')) {\n    function _9o_van_validate_charter_route($route_data) {\n        return NineOVan_Charter_Validator::get_instance()->validate_daily_route($route_data);\n    }\n}\n\n\/\/ \u6aa2\u67e5\u9810\u7d04\u885d\u7a81\nif (!function_exists('_9o_van_check_charter_booking_conflict')) {\n    function _9o_van_check_charter_booking_conflict($start_date, $trip_days) {\n        return NineOVan_Charter_Validator::get_instance()->check_booking_conflict($start_date, $trip_days);\n    }\n}\n\n\/\/ \u8a18\u9304\u6a21\u7d44\u8f09\u5165\nif (defined('_9O_VAN_DEBUG') && _9O_VAN_DEBUG) {\n    error_log('[24-Charter-Validator] \u6a21\u7d44\u5df2\u8f09\u5165 - v1.0.0');\n}","active":true,"priority":24,"modified":"2025-09-14 03:09:25","revision":"1"}]}