{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:40","snippets":[{"id":102,"name":"27-Charter-Frontend-JS","code":"\/**\n * ============================================================================\n * Module: 27-Charter-Frontend-JS\n * Title: \u5305\u8eca\u670d\u52d9\u524d\u7aef JavaScript \u63a7\u5236\u5668\n * Description: \u8655\u7406\u5305\u8eca\u9810\u7d04\u8868\u55ae\u7684\u6240\u6709\u524d\u7aef\u4e92\u52d5\u3001\u9a57\u8b49\u3001\u8a08\u7b97\u548c\u63d0\u4ea4\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Dependencies: jQuery, Google Maps API\n * ============================================================================\n *\/\n\n(function(window, document, $) {\n    'use strict';\n    \n    \/\/ \u6aa2\u67e5 jQuery\n    if (typeof $ === 'undefined') {\n        console.error('[27-Charter-Frontend-JS] jQuery is required');\n        return;\n    }\n    \n    \/**\n     * \u5305\u8eca\u9810\u7d04\u61c9\u7528\u7a0b\u5f0f\u4e3b\u6a21\u7d44\n     *\/\n    const NineOVanCharterApp = {\n        \n        \/\/ ====================================\n        \/\/ \u914d\u7f6e\u8207\u72c0\u614b\n        \/\/ ====================================\n        config: null,\n        \n        state: {\n            tripDays: 1,\n            dailyRoutes: [],\n            isSubmitting: false,\n            lastCalculation: null,\n            mountainDetection: {},\n            calcTimeout: null,\n            initialized: false,\n            validators: {}\n        },\n        \n        elements: {},\n        \n        \/**\n         * \u521d\u59cb\u5316\u61c9\u7528\u7a0b\u5f0f\n         *\/\n        init(config) {\n            if (this.state.initialized) return;\n            \n            console.log('[Charter] Initializing v1.0.0...');\n            \n            \/\/ \u5132\u5b58\u914d\u7f6e\n            this.config = config || window.CharterFormConfig || {};\n            \n            \/\/ \u6aa2\u67e5\u5fc5\u8981\u5143\u7d20\n            if (!$('#charter-booking-form').length) {\n                console.warn('[Charter] Form not found');\n                return false;\n            }\n            \n            \/\/ \u5feb\u53d6\u5143\u7d20\n            this.cacheElements();\n            \n            \/\/ \u521d\u59cb\u5316\u5404\u6a21\u7d44\n            this.FormBuilder.init();\n            this.EventHandler.init();\n            this.AddressAutocomplete.init();\n            this.PriceCalculator.init();\n            this.FormValidator.init();\n            \n            \/\/ \u8f09\u5165\u8868\u55ae\u6a21\u677f\uff08\u5982\u679c\u6709\uff09\n            this.loadTemplates();\n            \n            \/\/ \u6a19\u8a18\u5df2\u521d\u59cb\u5316\n            this.state.initialized = true;\n            \n            \/\/ \u521d\u59cb\u8a08\u7b97\n            setTimeout(() => this.PriceCalculator.calculate(), 1000);\n            \n            console.log('[Charter] \u2705 Initialized successfully');\n            return true;\n        },\n        \n        \/**\n         * \u5feb\u53d6DOM\u5143\u7d20\n         *\/\n        cacheElements() {\n            this.elements = {\n                form: $('#charter-booking-form'),\n                pricePanel: $('#price-panel'),\n                tripDays: $('#trip_days'),\n                startDate: $('#start_date'),\n                startTime: $('#start_time'),\n                passengers: $('#passengers'),\n                childSeats: $('#child_seats'),\n                boosterSeats: $('#booster_seats'),\n                customerName: $('#customer_name'),\n                customerPhone: $('#customer_phone'),\n                customerEmail: $('#customer_email'),\n                notes: $('#notes'),\n                submitBtn: $('.btn-submit'),\n                routesContainer: $('#daily-routes-container'),\n                driverSection: $('#driver-section'),\n                driverOptions: $('#driver-options')\n            };\n        },\n        \n        \/**\n         * \u8f09\u5165\u6a21\u677f\n         *\/\n        loadTemplates() {\n            \/\/ \u5982\u679c\u8868\u55ae\u662f\u7a7a\u7684\uff0c\u5efa\u7acb\u8868\u55ae\n            if (this.elements.form.find('.form-loading').length) {\n                this.FormBuilder.buildForm();\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u8868\u55ae\u5efa\u69cb\u6a21\u7d44\n        \/\/ ====================================\n        FormBuilder: {\n            \/**\n             * \u521d\u59cb\u5316\n             *\/\n            init() {\n                \/\/ \u521d\u59cb\u5316\u6642\u5efa\u7acb\u8868\u55ae\uff08\u5982\u679c\u9700\u8981\uff09\n            },\n            \n            \/**\n             * \u5efa\u7acb\u5b8c\u6574\u8868\u55ae\n             *\/\n            buildForm() {\n                const app = NineOVanCharterApp;\n                const config = app.config;\n                \n                if (!config.formSections) {\n                    console.warn('[FormBuilder] No form sections defined');\n                    return;\n                }\n                \n                let html = '';\n                const sections = config.formSections;\n                \n                \/\/ \u6a19\u984c\n                if (sections.header) {\n                    html += this.getHeaderTemplate(sections.header);\n                }\n                \n                \/\/ \u57fa\u672c\u8cc7\u8a0a\n                if (sections.basic) {\n                    html += this.getSectionTemplate('basic', sections.basic);\n                }\n                \n                \/\/ \u8def\u7dda\u5340\u584a\n                if (sections.routes) {\n                    html += `\n                        <div class=\"form-section\">\n                            <h3>${sections.routes.title}<\/h3>\n                            <div id=\"daily-routes-container\"><\/div>\n                        <\/div>\n                    `;\n                }\n                \n                \/\/ \u53f8\u6a5f\u5b89\u6392\n                if (sections.driver) {\n                    html += `\n                        <div class=\"form-section\" id=\"driver-section\">\n                            <h3>${sections.driver.title}<\/h3>\n                            <div class=\"form-row\" id=\"driver-options\"><\/div>\n                        <\/div>\n                    `;\n                }\n                \n                \/\/ \u52a0\u8cfc\u9805\u76ee\n                if (sections.addon) {\n                    html += this.getSectionTemplate('addon', sections.addon);\n                }\n                \n                \/\/ \u806f\u7d61\u8cc7\u8a0a\n                if (sections.contact) {\n                    html += this.getSectionTemplate('contact', sections.contact);\n                }\n                \n                \/\/ \u63d0\u4ea4\u6309\u9215\n                html += '<button type=\"submit\" class=\"btn-submit\">\u63d0\u4ea4\u9810\u7d04<\/button>';\n                \n                app.elements.form.html(html);\n                \n                \/\/ \u66f4\u65b0\u52d5\u614b\u5340\u584a\n                this.updateDailyRoutes();\n                this.updateDriverSection();\n            },\n            \n            \/**\n             * \u53d6\u5f97\u6a19\u984c\u6a21\u677f\n             *\/\n            getHeaderTemplate(header) {\n                return `\n                    <div class=\"form-header\">\n                        <h2>${header.title}<\/h2>\n                        <p>${header.subtitle}<\/p>\n                    <\/div>\n                `;\n            },\n            \n            \/**\n             * \u53d6\u5f97\u5340\u584a\u6a21\u677f\n             *\/\n            getSectionTemplate(key, section) {\n                let html = `<div class=\"form-section\" id=\"section-${key}\">`;\n                html += `<h3>${section.title}<\/h3>`;\n                \n                if (section.notice) {\n                    html += `<div class=\"safety-alert\">${section.notice}<\/div>`;\n                }\n                \n                \/\/ \u8655\u7406\u6b04\u4f4d\n                Object.entries(section.fields || {}).forEach(([fieldKey, field]) => {\n                    html += this.getFieldHTML(fieldKey, field);\n                });\n                \n                html += '<\/div>';\n                return html;\n            },\n            \n            \/**\n             * \u53d6\u5f97\u6b04\u4f4dHTML\n             *\/\n            getFieldHTML(key, field) {\n                \/\/ \u5be6\u4f5c\u5404\u7a2e\u6b04\u4f4d\u985e\u578b\u7684HTML\u751f\u6210\n                \/\/ \u9019\u88e1\u7c21\u5316\u8655\u7406\n                return `<div class=\"form-group\">${key}<\/div>`;\n            },\n            \n            \/**\n             * \u66f4\u65b0\u6bcf\u65e5\u8def\u7dda\n             *\/\n            updateDailyRoutes() {\n                const app = NineOVanCharterApp;\n                const days = parseInt(app.elements.tripDays.val()) || 1;\n                const container = app.elements.routesContainer;\n                \n                \/\/ \u78ba\u4fdd\u8def\u7dda\u9663\u5217\u5927\u5c0f\u6b63\u78ba\n                while (app.state.dailyRoutes.length < days) {\n                    app.state.dailyRoutes.push({\n                        origin: '',\n                        destination: '',\n                        stops: []\n                    });\n                }\n                \n                \/\/ \u751f\u6210\u6bcf\u65e5\u884c\u7a0bHTML\n                let html = '';\n                for (let i = 0; i < days; i++) {\n                    html += this.getDayRouteTemplate(i);\n                }\n                \n                container.html(html);\n                \n                \/\/ \u6062\u5fa9\u505c\u9760\u9ede\n                app.state.dailyRoutes.forEach((route, dayIndex) => {\n                    if (route.stops && route.stops.length > 0) {\n                        route.stops.forEach(stop => {\n                            app.RouteManager.addStop(dayIndex, stop);\n                        });\n                    }\n                });\n                \n                \/\/ \u521d\u59cb\u5316\u5730\u5740\u81ea\u52d5\u5b8c\u6210\n                app.AddressAutocomplete.initAll();\n                \n                \/\/ \u66f4\u65b0\u65e5\u671f\u986f\u793a\n                this.updateDayDates();\n            },\n            \n            \/**\n             * \u53d6\u5f97\u55ae\u65e5\u8def\u7dda\u6a21\u677f\n             *\/\n            getDayRouteTemplate(dayIndex) {\n                const app = NineOVanCharterApp;\n                const dayNum = dayIndex + 1;\n                const route = app.state.dailyRoutes[dayIndex] || {};\n                const tripDays = parseInt(app.elements.tripDays.val()) || 1;\n                const maxStops = app.config.maxStops || 6;\n                \n                return `\n                    <div class=\"day-route-container\" data-day=\"${dayIndex}\">\n                        <div class=\"day-header\">\n                            <div class=\"day-title\">\n                                <span>Day ${dayNum}<\/span>\n                                ${dayIndex === 0 ? '<span class=\"day-badge\">\u51fa\u767c\u65e5<\/span>' : ''}\n                                ${dayIndex === tripDays - 1 && tripDays > 1 ? '<span class=\"day-badge\">\u8fd4\u7a0b\u65e5<\/span>' : ''}\n                            <\/div>\n                            <div class=\"day-date\" id=\"day-date-${dayIndex}\"><\/div>\n                        <\/div>\n                        \n                        <div class=\"form-row\">\n                            <div class=\"form-group\">\n                                <label>\u8d77\u9ede\u5730\u5740 <span class=\"required\">*<\/span><\/label>\n                                <div class=\"address-input-wrapper\">\n                                    <input type=\"text\" \n                                           name=\"origin_${dayIndex}\" \n                                           id=\"origin_${dayIndex}\"\n                                           class=\"address-autocomplete\" \n                                           placeholder=\"\u8f38\u5165\u5730\u5740\u6216\u5730\u6a19\"\n                                           value=\"${route.origin || ''}\" \n                                           required>\n                                    <div class=\"address-suggestions\" id=\"origin_${dayIndex}_suggestions\"><\/div>\n                                <\/div>\n                            <\/div>\n                            \n                            <div class=\"form-group\">\n                                <label>\u7d42\u9ede\u5730\u5740 <span class=\"required\">*<\/span><\/label>\n                                <div class=\"address-input-wrapper\">\n                                    <input type=\"text\" \n                                           name=\"destination_${dayIndex}\" \n                                           id=\"destination_${dayIndex}\"\n                                           class=\"address-autocomplete\" \n                                           placeholder=\"\u8f38\u5165\u5730\u5740\u6216\u5730\u6a19\"\n                                           value=\"${route.destination || ''}\" \n                                           required>\n                                    <div class=\"address-suggestions\" id=\"destination_${dayIndex}_suggestions\"><\/div>\n                                <\/div>\n                            <\/div>\n                        <\/div>\n                        \n                        <div class=\"form-group\">\n                            <label>\u9810\u6392\u505c\u9760\u9ede\uff08\u9078\u586b\uff0c\u6700\u591a${maxStops}\u500b\uff09<\/label>\n                            <div class=\"stops-container\" id=\"stops-container-${dayIndex}\"><\/div>\n                            <button type=\"button\" class=\"btn-add-stop\" data-day=\"${dayIndex}\">\n                                + \u65b0\u589e\u505c\u9760\u9ede\n                            <\/button>\n                        <\/div>\n                        \n                        <div class=\"mountain-alert alert-box\" id=\"mountain-alert-${dayIndex}\">\n                            <strong>\u26f0\ufe0f \u5c71\u5340\u8def\u7dda\u63d0\u9192\uff1a<\/strong>\n                            \u7cfb\u7d71\u5075\u6e2c\u5230\u53ef\u80fd\u5305\u542b\u5c71\u5340\u8def\u7dda\uff0c\u5c07\u81ea\u52d5\u52a0\u6536\u5c71\u5340\u670d\u52d9\u8cbb NT$1,000\/\u65e5\u3002\n                        <\/div>\n                        \n                        <div class=\"excluded-alert alert-box\" id=\"excluded-alert-${dayIndex}\">\n                            <strong>\u274c \u670d\u52d9\u7bc4\u570d\u63d0\u9192\uff1a<\/strong>\n                            <span class=\"excluded-message\"><\/span>\n                        <\/div>\n                    <\/div>\n                `;\n            },\n            \n            \/**\n             * \u66f4\u65b0\u53f8\u6a5f\u5340\u584a\n             *\/\n            updateDriverSection() {\n                const app = NineOVanCharterApp;\n                const tripDays = parseInt(app.elements.tripDays.val()) || 1;\n                const isMultiDay = tripDays > 1;\n                \n                let html = '';\n                \n                \/\/ \u591a\u65e5\u884c\u7a0b\u9700\u8981\u4f4f\u5bbf\u9078\u9805\n                if (isMultiDay) {\n                    html += `\n                        <div class=\"form-group\">\n                            <label>\u53f8\u6a5f\u4f4f\u5bbf<\/label>\n                            <div class=\"radio-group\">\n                                <div class=\"radio-item\">\n                                    <input type=\"radio\" name=\"driver_accommodation\" \n                                           value=\"self\" id=\"accommodation_self\" checked>\n                                    <label for=\"accommodation_self\">\n                                        \u63d0\u4f9b\u4f4f\u5bbf\n                                        <span class=\"price\">\u7531\u5ba2\u6236\u5b89\u6392<\/span>\n                                    <\/label>\n                                <\/div>\n                                <div class=\"radio-item\">\n                                    <input type=\"radio\" name=\"driver_accommodation\" \n                                           value=\"book\" id=\"accommodation_book\">\n                                    <label for=\"accommodation_book\">\n                                        \u4ee3\u8a02\u4f4f\u5bbf\n                                        <span class=\"price\">+2,000\/\u665a<\/span>\n                                    <\/label>\n                                <\/div>\n                            <\/div>\n                        <\/div>\n                    `;\n                } else {\n                    html += '<input type=\"hidden\" name=\"driver_accommodation\" value=\"self\">';\n                }\n                \n                \/\/ \u7528\u9910\u9078\u9805\n                html += `\n                    <div class=\"form-group\">\n                        <label>\u53f8\u6a5f\u7528\u9910<\/label>\n                        <div class=\"radio-group\">\n                            <div class=\"radio-item\">\n                                <input type=\"radio\" name=\"driver_meals\" \n                                       value=\"provided\" id=\"meals_provided\" checked>\n                                <label for=\"meals_provided\">\n                                    \u63d0\u4f9b\u9910\u9ede\n                                    <span class=\"price\">\u7531\u5ba2\u6236\u5b89\u6392<\/span>\n                                <\/label>\n                            <\/div>\n                            <div class=\"radio-item\">\n                                <input type=\"radio\" name=\"driver_meals\" \n                                       value=\"allowance\" id=\"meals_allowance\">\n                                <label for=\"meals_allowance\">\n                                    \u9910\u8cbb\u88dc\u8cbc\n                                    <span class=\"price\">+400\/\u65e5<\/span>\n                                <\/label>\n                            <\/div>\n                        <\/div>\n                    <\/div>\n                `;\n                \n                app.elements.driverOptions.html(html);\n                \n                \/\/ \u66f4\u65b0radio\u6a23\u5f0f\n                this.updateRadioStyles();\n            },\n            \n            \/**\n             * \u66f4\u65b0\u65e5\u671f\u986f\u793a\n             *\/\n            updateDayDates() {\n                const app = NineOVanCharterApp;\n                const startDate = app.elements.startDate.val();\n                if (!startDate) return;\n                \n                const days = parseInt(app.elements.tripDays.val()) || 1;\n                const start = new Date(startDate);\n                \n                for (let i = 0; i < days; i++) {\n                    const dayDate = new Date(start);\n                    dayDate.setDate(start.getDate() + i);\n                    \n                    const dateStr = dayDate.toLocaleDateString('zh-TW', {\n                        month: 'short',\n                        day: 'numeric',\n                        weekday: 'short'\n                    });\n                    \n                    $(`#day-date-${i}`).text(dateStr);\n                }\n            },\n            \n            \/**\n             * \u66f4\u65b0Radio\u6a23\u5f0f\n             *\/\n            updateRadioStyles() {\n                $('.radio-item input[type=\"radio\"]:checked')\n                    .closest('.radio-item')\n                    .addClass('selected');\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u8def\u7dda\u7ba1\u7406\u6a21\u7d44\n        \/\/ ====================================\n        RouteManager: {\n            \/**\n             * \u65b0\u589e\u505c\u9760\u9ede\n             *\/\n            addStop(dayIndex, address = '') {\n                const app = NineOVanCharterApp;\n                const container = $(`#stops-container-${dayIndex}`);\n                const stopCount = container.find('.stop-item').length;\n                const maxStops = app.config.maxStops || 6;\n                \n                if (stopCount >= maxStops) {\n                    alert(`\u6bcf\u65e5\u6700\u591a\u53ea\u80fd\u65b0\u589e${maxStops}\u500b\u505c\u9760\u9ede`);\n                    return;\n                }\n                \n                const stopId = `stop_${dayIndex}_${stopCount}`;\n                const stopHTML = `\n                    <div class=\"stop-item\" data-index=\"${stopCount}\" data-day=\"${dayIndex}\">\n                        <div class=\"address-input-wrapper\" style=\"flex: 1;\">\n                            <input type=\"text\" \n                                   id=\"${stopId}\" \n                                   class=\"address-autocomplete stop-input\"\n                                   placeholder=\"\u505c\u9760\u9ede ${stopCount + 1}\" \n                                   value=\"${address}\">\n                            <div class=\"address-suggestions\" id=\"${stopId}_suggestions\"><\/div>\n                        <\/div>\n                        <div class=\"stop-controls\">\n                            <button type=\"button\" class=\"stop-btn\" data-action=\"up\" \n                                    data-day=\"${dayIndex}\" ${stopCount === 0 ? 'disabled' : ''}>\u2191<\/button>\n                            <button type=\"button\" class=\"stop-btn\" data-action=\"down\" \n                                    data-day=\"${dayIndex}\" disabled>\u2193<\/button>\n                            <button type=\"button\" class=\"stop-btn delete\" \n                                    data-action=\"delete\" data-day=\"${dayIndex}\">\u00d7<\/button>\n                        <\/div>\n                    <\/div>\n                `;\n                \n                container.append(stopHTML);\n                this.updateStopButtons(dayIndex);\n                app.AddressAutocomplete.initInput(stopId);\n            },\n            \n            \/**\n             * \u66f4\u65b0\u505c\u9760\u9ede\u6309\u9215\u72c0\u614b\n             *\/\n            updateStopButtons(dayIndex) {\n                const items = $(`#stops-container-${dayIndex} .stop-item`);\n                \n                items.each(function(index) {\n                    const $item = $(this);\n                    $item.attr('data-index', index);\n                    $item.find('.stop-input').attr('placeholder', `\u505c\u9760\u9ede ${index + 1}`);\n                    \n                    const $upBtn = $item.find('[data-action=\"up\"]');\n                    const $downBtn = $item.find('[data-action=\"down\"]');\n                    \n                    $upBtn.prop('disabled', index === 0);\n                    $downBtn.prop('disabled', index === items.length - 1);\n                });\n            },\n            \n            \/**\n             * \u6536\u96c6\u6240\u6709\u8def\u7dda\u8cc7\u6599\n             *\/\n            collectRoutesData() {\n                const app = NineOVanCharterApp;\n                const tripDays = parseInt(app.elements.tripDays.val()) || 1;\n                const dailyRoutes = [];\n                \n                for (let i = 0; i < tripDays; i++) {\n                    const stops = [];\n                    $(`#stops-container-${i} .stop-input`).each(function() {\n                        const val = $(this).val().trim();\n                        if (val) stops.push(val);\n                    });\n                    \n                    dailyRoutes.push({\n                        origin: $(`#origin_${i}`).val() || '',\n                        destination: $(`#destination_${i}`).val() || '',\n                        stops: stops\n                    });\n                }\n                \n                app.state.dailyRoutes = dailyRoutes;\n                return dailyRoutes;\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u5730\u5740\u81ea\u52d5\u5b8c\u6210\u6a21\u7d44\n        \/\/ ====================================\n        AddressAutocomplete: {\n            \/**\n             * \u521d\u59cb\u5316\n             *\/\n            init() {\n                \/\/ \u521d\u59cb\u5316\u6240\u6709\u73fe\u6709\u7684\u5730\u5740\u8f38\u5165\n                this.initAll();\n            },\n            \n            \/**\n             * \u521d\u59cb\u5316\u6240\u6709\u5730\u5740\u8f38\u5165\n             *\/\n            initAll() {\n                const self = this;\n                $('.address-autocomplete').each(function() {\n                    self.initInput(this.id);\n                });\n            },\n            \n            \/**\n             * \u521d\u59cb\u5316\u55ae\u500b\u8f38\u5165\n             *\/\n            initInput(inputId) {\n                const app = NineOVanCharterApp;\n                const $input = $(`#${inputId}`);\n                const $suggestions = $(`#${inputId}_suggestions`);\n                let debounceTimer;\n                \n                \/\/ \u79fb\u9664\u820a\u7684\u4e8b\u4ef6\n                $input.off('input blur');\n                \n                \/\/ \u8f38\u5165\u4e8b\u4ef6\n                $input.on('input', function() {\n                    clearTimeout(debounceTimer);\n                    const value = $(this).val();\n                    \n                    if (value.length < 2) {\n                        $suggestions.removeClass('show').empty();\n                        return;\n                    }\n                    \n                    debounceTimer = setTimeout(() => {\n                        app.AddressAutocomplete.fetchSuggestions(value, $suggestions);\n                    }, 300);\n                });\n                \n                \/\/ \u5931\u7126\u4e8b\u4ef6\n                $input.on('blur', function() {\n                    const address = $(this).val();\n                    if (address) {\n                        app.AddressAutocomplete.validateAddress(address, $(this));\n                    }\n                    \n                    setTimeout(() => {\n                        $suggestions.removeClass('show');\n                    }, 200);\n                });\n                \n                \/\/ \u9078\u64c7\u5efa\u8b70\n                $suggestions.off('click').on('click', '.suggestion-item', function() {\n                    const address = $(this).data('description');\n                    $input.val(address);\n                    $suggestions.removeClass('show');\n                    app.AddressAutocomplete.validateAddress(address, $input);\n                    app.PriceCalculator.debounceCalc();\n                });\n            },\n            \n            \/**\n             * \u53d6\u5f97\u5730\u5740\u5efa\u8b70\n             *\/\n            fetchSuggestions(input, $container) {\n                const app = NineOVanCharterApp;\n                \n                $.post(app.config.ajaxUrl, {\n                    action: 'autocomplete_address',\n                    input: input\n                }).done(response => {\n                    if (response.success && response.data) {\n                        const html = response.data.map(s => `\n                            <div class=\"suggestion-item\" data-description=\"${s.description}\">\n                                <div class=\"suggestion-main\">${s.main_text || s.description}<\/div>\n                                ${s.secondary_text ? `<div class=\"suggestion-secondary\">${s.secondary_text}<\/div>` : ''}\n                            <\/div>\n                        `).join('');\n                        \n                        $container.html(html).addClass('show');\n                    } else {\n                        $container.removeClass('show');\n                    }\n                }).fail(() => {\n                    $container.removeClass('show');\n                });\n            },\n            \n            \/**\n             * \u9a57\u8b49\u5730\u5740\n             *\/\n            validateAddress(address, $input) {\n                const app = NineOVanCharterApp;\n                \n                $.post(app.config.ajaxUrl, {\n                    action: 'validate_address',\n                    address: address\n                }).done(response => {\n                    if (response.success && response.data) {\n                        const dayIndex = this.getDayIndex($input);\n                        if (dayIndex === -1) return;\n                        \n                        \/\/ \u66f4\u65b0\u5c71\u5340\u63d0\u9192\n                        const $mountainAlert = $(`#mountain-alert-${dayIndex}`);\n                        if (response.data.is_mountain && response.data.mountain_confidence > 70) {\n                            $mountainAlert.addClass('show');\n                        }\n                        \n                        \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5340\n                        if (response.data.is_excluded) {\n                            const $excludedAlert = $(`#excluded-alert-${dayIndex}`);\n                            $excludedAlert.find('.excluded-message')\n                                .text(response.data.excluded_reason || '\u6b64\u5730\u5340\u4e0d\u5728\u670d\u52d9\u7bc4\u570d\u5167');\n                            $excludedAlert.addClass('show');\n                        }\n                        \n                        app.PriceCalculator.debounceCalc();\n                    }\n                });\n            },\n            \n            \/**\n             * \u53d6\u5f97\u65e5\u671f\u7d22\u5f15\n             *\/\n            getDayIndex($input) {\n                const id = $input.attr('id');\n                const match = id.match(\/_(\\d+)(?:_\\d+)?$\/);\n                return match ? parseInt(match[1]) : -1;\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u50f9\u683c\u8a08\u7b97\u6a21\u7d44\n        \/\/ ====================================\n        PriceCalculator: {\n            \/**\n             * \u521d\u59cb\u5316\n             *\/\n            init() {\n                \/\/ \u521d\u59cb\u5316\u50f9\u683c\u9762\u677f\n                this.initPricePanel();\n            },\n            \n            \/**\n             * \u521d\u59cb\u5316\u50f9\u683c\u9762\u677f\n             *\/\n            initPricePanel() {\n                const app = NineOVanCharterApp;\n                if (app.elements.pricePanel.length) {\n                    app.elements.pricePanel.find('.price-content')\n                        .html('<div class=\"price-loading\">\u8acb\u9078\u64c7\u884c\u7a0b...<\/div>');\n                }\n            },\n            \n            \/**\n             * \u9632\u6296\u8a08\u7b97\n             *\/\n            debounceCalc() {\n                const app = NineOVanCharterApp;\n                clearTimeout(app.state.calcTimeout);\n                app.state.calcTimeout = setTimeout(() => {\n                    this.calculate();\n                }, 500);\n            },\n            \n            \/**\n             * \u8a08\u7b97\u50f9\u683c\n             *\/\n            calculate() {\n                const app = NineOVanCharterApp;\n                \n                \/\/ \u6536\u96c6\u8def\u7dda\u8cc7\u6599\n                const dailyRoutes = app.RouteManager.collectRoutesData();\n                \n                \/\/ \u986f\u793a\u8f09\u5165\u4e2d\n                if (app.elements.pricePanel.length) {\n                    app.elements.pricePanel.find('.price-content')\n                        .html('<div class=\"price-loading\">\u8a08\u7b97\u4e2d...<\/div>');\n                }\n                \n                \/\/ \u6536\u96c6\u8868\u55ae\u8cc7\u6599\n                const formData = app.elements.form.serialize();\n                \n                \/\/ AJAX \u8acb\u6c42\n                $.post(app.config.ajaxUrl, \n                    formData + \n                    '&action=calculate_charter_price' +\n                    '&daily_routes=' + encodeURIComponent(JSON.stringify(dailyRoutes))\n                ).done(response => {\n                    if (response?.success && response.data) {\n                        this.displayPrice(response.data);\n                        app.state.lastCalculation = response.data;\n                        app.state.mountainDetection = response.data.breakdown?.mountain_detection || {};\n                    } else {\n                        this.showError('\u8a08\u7b97\u5931\u6557');\n                    }\n                }).fail(() => {\n                    this.showError('\u7cfb\u7d71\u932f\u8aa4');\n                });\n            },\n            \n            \/**\n             * \u986f\u793a\u50f9\u683c\n             *\/\n            displayPrice(data) {\n                const app = NineOVanCharterApp;\n                if (!app.elements.pricePanel.length) return;\n                \n                const breakdown = data.breakdown || {};\n                let html = '';\n                \n                \/\/ \u57fa\u672c\u8cbb\u7528\n                if (breakdown.base_price > 0) {\n                    html += `\n                        <div class=\"price-item\">\n                            <span>\u57fa\u672c\u8cbb\u7528 (${data.trip_days}\u5929)<\/span>\n                            <span>NT$ ${breakdown.base_price.toLocaleString()}<\/span>\n                        <\/div>\n                    `;\n                    \n                    \/\/ \u6bcf\u65e5\u8cbb\u7387\u7d30\u7bc0\n                    if (breakdown.daily_rates) {\n                        Object.entries(breakdown.daily_rates).forEach(([day, rate]) => {\n                            html += `\n                                <div class=\"price-item detail\">\n                                    <span>Day ${day}<\/span>\n                                    <span>NT$ ${rate.toLocaleString()}<\/span>\n                                <\/div>\n                            `;\n                        });\n                    }\n                    \n                    \/\/ \u5730\u5340\u50f9\u683c\n                    if (breakdown.is_south) {\n                        html += `\n                            <div class=\"price-region south\">\n                                \u5609\u7fa9\u4ee5\u5357\/\u82b1\u6771 NT$14,000\/\u65e5\n                            <\/div>\n                        `;\n                    } else {\n                        html += `\n                            <div class=\"price-region\">\n                                \u5609\u7fa9\u4ee5\u5317\/\u5b9c\u862d NT$12,000\/\u65e5\n                            <\/div>\n                        `;\n                    }\n                }\n                \n                \/\/ \u5c71\u5340\u52a0\u50f9\n                if (breakdown.mountain_surcharge > 0) {\n                    html += `\n                        <div class=\"price-item mountain\">\n                            <span>\u26f0\ufe0f \u5c71\u5340\u670d\u52d9\u8cbb<\/span>\n                            <span>NT$ ${breakdown.mountain_surcharge.toLocaleString()}<\/span>\n                        <\/div>\n                    `;\n                    \n                    if (breakdown.mountain_days) {\n                        breakdown.mountain_days.forEach(mountain => {\n                            html += `\n                                <div class=\"price-item detail\">\n                                    <span>Day ${mountain.day} \u5c71\u5340\u884c\u7a0b<\/span>\n                                    <span>\u6d77\u62d4 ${mountain.elevation}\u516c\u5c3a<\/span>\n                                <\/div>\n                            `;\n                        });\n                    }\n                }\n                \n                \/\/ \u53f8\u6a5f\u88dc\u8cbc\n                if (breakdown.driver_allowance > 0) {\n                    html += `\n                        <div class=\"price-item\">\n                            <span>\u53f8\u6a5f\u88dc\u8cbc<\/span>\n                            <span>NT$ ${breakdown.driver_allowance.toLocaleString()}<\/span>\n                        <\/div>\n                    `;\n                }\n                \n                \/\/ \u52a0\u8cfc\u9805\u76ee\n                if (breakdown.addon_charge > 0) {\n                    html += `\n                        <div class=\"price-item\">\n                            <span>\u52a0\u8cfc\u9805\u76ee<\/span>\n                            <span>NT$ ${breakdown.addon_charge.toLocaleString()}<\/span>\n                        <\/div>\n                    `;\n                }\n                \n                \/\/ \u7e3d\u8a08\n                html += `\n                    <div class=\"price-total\">\n                        <span>\u7e3d\u8a08(\u542b\u7a05)<\/span>\n                        <span>NT$ ${(data.total || 0).toLocaleString()}<\/span>\n                    <\/div>\n                `;\n                \n                \/\/ \u8a02\u91d1\u8cc7\u8a0a\n                if (data.deposit && data.balance) {\n                    html += `\n                        <div class=\"deposit-info\">\n                            <div class=\"deposit-item\">\n                                <span>\u8a02\u91d1 (30%)<\/span>\n                                <span style=\"color: var(--danger); font-weight: bold;\">\n                                    NT$ ${data.deposit.toLocaleString()}\n                                <\/span>\n                            <\/div>\n                            <div class=\"deposit-item\">\n                                <span>\u5c3e\u6b3e (70%)<\/span>\n                                <span>NT$ ${data.balance.toLocaleString()}<\/span>\n                            <\/div>\n                        <\/div>\n                    `;\n                }\n                \n                \/\/ \u63d0\u9192\u4e8b\u9805\n                if (breakdown.mountain_needs_check) {\n                    html += `\n                        <div class=\"notice-box\">\n                            <strong>\u63d0\u9192\uff1a<\/strong>\u60a8\u7684\u884c\u7a0b\u53ef\u80fd\u5305\u542b\u5c71\u5340\u8def\u7dda\uff0c\n                            \u6211\u5011\u5c07\u5728\u78ba\u8a8d\u5f8c\u544a\u77e5\u662f\u5426\u9700\u8981\u984d\u5916\u7684\u5c71\u5340\u670d\u52d9\u8cbb\u3002\n                        <\/div>\n                    `;\n                }\n                \n                app.elements.pricePanel.find('.price-content').html(html);\n            },\n            \n            \/**\n             * \u986f\u793a\u932f\u8aa4\n             *\/\n            showError(message) {\n                const app = NineOVanCharterApp;\n                if (app.elements.pricePanel.length) {\n                    app.elements.pricePanel.find('.price-content')\n                        .html(`<div class=\"price-error\">${message}<\/div>`);\n                }\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u8868\u55ae\u9a57\u8b49\u6a21\u7d44\n        \/\/ ====================================\n        FormValidator: {\n            \/**\n             * \u521d\u59cb\u5316\n             *\/\n            init() {\n                this.setupValidators();\n            },\n            \n            \/**\n             * \u8a2d\u7f6e\u9a57\u8b49\u5668\n             *\/\n            setupValidators() {\n                const app = NineOVanCharterApp;\n                \n                \/\/ \u96fb\u8a71\u9a57\u8b49\n                app.state.validators.phone = (value) => {\n                    const phone = value.replace(\/[^0-9+]\/g, '');\n                    return \/^(\\+[0-9]{1,4})?[0-9]{9,15}$\/.test(phone);\n                };\n                \n                \/\/ Email\u9a57\u8b49\n                app.state.validators.email = (value) => {\n                    if (!value) return true; \/\/ \u9078\u586b\n                    return \/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$\/.test(value);\n                };\n                \n                \/\/ \u65e5\u671f\u9a57\u8b49\n                app.state.validators.date = (value) => {\n                    const date = new Date(value);\n                    const minDate = new Date(app.config.minDate);\n                    return date >= minDate;\n                };\n            },\n            \n            \/**\n             * \u9a57\u8b49\u8868\u55ae\n             *\/\n            validateForm() {\n                const app = NineOVanCharterApp;\n                const form = app.elements.form[0];\n                \n                \/\/ \u4f7f\u7528HTML5\u9a57\u8b49\n                if (!form.checkValidity()) {\n                    form.reportValidity();\n                    return false;\n                }\n                \n                \/\/ \u81ea\u5b9a\u7fa9\u9a57\u8b49\n                const errors = [];\n                \n                \/\/ \u9a57\u8b49\u96fb\u8a71\n                const phone = app.elements.customerPhone.val();\n                if (!app.state.validators.phone(phone)) {\n                    errors.push('\u8acb\u8f38\u5165\u6709\u6548\u7684\u96fb\u8a71\u865f\u78bc');\n                }\n                \n                \/\/ \u9a57\u8b49Email\n                const email = app.elements.customerEmail.val();\n                if (email && !app.state.validators.email(email)) {\n                    errors.push('\u8acb\u8f38\u5165\u6709\u6548\u7684Email\u5730\u5740');\n                }\n                \n                \/\/ \u6aa2\u67e5\u6392\u9664\u5730\u5740\n                if ($('.excluded-alert.show').length > 0) {\n                    errors.push('\u60a8\u7684\u884c\u7a0b\u5305\u542b\u4e0d\u63d0\u4f9b\u670d\u52d9\u7684\u5730\u5340');\n                }\n                \n                if (errors.length > 0) {\n                    alert(errors.join('\\n'));\n                    return false;\n                }\n                \n                return true;\n            }\n        },\n        \n        \/\/ ====================================\n        \/\/ \u4e8b\u4ef6\u8655\u7406\u6a21\u7d44\n        \/\/ ====================================\n        EventHandler: {\n            \/**\n             * \u521d\u59cb\u5316\n             *\/\n            init() {\n                this.bindEvents();\n            },\n            \n            \/**\n             * \u7d81\u5b9a\u4e8b\u4ef6\n             *\/\n            bindEvents() {\n                const app = NineOVanCharterApp;\n                \n                \/\/ \u4f7f\u7528\u4e8b\u4ef6\u59d4\u6d3e\n                $(document)\n                    \/\/ \u8868\u55ae\u6b04\u4f4d\u8b8a\u66f4\n                    .on('change', '#trip_days', () => {\n                        app.state.tripDays = parseInt(app.elements.tripDays.val());\n                        app.FormBuilder.updateDailyRoutes();\n                        app.FormBuilder.updateDriverSection();\n                        app.PriceCalculator.debounceCalc();\n                    })\n                    .on('change', '#start_date', () => {\n                        app.FormBuilder.updateDayDates();\n                        app.PriceCalculator.debounceCalc();\n                    })\n                    .on('change', '#passengers, #child_seats, #booster_seats, [name^=\"driver_\"]', () => {\n                        app.PriceCalculator.debounceCalc();\n                    })\n                    \n                    \/\/ \u505c\u9760\u9ede\u64cd\u4f5c\n                    .on('click', '.btn-add-stop', function() {\n                        app.RouteManager.addStop($(this).data('day'));\n                    })\n                    .on('click', '.stop-btn', function() {\n                        const $btn = $(this);\n                        const action = $btn.data('action');\n                        const dayIndex = $btn.data('day');\n                        const $item = $btn.closest('.stop-item');\n                        const itemIndex = $item.index();\n                        \n                        if (action === 'delete') {\n                            $item.fadeOut(200, function() {\n                                $(this).remove();\n                                app.RouteManager.updateStopButtons(dayIndex);\n                                app.PriceCalculator.debounceCalc();\n                            });\n                        } else if (action === 'up' && itemIndex > 0) {\n                            $item.insertBefore($item.prev());\n                            app.RouteManager.updateStopButtons(dayIndex);\n                        } else if (action === 'down' && itemIndex < $item.siblings().length) {\n                            $item.insertAfter($item.next());\n                            app.RouteManager.updateStopButtons(dayIndex);\n                        }\n                    })\n                    \n                    \/\/ Radio \u6a23\u5f0f\n                    .on('change', '.radio-item input[type=\"radio\"]', function() {\n                        const name = $(this).attr('name');\n                        $(`.radio-item input[name=\"${name}\"]`)\n                            .closest('.radio-item')\n                            .removeClass('selected');\n                        $(this).closest('.radio-item').addClass('selected');\n                    });\n                \n                \/\/ \u8868\u55ae\u63d0\u4ea4\n                app.elements.form.on('submit', function(e) {\n                    e.preventDefault();\n                    app.submitBooking();\n                });\n            }\n        },\n        \n        \/**\n         * \u63d0\u4ea4\u9810\u7d04\n         *\/\n        submitBooking() {\n            if (this.state.isSubmitting) return;\n            \n            \/\/ \u9a57\u8b49\u8868\u55ae\n            if (!this.FormValidator.validateForm()) {\n                return;\n            }\n            \n            this.state.isSubmitting = true;\n            this.elements.submitBtn\n                .prop('disabled', true)\n                .html('<span class=\"spinner\"><\/span> \u8655\u7406\u4e2d...');\n            \n            \/\/ \u6536\u96c6\u8cc7\u6599\n            const dailyRoutes = this.RouteManager.collectRoutesData();\n            const formData = this.elements.form.serialize();\n            \n            \/\/ \u63d0\u4ea4\n            $.post(this.config.ajaxUrl,\n                formData + \n                '&action=submit_charter_booking' +\n                '&daily_routes=' + encodeURIComponent(JSON.stringify(dailyRoutes)) +\n                '&total_price=' + (this.state.lastCalculation?.total || 0) +\n                '&deposit=' + (this.state.lastCalculation?.deposit || 0) +\n                '&mountain_detection=' + encodeURIComponent(JSON.stringify(this.state.mountainDetection))\n            ).done(res => {\n                if (res?.success) {\n                    let message = res.data?.message || '\u9810\u7d04\u6210\u529f\uff01\u8acb\u7acb\u5373\u652f\u4ed8\u8a02\u91d1\uff0c\u6211\u5011\u5c07\u572824\u5c0f\u6642\u5167\u8207\u60a8\u806f\u7e6b\u78ba\u8a8d\u3002';\n                    \n                    if (!this.elements.customerEmail.val()) {\n                        message += '\\n\\n\u63d0\u9192\uff1a\u60a8\u672a\u586b\u5beb Email\uff0c\u5c07\u7121\u6cd5\u6536\u5230\u9810\u7d04\u78ba\u8a8d\u4fe1\u3002';\n                    }\n                    \n                    alert(message);\n                    \n                    \/\/ \u91cd\u7f6e\u8868\u55ae\n                    this.resetForm();\n                } else {\n                    alert(res?.data?.message || '\u9810\u7d04\u5931\u6557\uff0c\u8acb\u6aa2\u67e5\u6240\u6709\u5fc5\u586b\u6b04\u4f4d');\n                }\n            }).fail(() => {\n                alert('\u7cfb\u7d71\u932f\u8aa4\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66');\n            }).always(() => {\n                this.state.isSubmitting = false;\n                this.elements.submitBtn\n                    .prop('disabled', false)\n                    .text('\u63d0\u4ea4\u9810\u7d04');\n            });\n        },\n        \n        \/**\n         * \u91cd\u7f6e\u8868\u55ae\n         *\/\n        resetForm() {\n            this.elements.form[0].reset();\n            this.state = {\n                tripDays: 1,\n                dailyRoutes: [],\n                isSubmitting: false,\n                lastCalculation: null,\n                mountainDetection: {},\n                calcTimeout: null,\n                initialized: true\n            };\n            this.FormBuilder.updateDailyRoutes();\n            this.FormBuilder.updateDriverSection();\n            this.PriceCalculator.calculate();\n        }\n    };\n    \n    \/\/ ====================================\n    \/\/ jQuery \u6587\u6a94\u5c31\u7dd2\n    \/\/ ====================================\n    $(document).ready(function() {\n        \/\/ \u521d\u59cb\u5316\u61c9\u7528\u7a0b\u5f0f\n        if (window.CharterFormConfig) {\n            NineOVanCharterApp.init(window.CharterFormConfig);\n        } else {\n            \/\/ \u5ef6\u9072\u521d\u59cb\u5316\u7b49\u5f85\u914d\u7f6e\n            setTimeout(() => {\n                if (window.CharterFormConfig) {\n                    NineOVanCharterApp.init(window.CharterFormConfig);\n                }\n            }, 100);\n        }\n    });\n    \n    \/\/ \u66b4\u9732\u5230\u5168\u57df\uff08\u5982\u679c\u9700\u8981\uff09\n    window.NineOVanCharterApp = NineOVanCharterApp;\n    \n})(window, document, jQuery);","scope":"site-footer-js","active":true,"priority":27,"modified":"2025-09-14 14:46:45","revision":"1"}]}