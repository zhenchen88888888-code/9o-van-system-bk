{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":89,"name":"14-Airport-Validator","code":"\/**\n * ============================================================================\n * Snippet: 14-Airport-Validator\n * Title: \u6a5f\u5834\u63a5\u9001\u8cc7\u6599\u9a57\u8b49\u5668\n * Description: \u63d0\u4f9b\u5b8c\u6574\u7684\u8cc7\u6599\u9a57\u8b49\u8207\u932f\u8aa4\u8655\u7406\u6a5f\u5236\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 14\n * Dependencies: 00-Global-Constants, 03-Common-Utilities, 12-Airport-Database, 13-Airport-Calculator\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ \u6aa2\u67e5\u4f9d\u8cf4\nif (!defined('_9O_VAN_VERSION')) {\n    error_log('[14-Airport-Validator] \u932f\u8aa4\uff1a\u7f3a\u5c11\u5fc5\u8981\u7684\u5168\u57df\u5e38\u6578\u5b9a\u7fa9');\n    return;\n}\n\n\/**\n * ========================================\n * \u7e23\u5e02\u5c0d\u61c9\u8868\u8207\u914d\u7f6e\n * ========================================\n *\/\nif (!function_exists('_9o_van_get_city_mapping')) {\n    function _9o_van_get_city_mapping() {\n        return array(\n            'taipei-city' => '\u53f0\u5317\u5e02',\n            'new-taipei' => '\u65b0\u5317\u5e02',\n            'keelung' => '\u57fa\u9686\u5e02',\n            'taoyuan' => '\u6843\u5712\u5e02',\n            'yilan' => '\u5b9c\u862d\u7e23',\n            'hsinchu-city' => '\u65b0\u7af9\u5e02',\n            'hsinchu-county' => '\u65b0\u7af9\u7e23',\n            'hsinchu-area' => '\u65b0\u7af9\u5730\u5340',\n            'miaoli' => '\u82d7\u6817\u7e23',\n            'taichung' => '\u53f0\u4e2d\u5e02',\n            'changhua' => '\u5f70\u5316\u7e23',\n            'nantou' => '\u5357\u6295\u7e23',\n            'yunlin' => '\u96f2\u6797\u7e23',\n            'chiayi-city' => '\u5609\u7fa9\u5e02',\n            'chiayi-county' => '\u5609\u7fa9\u7e23',\n            'chiayi-area' => '\u5609\u7fa9\u5730\u5340',\n            'tainan' => '\u53f0\u5357\u5e02',\n            'kaohsiung' => '\u9ad8\u96c4\u5e02',\n            'pingtung' => '\u5c4f\u6771\u7e23',\n            'hualien' => '\u82b1\u84ee\u7e23',\n            'taitung' => '\u53f0\u6771\u7e23'\n        );\n    }\n}\n\n\/**\n * ========================================\n * \u4e3b\u8981\u9a57\u8b49\u51fd\u6578\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u5b8c\u6574\u7684\u6a5f\u5834\u63a5\u9001\u9810\u7d04\u8cc7\u6599\n * \n * @param array $data \u9810\u7d04\u8cc7\u6599\n * @return array ['valid' => bool, 'errors' => array, 'sanitized' => array]\n *\/\nfunction _9o_van_validate_airport_booking($data) {\n    $errors = [];\n    $sanitized = [];\n    \n    \/\/ 1. \u9a57\u8b49\u57fa\u672c\u8cc7\u6599\n    $customer_validation = _9o_van_validate_customer_info($data);\n    if (!$customer_validation['valid']) {\n        $errors = array_merge($errors, $customer_validation['errors']);\n    } else {\n        $sanitized = array_merge($sanitized, $customer_validation['sanitized']);\n    }\n    \n    \/\/ 2. \u9a57\u8b49\u670d\u52d9\u8cc7\u6599\n    $service_validation = _9o_van_validate_service_info($data);\n    if (!$service_validation['valid']) {\n        $errors = array_merge($errors, $service_validation['errors']);\n    } else {\n        $sanitized = array_merge($sanitized, $service_validation['sanitized']);\n    }\n    \n    \/\/ 3. \u9a57\u8b49\u5730\u5740\u8cc7\u6599\n    $address_validation = _9o_van_validate_address_info($data);\n    if (!$address_validation['valid']) {\n        $errors = array_merge($errors, $address_validation['errors']);\n    } else {\n        $sanitized = array_merge($sanitized, $address_validation['sanitized']);\n    }\n    \n    \/\/ 4. \u9a57\u8b49\u50f9\u683c\u8cc7\u6599\n    if (isset($data['total_price'])) {\n        $price_validation = _9o_van_validate_price($data);\n        if (!$price_validation['valid']) {\n            $errors[] = $price_validation['error'];\n        } else {\n            $sanitized['total_price'] = $price_validation['price'];\n        }\n    }\n    \n    \/\/ 5. \u6aa2\u67e5\u6642\u9593\u885d\u7a81\uff08\u5982\u679c\u9700\u8981\uff09\n    if (empty($errors) && isset($data['check_conflict']) && $data['check_conflict']) {\n        $conflict = _9o_van_check_booking_conflict($sanitized);\n        if ($conflict) {\n            $errors[] = '\u8a72\u6642\u6bb5\u5df2\u6709\u5176\u4ed6\u9810\u7d04\uff0c\u8acb\u9078\u64c7\u5176\u4ed6\u6642\u9593';\n        }\n    }\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * ========================================\n * \u5ba2\u6236\u8cc7\u6599\u9a57\u8b49\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u5ba2\u6236\u8cc7\u8a0a\n *\/\nfunction _9o_van_validate_customer_info($data) {\n    $errors = [];\n    $sanitized = [];\n    \n    \/\/ \u9a57\u8b49\u59d3\u540d\n    if (empty($data['customer_name'])) {\n        $errors[] = '\u8acb\u586b\u5beb\u59d3\u540d';\n    } else {\n        $name = sanitize_text_field($data['customer_name']);\n        if (strlen($name) < 2) {\n            $errors[] = '\u59d3\u540d\u81f3\u5c11\u9700\u89812\u500b\u5b57\u7b26';\n        } elseif (strlen($name) > 50) {\n            $errors[] = '\u59d3\u540d\u4e0d\u80fd\u8d85\u904e50\u500b\u5b57\u7b26';\n        } else {\n            $sanitized['customer_name'] = $name;\n        }\n    }\n    \n    \/\/ \u9a57\u8b49\u96fb\u8a71\uff08\u652f\u63f4\u570b\u969b\u683c\u5f0f\uff09\n    if (empty($data['customer_phone'])) {\n        $errors[] = '\u8acb\u586b\u5beb\u96fb\u8a71';\n    } else {\n        $phone = preg_replace('\/[^0-9+]\/', '', $data['customer_phone']);\n        \n        \/\/ \u53f0\u7063\u624b\u6a5f\u865f\u78bc\u683c\u5f0f\n        $tw_mobile_pattern = '\/^(09[0-9]{8}|\\\\+8869[0-9]{8})$\/';\n        \/\/ \u570b\u969b\u96fb\u8a71\u683c\u5f0f\n        $intl_pattern = '\/^\\\\+[0-9]{7,15}$\/';\n        \n        if (!preg_match($tw_mobile_pattern, $phone) && !preg_match($intl_pattern, $phone)) {\n            $errors[] = '\u8acb\u8f38\u5165\u6709\u6548\u7684\u96fb\u8a71\u865f\u78bc\uff08\u53f0\u7063\u624b\u6a5f\u6216\u570b\u969b\u683c\u5f0f\uff09';\n        } else {\n            \/\/ \u7d71\u4e00\u8f49\u63db\u70ba\u570b\u969b\u683c\u5f0f\u5132\u5b58\n            if (strpos($phone, '09') === 0) {\n                $phone = '+886' . substr($phone, 1);\n            }\n            $sanitized['customer_phone'] = $phone;\n        }\n    }\n    \n    \/\/ \u9a57\u8b49 Email\uff08\u9078\u586b\uff09\n    if (!empty($data['customer_email'])) {\n        $email = sanitize_email($data['customer_email']);\n        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {\n            $errors[] = 'Email \u683c\u5f0f\u4e0d\u6b63\u78ba';\n        } else {\n            $sanitized['customer_email'] = $email;\n        }\n    } else {\n        $sanitized['customer_email'] = '';\n    }\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * ========================================\n * \u670d\u52d9\u8cc7\u6599\u9a57\u8b49\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u670d\u52d9\u8cc7\u8a0a\n *\/\nfunction _9o_van_validate_service_info($data) {\n    $errors = [];\n    $sanitized = [];\n    \n    \/\/ \u9a57\u8b49\u6a5f\u5834\n    $valid_airports = array('TPE', 'TSA');\n    $airport = strtoupper($data['airport'] ?? '');\n    if (empty($airport)) {\n        $errors[] = '\u8acb\u9078\u64c7\u6a5f\u5834';\n    } elseif (!in_array($airport, $valid_airports)) {\n        $errors[] = '\u7121\u6548\u7684\u6a5f\u5834\u9078\u64c7';\n    } else {\n        $sanitized['airport'] = $airport;\n    }\n    \n    \/\/ \u9a57\u8b49\u76ee\u7684\u5730\u7e23\u5e02\n    $city_mapping = _9o_van_get_city_mapping();\n    $destination = $data['destination'] ?? '';\n    if (empty($destination)) {\n        $errors[] = '\u8acb\u9078\u64c7\u76ee\u7684\u5730\u7e23\u5e02';\n    } elseif (!isset($city_mapping[$destination])) {\n        $errors[] = '\u7121\u6548\u7684\u7e23\u5e02\u9078\u64c7';\n    } else {\n        $sanitized['destination'] = $destination;\n        $sanitized['destination_city'] = $city_mapping[$destination];\n    }\n    \n    \/\/ \u9a57\u8b49\u670d\u52d9\u985e\u578b\n    $valid_service_types = array('pickup', 'dropoff');\n    $service_type = $data['service_type'] ?? '';\n    if (empty($service_type)) {\n        $errors[] = '\u8acb\u9078\u64c7\u670d\u52d9\u985e\u578b';\n    } elseif (!in_array($service_type, $valid_service_types)) {\n        $errors[] = '\u7121\u6548\u7684\u670d\u52d9\u985e\u578b';\n    } else {\n        $sanitized['service_type'] = $service_type;\n    }\n    \n    \/\/ \u9a57\u8b49\u884c\u7a0b\u985e\u578b\n    $valid_trip_types = array('oneway', 'roundtrip');\n    $trip_type = $data['trip_type'] ?? 'oneway';\n    if (!in_array($trip_type, $valid_trip_types)) {\n        $errors[] = '\u7121\u6548\u7684\u884c\u7a0b\u985e\u578b';\n    } else {\n        $sanitized['trip_type'] = $trip_type;\n    }\n    \n    \/\/ \u9a57\u8b49\u65e5\u671f\n    if (empty($data['date'])) {\n        $errors[] = '\u8acb\u9078\u64c7\u65e5\u671f';\n    } else {\n        $date = sanitize_text_field($data['date']);\n        $date_obj = DateTime::createFromFormat('Y-m-d', $date);\n        \n        if (!$date_obj) {\n            $errors[] = '\u65e5\u671f\u683c\u5f0f\u4e0d\u6b63\u78ba';\n        } else {\n            $today = new DateTime();\n            $today->setTime(0, 0, 0);\n            $min_date = clone $today;\n            $min_date->modify('+2 days');\n            \n            if ($date_obj < $min_date) {\n                $errors[] = '\u9810\u7d04\u65e5\u671f\u81f3\u5c11\u9700\u8981\u63d0\u524d2\u5929';\n            } elseif ($date_obj > $today->modify('+365 days')) {\n                $errors[] = '\u9810\u7d04\u65e5\u671f\u4e0d\u80fd\u8d85\u904e\u4e00\u5e74';\n            } else {\n                $sanitized['date'] = $date;\n            }\n        }\n    }\n    \n    \/\/ \u9a57\u8b49\u6642\u9593\n    if (empty($data['time'])) {\n        $errors[] = '\u8acb\u9078\u64c7\u6642\u9593';\n    } else {\n        $time = sanitize_text_field($data['time']);\n        if (!preg_match('\/^([01][0-9]|2[0-3]):([0-5][0-9])$\/', $time)) {\n            $errors[] = '\u6642\u9593\u683c\u5f0f\u4e0d\u6b63\u78ba';\n        } else {\n            $sanitized['time'] = $time;\n        }\n    }\n    \n    \/\/ \u9a57\u8b49\u822a\u73ed\u865f\u78bc\uff08\u9078\u586b\uff09\n    if (!empty($data['flight'])) {\n        $flight = sanitize_text_field($data['flight']);\n        if (strlen($flight) > 20) {\n            $errors[] = '\u822a\u73ed\u865f\u78bc\u4e0d\u80fd\u8d85\u904e20\u500b\u5b57\u7b26';\n        } else {\n            $sanitized['flight'] = strtoupper($flight);\n        }\n    } else {\n        $sanitized['flight'] = '';\n    }\n    \n    \/\/ \u9a57\u8b49\u4e58\u5ba2\u4eba\u6578\n    $passengers = isset($data['passengers']) ? intval($data['passengers']) : 1;\n    if ($passengers < 1) {\n        $errors[] = '\u4e58\u5ba2\u4eba\u6578\u81f3\u5c11\u70ba1\u4eba';\n    } elseif ($passengers > 8) {\n        $errors[] = '\u4e58\u5ba2\u4eba\u6578\u4e0d\u80fd\u8d85\u904e8\u4eba';\n    } else {\n        $sanitized['passengers'] = $passengers;\n    }\n    \n    \/\/ \u9a57\u8b49\u52a0\u8cfc\u9805\u76ee\n    $sanitized['child_seats'] = max(0, min(4, intval($data['child_seats'] ?? 0)));\n    $sanitized['booster_seats'] = max(0, min(4, intval($data['booster_seats'] ?? 0)));\n    $sanitized['name_board'] = in_array($data['name_board'] ?? 'no', ['yes', 'no']) ? \n                                $data['name_board'] : 'no';\n    \n    \/\/ \u5982\u679c\u662f\u4f86\u56de\u7a0b\uff0c\u9a57\u8b49\u56de\u7a0b\u8cc7\u6599\n    if ($sanitized['trip_type'] === 'roundtrip') {\n        $return_validation = _9o_van_validate_return_service($data);\n        if (!$return_validation['valid']) {\n            $errors = array_merge($errors, $return_validation['errors']);\n        } else {\n            $sanitized['return_data'] = $return_validation['sanitized'];\n        }\n    }\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * \u9a57\u8b49\u56de\u7a0b\u670d\u52d9\u8cc7\u6599\n *\/\nfunction _9o_van_validate_return_service($data) {\n    $errors = [];\n    $sanitized = [];\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u65e5\u671f\n    if (empty($data['return_date'])) {\n        $errors[] = '\u8acb\u9078\u64c7\u56de\u7a0b\u65e5\u671f';\n    } else {\n        $return_date = sanitize_text_field($data['return_date']);\n        $return_date_obj = DateTime::createFromFormat('Y-m-d', $return_date);\n        \n        if (!$return_date_obj) {\n            $errors[] = '\u56de\u7a0b\u65e5\u671f\u683c\u5f0f\u4e0d\u6b63\u78ba';\n        } else {\n            \/\/ \u6aa2\u67e5\u56de\u7a0b\u65e5\u671f\u662f\u5426\u5728\u53bb\u7a0b\u4e4b\u5f8c\n            if (!empty($data['date'])) {\n                $go_date_obj = DateTime::createFromFormat('Y-m-d', $data['date']);\n                if ($return_date_obj < $go_date_obj) {\n                    $errors[] = '\u56de\u7a0b\u65e5\u671f\u4e0d\u80fd\u65e9\u65bc\u53bb\u7a0b\u65e5\u671f';\n                }\n            }\n            $sanitized['date'] = $return_date;\n        }\n    }\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u6642\u9593\n    if (empty($data['return_time'])) {\n        $errors[] = '\u8acb\u9078\u64c7\u56de\u7a0b\u6642\u9593';\n    } else {\n        $return_time = sanitize_text_field($data['return_time']);\n        if (!preg_match('\/^([01][0-9]|2[0-3]):([0-5][0-9])$\/', $return_time)) {\n            $errors[] = '\u56de\u7a0b\u6642\u9593\u683c\u5f0f\u4e0d\u6b63\u78ba';\n        } else {\n            $sanitized['time'] = $return_time;\n        }\n    }\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u822a\u73ed\uff08\u9078\u586b\uff09\n    if (!empty($data['return_flight'])) {\n        $sanitized['flight'] = strtoupper(sanitize_text_field($data['return_flight']));\n    } else {\n        $sanitized['flight'] = '';\n    }\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u4e58\u5ba2\u4eba\u6578\n    $return_passengers = isset($data['return_passengers']) ? intval($data['return_passengers']) : \n                        (isset($data['passengers']) ? intval($data['passengers']) : 1);\n    $sanitized['passengers'] = max(1, min(8, $return_passengers));\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u52a0\u8cfc\u9805\u76ee\n    $sanitized['child_seats'] = max(0, min(4, intval($data['return_child_seats'] ?? 0)));\n    $sanitized['booster_seats'] = max(0, min(4, intval($data['return_booster_seats'] ?? 0)));\n    $sanitized['name_board'] = in_array($data['return_name_board'] ?? 'no', ['yes', 'no']) ? \n                                $data['return_name_board'] : 'no';\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * ========================================\n * \u5730\u5740\u8cc7\u6599\u9a57\u8b49\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u5730\u5740\u8cc7\u8a0a\n *\/\nfunction _9o_van_validate_address_info($data) {\n    $errors = [];\n    $sanitized = [];\n    \n    $service_type = $data['service_type'] ?? '';\n    $destination = $data['destination'] ?? '';\n    $trip_type = $data['trip_type'] ?? 'oneway';\n    \n    \/\/ \u9a57\u8b49\u53bb\u7a0b\u5730\u5740\n    if ($service_type === 'pickup') {\n        \/\/ \u63a5\u6a5f\uff1a\u9a57\u8b49\u4e0b\u8eca\u5730\u5740\n        if (empty($data['dropoff_address'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u4e0b\u8eca\u5730\u5740';\n        } else {\n            $address_validation = _9o_van_validate_address_city(\n                $data['dropoff_address'], \n                $destination\n            );\n            if (!$address_validation['valid']) {\n                $errors[] = '\u4e0b\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $address_validation['message'];\n            } else {\n                $sanitized['dropoff_address'] = sanitize_text_field($data['dropoff_address']);\n            }\n        }\n        $sanitized['pickup_address'] = ''; \/\/ \u63a5\u6a5f\u4e0d\u9700\u8981\u4e0a\u8eca\u5730\u5740\n    } else {\n        \/\/ \u9001\u6a5f\uff1a\u9a57\u8b49\u4e0a\u8eca\u5730\u5740\n        if (empty($data['pickup_address'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u4e0a\u8eca\u5730\u5740';\n        } else {\n            $address_validation = _9o_van_validate_address_city(\n                $data['pickup_address'], \n                $destination\n            );\n            if (!$address_validation['valid']) {\n                $errors[] = '\u4e0a\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $address_validation['message'];\n            } else {\n                $sanitized['pickup_address'] = sanitize_text_field($data['pickup_address']);\n            }\n        }\n        $sanitized['dropoff_address'] = ''; \/\/ \u9001\u6a5f\u4e0d\u9700\u8981\u4e0b\u8eca\u5730\u5740\n    }\n    \n    \/\/ \u9a57\u8b49\u505c\u9760\u9ede\n    $stopovers = [];\n    if (!empty($data['stopovers'])) {\n        if (is_string($data['stopovers'])) {\n            $stopovers_data = json_decode(stripslashes($data['stopovers']), true);\n        } else {\n            $stopovers_data = $data['stopovers'];\n        }\n        \n        if (is_array($stopovers_data)) {\n            foreach ($stopovers_data as $i => $stop) {\n                if (!empty($stop['address'])) {\n                    $stop_address = sanitize_text_field($stop['address']);\n                    if (strlen($stop_address) > 200) {\n                        $errors[] = '\u505c\u9760\u9ede' . ($i + 1) . '\u5730\u5740\u904e\u9577';\n                    } else {\n                        $stopovers[] = array('address' => $stop_address);\n                    }\n                }\n            }\n            \n            if (count($stopovers) > 5) {\n                $errors[] = '\u505c\u9760\u9ede\u6700\u591a\u53ea\u80fd\u8a2d\u5b9a5\u500b';\n            }\n        }\n    }\n    $sanitized['stopovers'] = $stopovers;\n    \n    \/\/ \u5982\u679c\u662f\u4f86\u56de\u7a0b\uff0c\u9a57\u8b49\u56de\u7a0b\u5730\u5740\n    if ($trip_type === 'roundtrip') {\n        $return_address_validation = _9o_van_validate_return_address($data, $service_type, $destination);\n        if (!$return_address_validation['valid']) {\n            $errors = array_merge($errors, $return_address_validation['errors']);\n        } else {\n            $sanitized = array_merge($sanitized, $return_address_validation['sanitized']);\n        }\n    }\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * \u9a57\u8b49\u56de\u7a0b\u5730\u5740\n *\/\nfunction _9o_van_validate_return_address($data, $service_type, $destination) {\n    $errors = [];\n    $sanitized = [];\n    \n    \/\/ \u56de\u7a0b\u670d\u52d9\u985e\u578b\u76f8\u53cd\n    if ($service_type === 'pickup') {\n        \/\/ \u53bb\u7a0b\u63a5\u6a5f\uff0c\u56de\u7a0b\u70ba\u9001\u6a5f\n        if (empty($data['return_pickup_address'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u56de\u7a0b\u4e0a\u8eca\u5730\u5740';\n        } else {\n            $address_validation = _9o_van_validate_address_city(\n                $data['return_pickup_address'], \n                $destination\n            );\n            if (!$address_validation['valid']) {\n                $errors[] = '\u56de\u7a0b\u4e0a\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $address_validation['message'];\n            } else {\n                $sanitized['return_pickup_address'] = sanitize_text_field($data['return_pickup_address']);\n            }\n        }\n        $sanitized['return_dropoff_address'] = '';\n    } else {\n        \/\/ \u53bb\u7a0b\u9001\u6a5f\uff0c\u56de\u7a0b\u70ba\u63a5\u6a5f\n        if (empty($data['return_dropoff_address'])) {\n            $errors[] = '\u8acb\u586b\u5beb\u56de\u7a0b\u4e0b\u8eca\u5730\u5740';\n        } else {\n            $address_validation = _9o_van_validate_address_city(\n                $data['return_dropoff_address'], \n                $destination\n            );\n            if (!$address_validation['valid']) {\n                $errors[] = '\u56de\u7a0b\u4e0b\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $address_validation['message'];\n            } else {\n                $sanitized['return_dropoff_address'] = sanitize_text_field($data['return_dropoff_address']);\n            }\n        }\n        $sanitized['return_pickup_address'] = '';\n    }\n    \n    \/\/ \u9a57\u8b49\u56de\u7a0b\u505c\u9760\u9ede\n    $return_stopovers = [];\n    if (!empty($data['return_stopovers'])) {\n        if (is_string($data['return_stopovers'])) {\n            $return_stopovers_data = json_decode(stripslashes($data['return_stopovers']), true);\n        } else {\n            $return_stopovers_data = $data['return_stopovers'];\n        }\n        \n        if (is_array($return_stopovers_data)) {\n            foreach ($return_stopovers_data as $i => $stop) {\n                if (!empty($stop['address'])) {\n                    $stop_address = sanitize_text_field($stop['address']);\n                    if (strlen($stop_address) > 200) {\n                        $errors[] = '\u56de\u7a0b\u505c\u9760\u9ede' . ($i + 1) . '\u5730\u5740\u904e\u9577';\n                    } else {\n                        $return_stopovers[] = array('address' => $stop_address);\n                    }\n                }\n            }\n            \n            if (count($return_stopovers) > 5) {\n                $errors[] = '\u56de\u7a0b\u505c\u9760\u9ede\u6700\u591a\u53ea\u80fd\u8a2d\u5b9a5\u500b';\n            }\n        }\n    }\n    $sanitized['return_stopovers'] = $return_stopovers;\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'sanitized' => $sanitized\n    );\n}\n\n\/**\n * \u9a57\u8b49\u5730\u5740\u8207\u7e23\u5e02\u662f\u5426\u76f8\u7b26\n *\/\nfunction _9o_van_validate_address_city($address, $selected_city_key) {\n    $city_mapping = _9o_van_get_city_mapping();\n    \n    \/\/ \u7279\u6b8a\u8655\u7406\u65b0\u7af9\u548c\u5609\u7fa9\u5730\u5340\n    if ($selected_city_key === 'hsinchu-area') {\n        if (strpos($address, '\u65b0\u7af9\u5e02') !== false || strpos($address, '\u65b0\u7af9\u7e23') !== false) {\n            return array('valid' => true, 'city' => '\u65b0\u7af9\u5730\u5340');\n        }\n        return array('valid' => false, 'message' => '\u5730\u5740\u5fc5\u9808\u5305\u542b\u65b0\u7af9\u5e02\u6216\u65b0\u7af9\u7e23');\n    }\n    \n    if ($selected_city_key === 'chiayi-area') {\n        if (strpos($address, '\u5609\u7fa9\u5e02') !== false || strpos($address, '\u5609\u7fa9\u7e23') !== false) {\n            return array('valid' => true, 'city' => '\u5609\u7fa9\u5730\u5340');\n        }\n        return array('valid' => false, 'message' => '\u5730\u5740\u5fc5\u9808\u5305\u542b\u5609\u7fa9\u5e02\u6216\u5609\u7fa9\u7e23');\n    }\n    \n    $expected_city = isset($city_mapping[$selected_city_key]) ? $city_mapping[$selected_city_key] : '';\n    \n    if (empty($expected_city)) {\n        return array('valid' => false, 'message' => '\u7121\u6548\u7684\u7e23\u5e02\u9078\u64c7');\n    }\n    \n    if (strpos($address, $expected_city) !== false) {\n        return array('valid' => true, 'city' => $expected_city);\n    }\n    \n    \/\/ \u7279\u6b8a\u8655\u7406\uff1a\u6aa2\u67e5\u662f\u5426\u9078\u932f\u7e23\u5e02\n    if ($expected_city === '\u65b0\u7af9\u5e02' && strpos($address, '\u65b0\u7af9\u7e23') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u65b0\u7af9\u5e02\uff0c\u4f46\u5730\u5740\u70ba\u65b0\u7af9\u7e23');\n    }\n    if ($expected_city === '\u65b0\u7af9\u7e23' && strpos($address, '\u65b0\u7af9\u5e02') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u65b0\u7af9\u7e23\uff0c\u4f46\u5730\u5740\u70ba\u65b0\u7af9\u5e02');\n    }\n    if ($expected_city === '\u5609\u7fa9\u5e02' && strpos($address, '\u5609\u7fa9\u7e23') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u5609\u7fa9\u5e02\uff0c\u4f46\u5730\u5740\u70ba\u5609\u7fa9\u7e23');\n    }\n    if ($expected_city === '\u5609\u7fa9\u7e23' && strpos($address, '\u5609\u7fa9\u5e02') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u5609\u7fa9\u7e23\uff0c\u4f46\u5730\u5740\u70ba\u5609\u7fa9\u5e02');\n    }\n    \n    \/\/ \u6aa2\u67e5\u662f\u5426\u5305\u542b\u5176\u4ed6\u7e23\u5e02\n    $all_cities = array_values($city_mapping);\n    foreach ($all_cities as $city) {\n        if ($city !== $expected_city && strpos($address, $city) !== false) {\n            return array('valid' => false, 'message' => \"\u5730\u5740\u4e2d\u7684{$city}\u8207\u60a8\u9078\u64c7\u7684{$expected_city}\u4e0d\u7b26\");\n        }\n    }\n    \n    \/\/ \u6aa2\u67e5\u662f\u5426\u6709\u5305\u542b\u4efb\u4f55\u7e23\u5e02\u540d\u7a31\n    $has_any_city = false;\n    foreach ($all_cities as $city) {\n        if (strpos($address, $city) !== false) {\n            $has_any_city = true;\n            break;\n        }\n    }\n    \n    if (!$has_any_city) {\n        return array('valid' => false, 'message' => \"\u8acb\u5728\u5730\u5740\u4e2d\u5305\u542b\u7e23\u5e02\u540d\u7a31\uff08{$expected_city}\uff09\");\n    }\n    \n    return array('valid' => false, 'message' => \"\u5730\u5740\u8207\u9078\u64c7\u7684{$expected_city}\u4e0d\u7b26\");\n}\n\n\/**\n * ========================================\n * \u50f9\u683c\u9a57\u8b49\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u50f9\u683c\uff08\u9632\u6b62\u7be1\u6539\uff09\n *\/\nfunction _9o_van_validate_price($data) {\n    $submitted_price = floatval($data['total_price'] ?? 0);\n    \n    if ($submitted_price <= 0) {\n        return array(\n            'valid' => false,\n            'error' => '\u50f9\u683c\u4e0d\u80fd\u70ba\u96f6\u6216\u8ca0\u6578'\n        );\n    }\n    \n    \/\/ \u91cd\u65b0\u8a08\u7b97\u50f9\u683c\u4ee5\u9a57\u8b49\n    if (function_exists('_9o_van_calculate_airport_price')) {\n        $calculated = _9o_van_calculate_airport_price($data);\n        \n        if ($calculated && isset($calculated['total'])) {\n            $expected_price = floatval($calculated['total']);\n            \n            \/\/ \u5141\u8a31\u5c0f\u984d\u5dee\u7570\uff08\u6d6e\u9ede\u6578\u8a08\u7b97\u8aa4\u5dee\uff09\n            if (abs($submitted_price - $expected_price) > 1) {\n                return array(\n                    'valid' => false,\n                    'error' => '\u50f9\u683c\u9a57\u8b49\u5931\u6557\uff0c\u8acb\u91cd\u65b0\u8a08\u7b97'\n                );\n            }\n        }\n    }\n    \n    return array(\n        'valid' => true,\n        'price' => $submitted_price\n    );\n}\n\n\/**\n * ========================================\n * \u6642\u9593\u885d\u7a81\u6aa2\u6e2c\n * ========================================\n *\/\n\n\/**\n * \u6aa2\u67e5\u9810\u7d04\u6642\u9593\u662f\u5426\u885d\u7a81\n *\/\nfunction _9o_van_check_booking_conflict($data) {\n    if (!function_exists('_9o_van_db_get_airport_bookings')) {\n        return false;\n    }\n    \n    $service_date = $data['date'] ?? '';\n    $service_time = $data['time'] ?? '';\n    \n    if (empty($service_date) || empty($service_time)) {\n        return false;\n    }\n    \n    \/\/ \u8a08\u7b97\u6642\u9593\u7bc4\u570d\uff08\u524d\u5f8c2\u5c0f\u6642\uff09\n    $datetime = DateTime::createFromFormat('Y-m-d H:i', \"$service_date $service_time\");\n    $start_time = clone $datetime;\n    $start_time->modify('-2 hours');\n    $end_time = clone $datetime;\n    $end_time->modify('+2 hours');\n    \n    \/\/ \u67e5\u8a62\u8a72\u6642\u9593\u7bc4\u570d\u5167\u7684\u9810\u7d04\n    $existing_bookings = _9o_van_db_get_airport_bookings(array(\n        'service_date' => $service_date,\n        'status' => array('pending', 'confirmed'),\n        'exclude_id' => $data['booking_id'] ?? 0\n    ));\n    \n    if (!empty($existing_bookings)) {\n        foreach ($existing_bookings as $booking) {\n            $booking_time = DateTime::createFromFormat('Y-m-d H:i', \n                $booking->service_date . ' ' . $booking->service_time);\n            \n            if ($booking_time >= $start_time && $booking_time <= $end_time) {\n                return true; \/\/ \u6709\u885d\u7a81\n            }\n        }\n    }\n    \n    return false;\n}\n\n\/**\n * ========================================\n * \u8f14\u52a9\u9a57\u8b49\u51fd\u6578\n * ========================================\n *\/\n\n\/**\n * \u9a57\u8b49\u5099\u8a3b\n *\/\nfunction _9o_van_validate_notes($notes) {\n    if (empty($notes)) {\n        return '';\n    }\n    \n    $notes = sanitize_textarea_field($notes);\n    \n    if (strlen($notes) > 500) {\n        return array(\n            'valid' => false,\n            'error' => '\u5099\u8a3b\u4e0d\u80fd\u8d85\u904e500\u500b\u5b57\u7b26'\n        );\n    }\n    \n    return array(\n        'valid' => true,\n        'notes' => $notes\n    );\n}\n\n\/**\n * \u9a57\u8b49\u55ae\u4e00\u6b04\u4f4d\n *\/\nfunction _9o_van_validate_field($field_name, $value, $rules = array()) {\n    $errors = [];\n    $sanitized = $value;\n    \n    \/\/ \u5fc5\u586b\u6aa2\u67e5\n    if (isset($rules['required']) && $rules['required'] && empty($value)) {\n        $errors[] = $rules['label'] . '\u70ba\u5fc5\u586b\u6b04\u4f4d';\n        return array('valid' => false, 'errors' => $errors);\n    }\n    \n    \/\/ \u9577\u5ea6\u6aa2\u67e5\n    if (isset($rules['min_length']) && strlen($value) < $rules['min_length']) {\n        $errors[] = $rules['label'] . '\u81f3\u5c11\u9700\u8981' . $rules['min_length'] . '\u500b\u5b57\u7b26';\n    }\n    \n    if (isset($rules['max_length']) && strlen($value) > $rules['max_length']) {\n        $errors[] = $rules['label'] . '\u4e0d\u80fd\u8d85\u904e' . $rules['max_length'] . '\u500b\u5b57\u7b26';\n    }\n    \n    \/\/ \u6578\u5b57\u7bc4\u570d\u6aa2\u67e5\n    if (isset($rules['min']) && is_numeric($value) && $value < $rules['min']) {\n        $errors[] = $rules['label'] . '\u4e0d\u80fd\u5c0f\u65bc' . $rules['min'];\n    }\n    \n    if (isset($rules['max']) && is_numeric($value) && $value > $rules['max']) {\n        $errors[] = $rules['label'] . '\u4e0d\u80fd\u5927\u65bc' . $rules['max'];\n    }\n    \n    \/\/ \u683c\u5f0f\u6aa2\u67e5\n    if (isset($rules['pattern']) && !preg_match($rules['pattern'], $value)) {\n        $errors[] = $rules['label'] . '\u683c\u5f0f\u4e0d\u6b63\u78ba';\n    }\n    \n    \/\/ \u9078\u9805\u6aa2\u67e5\n    if (isset($rules['options']) && !in_array($value, $rules['options'])) {\n        $errors[] = $rules['label'] . '\u9078\u9805\u7121\u6548';\n    }\n    \n    return array(\n        'valid' => empty($errors),\n        'errors' => $errors,\n        'value' => $sanitized\n    );\n}\n\n\/**\n * ========================================\n * AJAX \u9a57\u8b49\u7aef\u9ede\n * ========================================\n *\/\n\n\/\/ \u8a3b\u518a AJAX \u9a57\u8b49\u7aef\u9ede\nadd_action('wp_ajax_validate_airport_field', '_9o_van_ajax_validate_field');\nadd_action('wp_ajax_nopriv_validate_airport_field', '_9o_van_ajax_validate_field');\n\n\/**\n * AJAX \u5373\u6642\u6b04\u4f4d\u9a57\u8b49\n *\/\nfunction _9o_van_ajax_validate_field() {\n    \/\/ \u9a57\u8b49 nonce\n    if (!wp_verify_nonce($_POST['nonce'] ?? '', '9o_van_ajax_nonce')) {\n        wp_send_json_error('\u5b89\u5168\u9a57\u8b49\u5931\u6557');\n    }\n    \n    $field = sanitize_text_field($_POST['field'] ?? '');\n    $value = $_POST['value'] ?? '';\n    \n    $result = array('valid' => true);\n    \n    switch ($field) {\n        case 'customer_phone':\n            $validation = _9o_van_validate_customer_info(array(\n                'customer_phone' => $value,\n                'customer_name' => 'test',\n                'customer_email' => ''\n            ));\n            if (!$validation['valid']) {\n                $result = array(\n                    'valid' => false,\n                    'message' => implode(', ', $validation['errors'])\n                );\n            }\n            break;\n            \n        case 'customer_email':\n            if (!empty($value) && !filter_var($value, FILTER_VALIDATE_EMAIL)) {\n                $result = array(\n                    'valid' => false,\n                    'message' => 'Email \u683c\u5f0f\u4e0d\u6b63\u78ba'\n                );\n            }\n            break;\n            \n        case 'address':\n            $city = $_POST['city'] ?? '';\n            if (!empty($value) && !empty($city)) {\n                $validation = _9o_van_validate_address_city($value, $city);\n                if (!$validation['valid']) {\n                    $result = array(\n                        'valid' => false,\n                        'message' => $validation['message']\n                    );\n                }\n            }\n            break;\n    }\n    \n    wp_send_json_success($result);\n}\n\n\/**\n * ========================================\n * \u932f\u8aa4\u8a0a\u606f\u683c\u5f0f\u5316\n * ========================================\n *\/\n\n\/**\n * \u683c\u5f0f\u5316\u932f\u8aa4\u8a0a\u606f\n *\/\nfunction _9o_van_format_validation_errors($errors, $format = 'html') {\n    if (empty($errors)) {\n        return '';\n    }\n    \n    if ($format === 'html') {\n        $html = '<div class=\"validation-errors\">';\n        $html .= '<ul>';\n        foreach ($errors as $error) {\n            $html .= '<li>' . esc_html($error) . '<\/li>';\n        }\n        $html .= '<\/ul>';\n        $html .= '<\/div>';\n        return $html;\n    } elseif ($format === 'text') {\n        return implode('\u3001', $errors);\n    } else {\n        return $errors;\n    }\n}\n\n\/\/ \u8a18\u9304\u9a57\u8b49\u5668\u8f09\u5165\nif (defined('_9O_VAN_DEBUG') && _9O_VAN_DEBUG) {\n    error_log('[14-Airport-Validator] \u6a21\u7d44\u5df2\u8f09\u5165 - v1.0.0');\n}","active":true,"priority":14,"modified":"2025-09-14 02:10:52","revision":"1"}]}