{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":90,"name":"15-Airport-Ajax-Handlers","code":"\/**\n * ============================================================================\n * Snippet: 15-Airport-Ajax-Handlers\n * Title: \u6a5f\u5834\u63a5\u9001 AJAX \u8655\u7406\u5668\n * Description: \u8655\u7406\u524d\u7aef\u6240\u6709 AJAX \u8acb\u6c42\uff0c\u5305\u542b\u50f9\u683c\u8a08\u7b97\u3001\u9810\u7d04\u63d0\u4ea4\u3001\u8cc7\u6599\u9a57\u8b49\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * Priority: 15\n * Dependencies: 00-Global-Constants, 04-Ajax-Security, 12-Airport-Database, 13-Airport-Calculator, 14-Airport-Validator\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/\/ Google Maps API \u8a2d\u5b9a\nif (!defined('GOOGLE_MAPS_API_KEY')) {\n    $api_key = defined('NINE_O_VAN_GOOGLE_API_KEY') \n        ? NINE_O_VAN_GOOGLE_API_KEY \n        : 'AIzaSyD7m-umnnMHhXTi11_uvI14Rel6mCN1Dz4';\n    define('GOOGLE_MAPS_API_KEY', $api_key);\n}\n\n\/\/ ========================================\n\/\/ \u7e23\u5e02\u5c0d\u61c9\u8868\n\/\/ ========================================\nfunction get_city_mapping() {\n    return array(\n        'taipei-city' => '\u53f0\u5317\u5e02',\n        'new-taipei' => '\u65b0\u5317\u5e02',\n        'keelung' => '\u57fa\u9686\u5e02',\n        'taoyuan' => '\u6843\u5712\u5e02',\n        'yilan' => '\u5b9c\u862d\u7e23',\n        'hsinchu-city' => '\u65b0\u7af9\u5e02',\n        'hsinchu-county' => '\u65b0\u7af9\u7e23',\n        'hsinchu-area' => '\u65b0\u7af9\u5730\u5340',\n        'miaoli' => '\u82d7\u6817\u7e23',\n        'taichung' => '\u53f0\u4e2d\u5e02',\n        'changhua' => '\u5f70\u5316\u7e23',\n        'nantou' => '\u5357\u6295\u7e23',\n        'yunlin' => '\u96f2\u6797\u7e23',\n        'chiayi-city' => '\u5609\u7fa9\u5e02',\n        'chiayi-county' => '\u5609\u7fa9\u7e23',\n        'chiayi-area' => '\u5609\u7fa9\u5730\u5340',\n        'tainan' => '\u53f0\u5357\u5e02',\n        'kaohsiung' => '\u9ad8\u96c4\u5e02',\n        'pingtung' => '\u5c4f\u6771\u7e23',\n        'hualien' => '\u82b1\u84ee\u7e23',\n        'taitung' => '\u53f0\u6771\u7e23'\n    );\n}\n\n\/\/ ========================================\n\/\/ \u8ddd\u96e2\u8cbb\u7528\u8a08\u7b97\u51fd\u6578\uff08\u539f\u59cb\u908f\u8f2f\uff09\n\/\/ ========================================\nfunction calculate_distance_fee($distance_km) {\n    if ($distance_km <= 1) return 0;\n    if ($distance_km <= 5) return 200;\n    if ($distance_km <= 10) return 300;\n    if ($distance_km <= 20) return 400;\n    if ($distance_km <= 30) return 600;\n    if ($distance_km <= 40) return 800;\n    if ($distance_km <= 50) return 1000;\n    return 1000 + ceil(($distance_km - 50) \/ 10) * 200;\n}\n\n\/\/ ========================================\n\/\/ Google Maps Distance Matrix \u51fd\u6578\n\/\/ ========================================\nfunction calculate_distance_google($origin, $destination) {\n    $api_key = GOOGLE_MAPS_API_KEY;\n    \n    $origin = $origin . ', \u53f0\u7063';\n    $destination = $destination . ', \u53f0\u7063';\n    \n    $url = 'https:\/\/maps.googleapis.com\/maps\/api\/distancematrix\/json';\n    $params = array(\n        'origins' => $origin,\n        'destinations' => $destination,\n        'units' => 'metric',\n        'language' => 'zh-TW',\n        'region' => 'TW',\n        'key' => $api_key\n    );\n    \n    $query_string = http_build_query($params);\n    $full_url = $url . '?' . $query_string;\n    \n    error_log('Google Maps API Request: ' . $full_url);\n    \n    $response = wp_remote_get($full_url, array('timeout' => 10));\n    \n    if (is_wp_error($response)) {\n        error_log('Google Maps API Error: ' . $response->get_error_message());\n        return estimate_distance_fallback($origin, $destination);\n    }\n    \n    $body = wp_remote_retrieve_body($response);\n    $data = json_decode($body, true);\n    \n    error_log('Google Maps API Response Status: ' . ($data['status'] ?? 'NO STATUS'));\n    \n    if ($data['status'] !== 'OK') {\n        error_log('Google Maps API Status Error: ' . $body);\n        return estimate_distance_fallback($origin, $destination);\n    }\n    \n    if (!isset($data['rows'][0]['elements'][0]['distance']['value'])) {\n        error_log('Google Maps API No Distance: ' . $body);\n        return estimate_distance_fallback($origin, $destination);\n    }\n    \n    $distance_meters = $data['rows'][0]['elements'][0]['distance']['value'];\n    $distance_km = $distance_meters \/ 1000;\n    \n    error_log('Calculated distance: ' . $distance_km . ' km');\n    \n    return $distance_km;\n}\n\n\/\/ ========================================\n\/\/ \u5099\u7528\u8ddd\u96e2\u4f30\u7b97\u51fd\u6578\n\/\/ ========================================\nfunction estimate_distance_fallback($origin, $destination) {\n    $city_distances = array(\n        '\u53f0\u5317' => array('\u65b0\u5317' => 10, '\u57fa\u9686' => 25, '\u6843\u5712' => 30, '\u65b0\u7af9' => 70, '\u53f0\u4e2d' => 165),\n        '\u6843\u5712' => array('\u53f0\u5317' => 30, '\u65b0\u5317' => 25, '\u65b0\u7af9' => 50, '\u82d7\u6817' => 80, '\u53f0\u4e2d' => 135),\n        '\u65b0\u7af9' => array('\u53f0\u5317' => 70, '\u6843\u5712' => 50, '\u82d7\u6817' => 40, '\u53f0\u4e2d' => 95),\n        '\u53f0\u4e2d' => array('\u53f0\u5317' => 165, '\u6843\u5712' => 135, '\u5f70\u5316' => 25, '\u5357\u6295' => 40),\n        '\u9ad8\u96c4' => array('\u53f0\u5317' => 350, '\u53f0\u4e2d' => 185, '\u53f0\u5357' => 45, '\u5c4f\u6771' => 30)\n    );\n    \n    $origin_city = extract_city_from_address($origin);\n    $dest_city = extract_city_from_address($destination);\n    \n    if (isset($city_distances[$origin_city][$dest_city])) {\n        return $city_distances[$origin_city][$dest_city];\n    }\n    if (isset($city_distances[$dest_city][$origin_city])) {\n        return $city_distances[$dest_city][$origin_city];\n    }\n    \n    if ($origin_city === $dest_city) {\n        return 8;\n    }\n    \n    return 15;\n}\n\n\/\/ ========================================\n\/\/ \u5f9e\u5730\u5740\u63d0\u53d6\u57ce\u5e02\u540d\n\/\/ ========================================\nfunction extract_city_from_address($address) {\n    $cities = array('\u53f0\u5317', '\u65b0\u5317', '\u57fa\u9686', '\u6843\u5712', '\u65b0\u7af9', '\u82d7\u6817', '\u53f0\u4e2d', \n                   '\u5f70\u5316', '\u5357\u6295', '\u96f2\u6797', '\u5609\u7fa9', '\u53f0\u5357', '\u9ad8\u96c4', '\u5c4f\u6771', \n                   '\u5b9c\u862d', '\u82b1\u84ee', '\u53f0\u6771');\n    \n    foreach ($cities as $city) {\n        if (strpos($address, $city) !== false) {\n            return $city;\n        }\n    }\n    \n    if (strpos($address, '\u6843\u5712\u570b\u969b\u6a5f\u5834') !== false) {\n        return '\u6843\u5712';\n    }\n    if (strpos($address, '\u677e\u5c71\u6a5f\u5834') !== false) {\n        return '\u53f0\u5317';\n    }\n    \n    return '\u53f0\u5317';\n}\n\n\/\/ ========================================\n\/\/ \u5730\u5740\u7e23\u5e02\u9a57\u8b49\u51fd\u6578\n\/\/ ========================================\nfunction validate_address_city($address, $selected_city_key) {\n    $city_mapping = get_city_mapping();\n    \n    $expected_city = isset($city_mapping[$selected_city_key]) ? $city_mapping[$selected_city_key] : '';\n    \n    if (empty($expected_city)) {\n        return array('valid' => false, 'message' => '\u7121\u6548\u7684\u7e23\u5e02\u9078\u64c7');\n    }\n    \n    if (strpos($address, $expected_city) !== false) {\n        return array('valid' => true, 'city' => $expected_city);\n    }\n    \n    \/\/ \u7279\u6b8a\u8655\u7406\uff1a\u65b0\u7af9\u5e02\/\u65b0\u7af9\u7e23\n    if ($expected_city === '\u65b0\u7af9\u5e02' && strpos($address, '\u65b0\u7af9\u7e23') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u65b0\u7af9\u5e02\uff0c\u4f46\u5730\u5740\u70ba\u65b0\u7af9\u7e23');\n    }\n    if ($expected_city === '\u65b0\u7af9\u7e23' && strpos($address, '\u65b0\u7af9\u5e02') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u65b0\u7af9\u7e23\uff0c\u4f46\u5730\u5740\u70ba\u65b0\u7af9\u5e02');\n    }\n    if ($expected_city === '\u65b0\u7af9\u5730\u5340' && (strpos($address, '\u65b0\u7af9') !== false)) {\n        return array('valid' => true, 'city' => $expected_city);\n    }\n    \n    \/\/ \u7279\u6b8a\u8655\u7406\uff1a\u5609\u7fa9\u5e02\/\u5609\u7fa9\u7e23\n    if ($expected_city === '\u5609\u7fa9\u5e02' && strpos($address, '\u5609\u7fa9\u7e23') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u5609\u7fa9\u5e02\uff0c\u4f46\u5730\u5740\u70ba\u5609\u7fa9\u7e23');\n    }\n    if ($expected_city === '\u5609\u7fa9\u7e23' && strpos($address, '\u5609\u7fa9\u5e02') !== false) {\n        return array('valid' => false, 'message' => '\u60a8\u9078\u64c7\u7684\u662f\u5609\u7fa9\u7e23\uff0c\u4f46\u5730\u5740\u70ba\u5609\u7fa9\u5e02');\n    }\n    if ($expected_city === '\u5609\u7fa9\u5730\u5340' && (strpos($address, '\u5609\u7fa9') !== false)) {\n        return array('valid' => true, 'city' => $expected_city);\n    }\n    \n    \/\/ \u6aa2\u67e5\u662f\u5426\u5305\u542b\u5176\u4ed6\u7e23\u5e02\n    $all_cities = array_values($city_mapping);\n    foreach ($all_cities as $city) {\n        if ($city !== $expected_city && strpos($address, $city) !== false) {\n            return array('valid' => false, 'message' => \"\u5730\u5740\u4e2d\u7684{$city}\u8207\u60a8\u9078\u64c7\u7684{$expected_city}\u4e0d\u7b26\");\n        }\n    }\n    \n    return array('valid' => false, 'message' => \"\u8acb\u5728\u5730\u5740\u4e2d\u5305\u542b\u7e23\u5e02\u540d\u7a31\uff08{$expected_city}\uff09\");\n}\n\n\/\/ ========================================\n\/\/ \u504f\u9060\u5730\u5340\u52a0\u50f9\u6aa2\u67e5\uff08\u7c21\u5316\u7248\uff09\n\/\/ ========================================\nfunction check_remote_area_surcharge($address) {\n    \/\/ \u9019\u88e1\u53ef\u4ee5\u4f7f\u7528 10-Airport-Settings \u7684\u51fd\u6578\n    if (function_exists('\\\\NineOVan\\\\Airport\\\\AirportSettings::check_remote_area_surcharge')) {\n        $coords = get_address_coordinates($address);\n        if ($coords) {\n            $result = \\NineOVan\\Airport\\AirportSettings::check_remote_area_surcharge($coords['lat'], $coords['lng']);\n            return $result['surcharge'];\n        }\n    }\n    return 0;\n}\n\n\/\/ ========================================\n\/\/ \u5730\u5740\u8f49\u5ea7\u6a19\n\/\/ ========================================\nfunction get_address_coordinates($address) {\n    $api_key = GOOGLE_MAPS_API_KEY;\n    $address_encoded = urlencode($address . ', \u53f0\u7063');\n    \n    $url = \"https:\/\/maps.googleapis.com\/maps\/api\/geocode\/json?address={$address_encoded}&key={$api_key}&language=zh-TW&region=TW\";\n    \n    $response = wp_remote_get($url, array('timeout' => 10));\n    \n    if (is_wp_error($response)) {\n        return false;\n    }\n    \n    $body = wp_remote_retrieve_body($response);\n    $data = json_decode($body, true);\n    \n    if ($data['status'] === 'OK' && isset($data['results'][0]['geometry']['location'])) {\n        return array(\n            'lat' => $data['results'][0]['geometry']['location']['lat'],\n            'lng' => $data['results'][0]['geometry']['location']['lng']\n        );\n    }\n    \n    return false;\n}\n\n\/\/ ========================================\n\/\/ AJAX \u50f9\u683c\u8a08\u7b97\u8655\u7406\u5668 - \u4e3b\u8981\u51fd\u6578\n\/\/ ========================================\nadd_action('wp_ajax_calculate_airport_price', 'handle_airport_price_calc');\nadd_action('wp_ajax_nopriv_calculate_airport_price', 'handle_airport_price_calc');\n\nfunction handle_airport_price_calc() {\n    try {\n        \/\/ \u57fa\u672c\u50f9\u683c\u8868\n        $price_table = array(\n            'TPE' => array(\n                '\u53f0\u5317\u5e02' => 3000,\n                '\u65b0\u5317\u5e02' => 3000,\n                '\u57fa\u9686\u5e02' => 3500,\n                '\u6843\u5712\u5e02' => 2800,\n                '\u5b9c\u862d\u7e23' => 4900,\n                '\u65b0\u7af9\u5730\u5340' => 3500,\n                '\u82d7\u6817\u7e23' => 4900,\n                '\u53f0\u4e2d\u5e02' => 6000,\n                '\u5f70\u5316\u7e23' => 7600,\n                '\u5357\u6295\u7e23' => 8500,\n                '\u96f2\u6797\u7e23' => 9400,\n                '\u5609\u7fa9\u5730\u5340' => 9800,\n                '\u53f0\u5357\u5e02' => 11000,\n                '\u9ad8\u96c4\u5e02' => 12000,\n                '\u5c4f\u6771\u7e23' => 13000,\n                '\u82b1\u84ee\u7e23' => 13000,\n                '\u53f0\u6771\u7e23' => 14000\n            ),\n            'TSA' => array(\n                '\u53f0\u5317\u5e02' => 3000,\n                '\u65b0\u5317\u5e02' => 3000,\n                '\u57fa\u9686\u5e02' => 3500,\n                '\u6843\u5712\u5e02' => 3100,\n                '\u5b9c\u862d\u7e23' => 4900,\n                '\u65b0\u7af9\u5730\u5340' => 3800,\n                '\u82d7\u6817\u7e23' => 5400,\n                '\u53f0\u4e2d\u5e02' => 6400,\n                '\u5f70\u5316\u7e23' => 8000,\n                '\u5357\u6295\u7e23' => 8900,\n                '\u96f2\u6797\u7e23' => 9800,\n                '\u5609\u7fa9\u5730\u5340' => 10300,\n                '\u53f0\u5357\u5e02' => 11500,\n                '\u9ad8\u96c4\u5e02' => 12500,\n                '\u5c4f\u6771\u7e23' => 13000,\n                '\u82b1\u84ee\u7e23' => 13000,\n                '\u53f0\u6771\u7e23' => 14000\n            )\n        );\n        \n        $city_mapping = get_city_mapping();\n        \n        $price_key_mapping = array(\n            'hsinchu-area' => '\u65b0\u7af9\u5730\u5340',\n            'chiayi-area' => '\u5609\u7fa9\u5730\u5340'\n        );\n        \n        $airport_addresses = array(\n            'TPE' => '\u6843\u5712\u570b\u969b\u6a5f\u5834',\n            'TSA' => '\u53f0\u5317\u677e\u5c71\u6a5f\u5834'\n        );\n        \n        \/\/ \u6536\u96c6\u8cc7\u6599\n        $airport = isset($_POST['airport']) ? strtoupper($_POST['airport']) : 'TPE';\n        $destination = isset($_POST['destination']) ? $_POST['destination'] : 'taipei-city';\n        $service_type = isset($_POST['service_type']) ? $_POST['service_type'] : 'pickup';\n        $trip_type = isset($_POST['trip_type']) ? $_POST['trip_type'] : 'oneway';\n        $time = isset($_POST['time']) ? $_POST['time'] : '';\n        $child_seats = isset($_POST['child_seats']) ? intval($_POST['child_seats']) : 0;\n        $booster_seats = isset($_POST['booster_seats']) ? intval($_POST['booster_seats']) : 0;\n        $name_board = isset($_POST['name_board']) ? $_POST['name_board'] : 'no';\n        \n        $pickup_address = isset($_POST['pickup_address']) ? $_POST['pickup_address'] : '';\n        $dropoff_address = isset($_POST['dropoff_address']) ? $_POST['dropoff_address'] : '';\n        \n        \/\/ \u8655\u7406\u505c\u9760\u9ede\n        $stopovers = array();\n        if (!empty($_POST['stopovers'])) {\n            $decoded = json_decode(stripslashes($_POST['stopovers']), true);\n            if (is_array($decoded)) {\n                $stopovers = $decoded;\n            }\n        }\n        \n        \/\/ \u8f49\u63db\u57ce\u5e02\u540d\u7a31\n        if (isset($price_key_mapping[$destination])) {\n            $city = $price_key_mapping[$destination];\n        } else {\n            $city = isset($city_mapping[$destination]) ? $city_mapping[$destination] : '\u53f0\u5317\u5e02';\n        }\n        $airport_address = $airport_addresses[$airport];\n        \n        \/\/ \u8a08\u7b97\u50f9\u683c\n        $breakdown = array();\n        $subtotal = 0;\n        \n        \/\/ 1. \u57fa\u672c\u8cbb\u7528\n        $base_price = isset($price_table[$airport][$city]) ? $price_table[$airport][$city] : 3000;\n        $breakdown['base_price'] = $base_price;\n        $subtotal += $base_price;\n        \n        \/\/ 2. \u591c\u9593\u52a0\u50f9\n        $night_surcharge = 0;\n        if (!empty($time)) {\n            $hour = intval(date('H', strtotime($time)));\n            if ($hour >= 22 || $hour < 8) {\n                $night_surcharge = 200;\n            }\n        }\n        $breakdown['night_surcharge'] = $night_surcharge;\n        $subtotal += $night_surcharge;\n        \n        \/\/ 3. \u504f\u9060\u5730\u5340\u52a0\u50f9\n        $remote_surcharge = 0;\n        $main_address = '';\n        \n        if ($service_type === 'pickup' && !empty($dropoff_address)) {\n            $main_address = $dropoff_address;\n        } elseif ($service_type === 'dropoff' && !empty($pickup_address)) {\n            $main_address = $pickup_address;\n        }\n        \n        if (!empty($main_address)) {\n            $remote_surcharge = check_remote_area_surcharge($main_address);\n        }\n        \n        $breakdown['remote_surcharge'] = $remote_surcharge;\n        $subtotal += $remote_surcharge;\n        \n        \/\/ 4. \u505c\u9760\u9ede\u8cbb\u7528\u8a08\u7b97\n        $stopover_charge = 0;\n        $stopover_details = array();\n        \n        if (count($stopovers) > 0) {\n            $all_points = array();\n            \n            if ($service_type === 'pickup') {\n                $all_points[] = $airport_address;\n                foreach ($stopovers as $stop) {\n                    if (!empty($stop['address'])) {\n                        $all_points[] = $stop['address'];\n                    }\n                }\n                if (!empty($dropoff_address)) {\n                    $all_points[] = $dropoff_address;\n                }\n            } else {\n                if (!empty($pickup_address)) {\n                    $all_points[] = $pickup_address;\n                }\n                foreach ($stopovers as $stop) {\n                    if (!empty($stop['address'])) {\n                        $all_points[] = $stop['address'];\n                    }\n                }\n                $all_points[] = $airport_address;\n            }\n            \n            for ($i = 0; $i < count($all_points) - 1; $i++) {\n                $from = $all_points[$i];\n                $to = $all_points[$i + 1];\n                \n                $should_charge = true;\n                if ($service_type === 'pickup' && $i === 0) {\n                    $should_charge = false;\n                } elseif ($service_type === 'dropoff' && $i === count($all_points) - 2) {\n                    $should_charge = false;\n                }\n                \n                $distance = calculate_distance_google($from, $to);\n                \n                $fee = $should_charge ? calculate_distance_fee($distance) : 0;\n                $stopover_charge += $fee;\n                \n                $from_short = mb_strlen($from) > 15 ? mb_substr($from, 0, 15) . '...' : $from;\n                $to_short = mb_strlen($to) > 15 ? mb_substr($to, 0, 15) . '...' : $to;\n                \n                $segment_name = sprintf(\"\u8def\u6bb5 %d (%s \u2192 %s)\", \n                    $i + 1, \n                    $from_short, \n                    $to_short\n                );\n                \n                $stopover_details[] = array(\n                    'segment' => $segment_name,\n                    'distance' => round($distance, 1),\n                    'fee' => $fee,\n                    'charged' => $should_charge\n                );\n            }\n        }\n        \n        $breakdown['stopover_charge'] = $stopover_charge;\n        $breakdown['stopover_details'] = $stopover_details;\n        $subtotal += $stopover_charge;\n        \n        \/\/ 5. \u52a0\u8cfc\u9805\u76ee\n        $addon_charge = ($child_seats * 100) + ($booster_seats * 100);\n        \n        \/\/ \u8209\u724c\u670d\u52d9\u8cbb\u7528\n        $name_board_charge = 0;\n        if ($name_board === 'yes') {\n            $name_board_charge = 200;\n            $addon_charge += $name_board_charge;\n        }\n        \n        $breakdown['addon_charge'] = $addon_charge;\n        $breakdown['name_board_charge'] = $name_board_charge;\n        $subtotal += $addon_charge;\n        \n        \/\/ 6. \u4f86\u56de\u7a0b\u8655\u7406\n        $total = $subtotal;\n        if ($trip_type === 'roundtrip') {\n            $return_stopovers = array();\n            if (!empty($_POST['return_stopovers'])) {\n                $decoded = json_decode(stripslashes($_POST['return_stopovers']), true);\n                if (is_array($decoded)) {\n                    $return_stopovers = $decoded;\n                }\n            }\n            \n            \/\/ \u56de\u7a0b\u504f\u9060\u5730\u5340\u52a0\u50f9\n            $return_remote_surcharge = 0;\n            $return_pickup_address = isset($_POST['return_pickup_address']) ? $_POST['return_pickup_address'] : '';\n            $return_dropoff_address = isset($_POST['return_dropoff_address']) ? $_POST['return_dropoff_address'] : '';\n            \n            $return_main_address = '';\n            \n            if ($service_type === 'pickup') {\n                if (!empty($return_pickup_address)) {\n                    $return_main_address = $return_pickup_address;\n                }\n            } else {\n                if (!empty($return_dropoff_address)) {\n                    $return_main_address = $return_dropoff_address;\n                }\n            }\n            \n            if (!empty($return_main_address)) {\n                $return_remote_surcharge = check_remote_area_surcharge($return_main_address);\n            }\n            \n            $breakdown['return_remote_surcharge'] = $return_remote_surcharge;\n            \n            \/\/ \u8a08\u7b97\u56de\u7a0b\u505c\u9760\u9ede\u8cbb\u7528\n            $return_stopover_charge = 0;\n            $return_stopover_details = array();\n            \n            if (count($return_stopovers) > 0) {\n                $return_points = array();\n                \n                if ($service_type === 'pickup') {\n                    if (!empty($return_pickup_address)) {\n                        $return_points[] = $return_pickup_address;\n                    }\n                    foreach ($return_stopovers as $stop) {\n                        if (!empty($stop['address'])) {\n                            $return_points[] = $stop['address'];\n                        }\n                    }\n                    $return_points[] = $airport_address;\n                } else {\n                    $return_points[] = $airport_address;\n                    foreach ($return_stopovers as $stop) {\n                        if (!empty($stop['address'])) {\n                            $return_points[] = $stop['address'];\n                        }\n                    }\n                    if (!empty($return_dropoff_address)) {\n                        $return_points[] = $return_dropoff_address;\n                    }\n                }\n                \n                for ($i = 0; $i < count($return_points) - 1; $i++) {\n                    $from = $return_points[$i];\n                    $to = $return_points[$i + 1];\n                    \n                    $should_charge = true;\n                    if ($service_type === 'pickup' && $i === count($return_points) - 2) {\n                        $should_charge = false;\n                    } elseif ($service_type === 'dropoff' && $i === 0) {\n                        $should_charge = false;\n                    }\n                    \n                    $distance = calculate_distance_google($from, $to);\n                    \n                    $fee = $should_charge ? calculate_distance_fee($distance) : 0;\n                    $return_stopover_charge += $fee;\n                    \n                    $from_short = mb_strlen($from) > 15 ? mb_substr($from, 0, 15) . '...' : $from;\n                    $to_short = mb_strlen($to) > 15 ? mb_substr($to, 0, 15) . '...' : $to;\n                    \n                    $segment_name = sprintf(\"\u56de\u7a0b\u8def\u6bb5 %d (%s \u2192 %s)\", \n                        $i + 1, \n                        $from_short, \n                        $to_short\n                    );\n                    \n                    $return_stopover_details[] = array(\n                        'segment' => $segment_name,\n                        'distance' => round($distance, 1),\n                        'fee' => $fee,\n                        'charged' => $should_charge\n                    );\n                }\n            }\n            \n            \/\/ \u56de\u7a0b\u52a0\u8cfc\u9805\u76ee\n            $return_child_seats = isset($_POST['return_child_seats']) ? intval($_POST['return_child_seats']) : $child_seats;\n            $return_booster_seats = isset($_POST['return_booster_seats']) ? intval($_POST['return_booster_seats']) : $booster_seats;\n            $return_name_board = isset($_POST['return_name_board']) ? $_POST['return_name_board'] : $name_board;\n            \n            $return_addon = ($return_child_seats * 100) + ($return_booster_seats * 100);\n            if ($return_name_board === 'yes') {\n                $return_addon += 200;\n            }\n            \n            \/\/ \u56de\u7a0b\u5c0f\u8a08\n            $return_subtotal = $base_price + $night_surcharge + $return_remote_surcharge + $return_stopover_charge + $return_addon;\n            \n            \/\/ \u8a08\u7b97\u7e3d\u50f9\uff08\u542b9\u6298\uff09\n            $original_total = $subtotal + $return_subtotal;\n            $total = round($original_total * 0.9);\n            $discount = $original_total - $total;\n            \n            $breakdown['return_stopover_charge'] = $return_stopover_charge;\n            $breakdown['return_stopover_details'] = $return_stopover_details;\n            $breakdown['return_addon'] = $return_addon;\n            $breakdown['return_subtotal'] = $return_subtotal;\n            $breakdown['discount'] = -$discount;\n            $breakdown['original_total'] = $original_total;\n        }\n        \n        \/\/ \u8fd4\u56de\u7d50\u679c\n        wp_send_json_success(array(\n            'subtotal' => $subtotal,\n            'total' => $total,\n            'breakdown' => $breakdown\n        ));\n        \n    } catch (Exception $e) {\n        error_log('Airport Price Calc Error: ' . $e->getMessage());\n        wp_send_json_error(array('message' => '\u8a08\u7b97\u932f\u8aa4\uff1a' . $e->getMessage()));\n    }\n    \n    wp_die();\n}\n\n\/\/ ========================================\n\/\/ AJAX \u9810\u7d04\u63d0\u4ea4\u8655\u7406\u5668\n\/\/ ========================================\nadd_action('wp_ajax_submit_airport_booking', 'handle_airport_booking_submit');\nadd_action('wp_ajax_nopriv_submit_airport_booking', 'handle_airport_booking_submit');\n\nfunction handle_airport_booking_submit() {\n    try {\n        \/\/ \u8cc7\u6599\u6536\u96c6\n        $airport = isset($_POST['airport']) ? sanitize_text_field($_POST['airport']) : '';\n        $destination = isset($_POST['destination']) ? sanitize_text_field($_POST['destination']) : '';\n        $service_type = isset($_POST['service_type']) ? sanitize_text_field($_POST['service_type']) : '';\n        $trip_type = isset($_POST['trip_type']) ? sanitize_text_field($_POST['trip_type']) : '';\n        \n        \/\/ \u53bb\u7a0b\u8cc7\u6599\n        $date = isset($_POST['date']) ? sanitize_text_field($_POST['date']) : '';\n        $time = isset($_POST['time']) ? sanitize_text_field($_POST['time']) : '';\n        $flight = isset($_POST['flight']) ? sanitize_text_field($_POST['flight']) : '';\n        $passengers = isset($_POST['passengers']) ? intval($_POST['passengers']) : 1;\n        $child_seats = isset($_POST['child_seats']) ? intval($_POST['child_seats']) : 0;\n        $booster_seats = isset($_POST['booster_seats']) ? intval($_POST['booster_seats']) : 0;\n        $name_board = isset($_POST['name_board']) ? sanitize_text_field($_POST['name_board']) : 'no';\n        \n        \/\/ \u5730\u5740\u8cc7\u6599\n        $pickup_address = isset($_POST['pickup_address']) ? sanitize_text_field($_POST['pickup_address']) : '';\n        $dropoff_address = isset($_POST['dropoff_address']) ? sanitize_text_field($_POST['dropoff_address']) : '';\n        \n        \/\/ \u5ba2\u6236\u8cc7\u6599\n        $customer_name = isset($_POST['customer_name']) ? sanitize_text_field($_POST['customer_name']) : '';\n        \n        \/\/ \u8655\u7406\u570b\u969b\u96fb\u8a71\u683c\u5f0f\n        $customer_phone = isset($_POST['customer_phone']) ? sanitize_text_field($_POST['customer_phone']) : '';\n        $customer_phone = preg_replace('\/[^0-9+]\/', '', $customer_phone);\n        \n        \/\/ Email \u6539\u70ba\u9078\u586b\n        $customer_email = isset($_POST['customer_email']) ? sanitize_email($_POST['customer_email']) : '';\n        \n        $notes = isset($_POST['notes']) ? sanitize_textarea_field($_POST['notes']) : '';\n        $total_price = isset($_POST['total_price']) ? floatval($_POST['total_price']) : 0;\n        \n        \/\/ \u5fc5\u586b\u6b04\u4f4d\u9a57\u8b49\n        $errors = array();\n        \n        if (empty($customer_name)) {\n            $errors[] = '\u8acb\u586b\u5beb\u59d3\u540d';\n        }\n        \n        \/\/ \u9a57\u8b49\u96fb\u8a71\n        if (empty($customer_phone)) {\n            $errors[] = '\u8acb\u586b\u5beb\u96fb\u8a71';\n        } else {\n            if (!preg_match('\/^(\\+[0-9]{1,4})?[0-9]{9,15}$\/', $customer_phone)) {\n                $errors[] = '\u96fb\u8a71\u683c\u5f0f\u4e0d\u6b63\u78ba';\n            }\n        }\n        \n        \/\/ Email \u4e0d\u518d\u5f37\u5236\u9a57\u8b49\uff0c\u4f46\u5982\u679c\u6709\u586b\u5beb\u8981\u9a57\u8b49\u683c\u5f0f\n        if (!empty($customer_email) && !filter_var($customer_email, FILTER_VALIDATE_EMAIL)) {\n            $errors[] = 'Email \u683c\u5f0f\u4e0d\u6b63\u78ba';\n        }\n        \n        if (empty($date)) {\n            $errors[] = '\u8acb\u9078\u64c7\u65e5\u671f';\n        }\n        \n        if (empty($time)) {\n            $errors[] = '\u8acb\u9078\u64c7\u6642\u9593';\n        }\n        \n        \/\/ \u5730\u5740\u9a57\u8b49 - \u6aa2\u67e5\u662f\u5426\u8207\u9078\u64c7\u7684\u7e23\u5e02\u76f8\u7b26\n        $main_address = '';\n        if ($service_type === 'pickup' && !empty($dropoff_address)) {\n            $main_address = $dropoff_address;\n            $validation_result = validate_address_city($dropoff_address, $destination);\n            if (!$validation_result['valid']) {\n                $errors[] = '\u4e0b\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $validation_result['message'];\n            }\n        } elseif ($service_type === 'dropoff' && !empty($pickup_address)) {\n            $main_address = $pickup_address;\n            $validation_result = validate_address_city($pickup_address, $destination);\n            if (!$validation_result['valid']) {\n                $errors[] = '\u4e0a\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $validation_result['message'];\n            }\n        }\n        \n        \/\/ \u8655\u7406\u505c\u9760\u9ede\n        $stopovers = array();\n        if (!empty($_POST['stopovers'])) {\n            $decoded = json_decode(stripslashes($_POST['stopovers']), true);\n            if (is_array($decoded)) {\n                $stopovers = $decoded;\n            }\n        }\n        \n        \/\/ \u8655\u7406\u56de\u7a0b\u8cc7\u6599\uff08\u5982\u679c\u662f\u4f86\u56de\u7a0b\uff09\n        $return_data = null;\n        if ($trip_type === 'roundtrip') {\n            $return_date = isset($_POST['return_date']) ? sanitize_text_field($_POST['return_date']) : '';\n            $return_time = isset($_POST['return_time']) ? sanitize_text_field($_POST['return_time']) : '';\n            $return_flight = isset($_POST['return_flight']) ? sanitize_text_field($_POST['return_flight']) : '';\n            $return_passengers = isset($_POST['return_passengers']) ? intval($_POST['return_passengers']) : $passengers;\n            $return_child_seats = isset($_POST['return_child_seats']) ? intval($_POST['return_child_seats']) : 0;\n            $return_booster_seats = isset($_POST['return_booster_seats']) ? intval($_POST['return_booster_seats']) : 0;\n            $return_name_board = isset($_POST['return_name_board']) ? sanitize_text_field($_POST['return_name_board']) : 'no';\n            \n            $return_pickup_address = isset($_POST['return_pickup_address']) ? sanitize_text_field($_POST['return_pickup_address']) : '';\n            $return_dropoff_address = isset($_POST['return_dropoff_address']) ? sanitize_text_field($_POST['return_dropoff_address']) : '';\n            \n            \/\/ \u56de\u7a0b\u505c\u9760\u9ede\n            $return_stopovers = array();\n            if (!empty($_POST['return_stopovers'])) {\n                $decoded = json_decode(stripslashes($_POST['return_stopovers']), true);\n                if (is_array($decoded)) {\n                    $return_stopovers = $decoded;\n                }\n            }\n            \n            \/\/ \u9a57\u8b49\u56de\u7a0b\u5fc5\u586b\n            if (empty($return_date)) {\n                $errors[] = '\u8acb\u9078\u64c7\u56de\u7a0b\u65e5\u671f';\n            }\n            if (empty($return_time)) {\n                $errors[] = '\u8acb\u9078\u64c7\u56de\u7a0b\u6642\u9593';\n            }\n            \n            \/\/ \u56de\u7a0b\u5730\u5740\u9a57\u8b49\n            if ($service_type === 'pickup') {\n                if (empty($return_pickup_address)) {\n                    $errors[] = '\u8acb\u586b\u5beb\u56de\u7a0b\u4e0a\u8eca\u5730\u5740';\n                } else {\n                    $validation_result = validate_address_city($return_pickup_address, $destination);\n                    if (!$validation_result['valid']) {\n                        $errors[] = '\u56de\u7a0b\u4e0a\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $validation_result['message'];\n                    }\n                }\n            } elseif ($service_type === 'dropoff') {\n                if (empty($return_dropoff_address)) {\n                    $errors[] = '\u8acb\u586b\u5beb\u56de\u7a0b\u4e0b\u8eca\u5730\u5740';\n                } else {\n                    $validation_result = validate_address_city($return_dropoff_address, $destination);\n                    if (!$validation_result['valid']) {\n                        $errors[] = '\u56de\u7a0b\u4e0b\u8eca\u5730\u5740\u932f\u8aa4\uff1a' . $validation_result['message'];\n                    }\n                }\n            }\n            \n            $return_data = array(\n                'date' => $return_date,\n                'time' => $return_time,\n                'flight' => $return_flight,\n                'passengers' => $return_passengers,\n                'child_seats' => $return_child_seats,\n                'booster_seats' => $return_booster_seats,\n                'name_board' => $return_name_board,\n                'pickup_address' => $return_pickup_address,\n                'dropoff_address' => $return_dropoff_address,\n                'stopovers' => $return_stopovers\n            );\n        }\n        \n        \/\/ \u5982\u679c\u6709\u932f\u8aa4\uff0c\u8fd4\u56de\u932f\u8aa4\u8a0a\u606f\n        if (!empty($errors)) {\n            wp_send_json_error(array(\n                'message' => implode('\u3001', $errors)\n            ));\n            wp_die();\n        }\n        \n        \/\/ \u683c\u5f0f\u5316\u96fb\u8a71\u865f\u78bc\uff08\u7d71\u4e00\u683c\u5f0f\u5132\u5b58\uff09\n        if (strpos($customer_phone, '+') !== 0 && strlen($customer_phone) == 10) {\n            $customer_phone = '+886' . ltrim($customer_phone, '0');\n        }\n        \n        \/\/ \u7d44\u88dd\u9810\u7d04\u8cc7\u6599\n        $booking_data = array(\n            'booking_type' => 'airport_transfer',\n            'airport' => strtoupper($airport),\n            'destination' => $destination,\n            'service_type' => $service_type,\n            'trip_type' => $trip_type,\n            'date' => $date,\n            'time' => $time,\n            'flight' => $flight,\n            'passengers' => $passengers,\n            'child_seats' => $child_seats,\n            'booster_seats' => $booster_seats,\n            'name_board' => $name_board,\n            'pickup_address' => $pickup_address,\n            'dropoff_address' => $dropoff_address,\n            'stopovers' => $stopovers,\n            'customer_name' => $customer_name,\n            'customer_phone' => $customer_phone,\n            'customer_email' => $customer_email,\n            'notes' => $notes,\n            'total_price' => $total_price,\n            'return_data' => $return_data,\n            'booking_time' => current_time('mysql'),\n            'booking_status' => 'pending',\n            'ip_address' => $_SERVER['REMOTE_ADDR']\n        );\n        \n        \/\/ \u5132\u5b58\u70ba\u81ea\u8a02 Post Type\n        $post_data = array(\n            'post_title' => sprintf('[%s] %s - %s %s', \n                strtoupper($airport), \n                $customer_name, \n                $date,\n                $service_type === 'pickup' ? '\u63a5\u6a5f' : '\u9001\u6a5f'\n            ),\n            'post_content' => wp_json_encode($booking_data, JSON_UNESCAPED_UNICODE),\n            'post_status' => 'private',\n            'post_type' => 'airport_booking',\n            'meta_input' => array(\n                '_booking_data' => $booking_data,\n                '_customer_name' => $customer_name,\n                '_customer_phone' => $customer_phone,\n                '_customer_email' => $customer_email,\n                '_booking_date' => $date,\n                '_total_price' => $total_price,\n                '_trip_type' => $trip_type\n            )\n        );\n        \n        $booking_id = wp_insert_post($post_data);\n        \n        if (is_wp_error($booking_id)) {\n            throw new Exception('\u9810\u7d04\u5132\u5b58\u5931\u6557');\n        }\n        \n        \/\/ \u767c\u9001 Email \u901a\u77e5\uff08\u53ea\u5728\u6709 email \u6642\u767c\u9001\uff09\n        if (!empty($customer_email)) {\n            $email_sent = send_booking_confirmation_email($booking_id, $booking_data);\n            error_log('\u78ba\u8a8d\u4fe1\u767c\u9001\u72c0\u614b: ' . ($email_sent ? '\u6210\u529f' : '\u5931\u6557'));\n        } else {\n            error_log('\u5ba2\u6236\u672a\u63d0\u4f9b Email\uff0c\u8df3\u904e\u767c\u9001\u78ba\u8a8d\u4fe1');\n        }\n        \n        \/\/ \u767c\u9001\u7ba1\u7406\u54e1\u901a\u77e5\n        send_admin_notification($booking_id, $booking_data);\n        \n        \/\/ \u8fd4\u56de\u6210\u529f\u8a0a\u606f\n        wp_send_json_success(array(\n            'message' => '\u9810\u7d04\u6210\u529f\uff01\u6211\u5011\u5c07\u572824\u5c0f\u6642\u5167\u8207\u60a8\u806f\u7e6b\u78ba\u8a8d\u3002',\n            'booking_id' => $booking_id,\n            'booking_number' => 'APT' . str_pad($booking_id, 6, '0', STR_PAD_LEFT),\n        ));\n        \n    } catch (Exception $e) {\n        error_log('Airport Booking Error: ' . $e->getMessage());\n        wp_send_json_error(array(\n            'message' => '\u9810\u7d04\u5931\u6557\uff1a' . $e->getMessage()\n        ));\n    }\n    \n    wp_die();\n}\n\n\/\/ ========================================\n\/\/ Email \u767c\u9001\u51fd\u6578\n\/\/ ========================================\nfunction send_booking_confirmation_email($booking_id, $booking_data) {\n    if (empty($booking_data['customer_email'])) {\n        return false;\n    }\n    \n    $to = $booking_data['customer_email'];\n    $subject = '\u6a5f\u5834\u63a5\u9001\u9810\u7d04\u78ba\u8a8d - \u8a02\u55ae\u7de8\u865f APT' . str_pad($booking_id, 6, '0', STR_PAD_LEFT);\n    \n    \/\/ \u7d44\u88dd\u90f5\u4ef6\u5167\u5bb9\n    $message = \"\u89aa\u611b\u7684 {$booking_data['customer_name']} \u60a8\u597d\uff0c\\n\\n\";\n    $message .= \"\u60a8\u7684\u6a5f\u5834\u63a5\u9001\u9810\u7d04\u5df2\u6210\u529f\u63d0\u4ea4\uff0c\u4ee5\u4e0b\u662f\u60a8\u7684\u9810\u7d04\u8a73\u60c5\uff1a\\n\\n\";\n    $message .= \"\u3010\u9810\u7d04\u7de8\u865f\u3011APT\" . str_pad($booking_id, 6, '0', STR_PAD_LEFT) . \"\\n\";\n    $message .= \"\u3010\u670d\u52d9\u985e\u578b\u3011\" . ($booking_data['service_type'] === 'pickup' ? '\u63a5\u6a5f' : '\u9001\u6a5f') . \"\\n\";\n    $message .= \"\u3010\u6a5f\u5834\u3011\" . ($booking_data['airport'] === 'TPE' ? '\u6843\u5712\u570b\u969b\u6a5f\u5834' : '\u53f0\u5317\u677e\u5c71\u6a5f\u5834') . \"\\n\";\n    $message .= \"\u3010\u65e5\u671f\u6642\u9593\u3011{$booking_data['date']} {$booking_data['time']}\\n\";\n    \n    if (!empty($booking_data['flight'])) {\n        $message .= \"\u3010\u822a\u73ed\u865f\u78bc\u3011{$booking_data['flight']}\\n\";\n    }\n    \n    \/\/ \u5730\u5740\u8cc7\u8a0a\n    if ($booking_data['service_type'] === 'pickup') {\n        $message .= \"\u3010\u4e0b\u8eca\u5730\u5740\u3011{$booking_data['dropoff_address']}\\n\";\n    } else {\n        $message .= \"\u3010\u4e0a\u8eca\u5730\u5740\u3011{$booking_data['pickup_address']}\\n\";\n    }\n    \n    \/\/ \u505c\u9760\u9ede\n    if (!empty($booking_data['stopovers'])) {\n        $message .= \"\u3010\u505c\u9760\u9ede\u3011\\n\";\n        foreach ($booking_data['stopovers'] as $i => $stop) {\n            $message .= \"  \" . ($i + 1) . \". {$stop['address']}\\n\";\n        }\n    }\n    \n    $message .= \"\u3010\u4e58\u5ba2\u4eba\u6578\u3011{$booking_data['passengers']} \u4eba\\n\";\n    \n    \/\/ \u52a0\u8cfc\u9805\u76ee\n    if ($booking_data['child_seats'] > 0) {\n        $message .= \"\u3010\u5b30\u5152\u5ea7\u6905\u3011{$booking_data['child_seats']} \u5f35\\n\";\n    }\n    if ($booking_data['booster_seats'] > 0) {\n        $message .= \"\u3010\u5152\u7ae5\u589e\u9ad8\u588a\u3011{$booking_data['booster_seats']} \u5f35\\n\";\n    }\n    if ($booking_data['name_board'] === 'yes') {\n        $message .= \"\u3010\u8209\u724c\u670d\u52d9\u3011\u662f\\n\";\n    }\n    \n    \/\/ \u56de\u7a0b\u8cc7\u8a0a\n    if ($booking_data['trip_type'] === 'roundtrip' && !empty($booking_data['return_data'])) {\n        $return = $booking_data['return_data'];\n        $message .= \"\\n\u3010\u56de\u7a0b\u8cc7\u8a0a\u3011\\n\";\n        $message .= \"\u65e5\u671f\u6642\u9593\uff1a{$return['date']} {$return['time']}\\n\";\n        if (!empty($return['flight'])) {\n            $message .= \"\u822a\u73ed\u865f\u78bc\uff1a{$return['flight']}\\n\";\n        }\n        if ($booking_data['service_type'] === 'pickup') {\n            $message .= \"\u4e0a\u8eca\u5730\u5740\uff1a{$return['pickup_address']}\\n\";\n        } else {\n            $message .= \"\u4e0b\u8eca\u5730\u5740\uff1a{$return['dropoff_address']}\\n\";\n        }\n        if ($return['name_board'] === 'yes') {\n            $message .= \"\u56de\u7a0b\u8209\u724c\u670d\u52d9\uff1a\u662f\\n\";\n        }\n    }\n    \n    $message .= \"\\n\u3010\u7e3d\u91d1\u984d\u3011NT$ \" . number_format($booking_data['total_price']) . \"\\n\";\n    \n    if (!empty($booking_data['notes'])) {\n        $message .= \"\\n\u3010\u5099\u8a3b\u3011{$booking_data['notes']}\\n\";\n    }\n    \n    $message .= \"\\n\u6211\u5011\u5c07\u572824\u5c0f\u6642\u5167\u8207\u60a8\u96fb\u8a71\u78ba\u8a8d\u9810\u7d04\u8a73\u60c5\u3002\\n\";\n    $message .= \"\u5982\u6709\u4efb\u4f55\u554f\u984c\uff0c\u8acb\u806f\u7e6b\u6211\u5011\u7684\u5ba2\u670d\u5c08\u7dda\u3002\\n\\n\";\n    $message .= \"\u611f\u8b1d\u60a8\u7684\u9810\u7d04\uff01\\n\";\n    $message .= \"9o Van Strip \u6a5f\u5834\u63a5\u9001\u670d\u52d9\";\n    \n    $headers = array(\n        'Content-Type: text\/plain; charset=UTF-8',\n        'From: 9o Van Strip <noreply@' . $_SERVER['SERVER_NAME'] . '>'\n    );\n    \n    return wp_mail($to, $subject, $message, $headers);\n}\n\n\/\/ ========================================\n\/\/ \u7ba1\u7406\u54e1\u901a\u77e5\u51fd\u6578\n\/\/ ========================================\nfunction send_admin_notification($booking_id, $booking_data) {\n    $admin_email = get_option('admin_email');\n    \n    $subject = '\u65b0\u9810\u7d04\u901a\u77e5 - ' . $booking_data['customer_name'] . ' - APT' . str_pad($booking_id, 6, '0', STR_PAD_LEFT);\n    \n    $message = \"\u6709\u65b0\u7684\u6a5f\u5834\u63a5\u9001\u9810\u7d04\uff1a\\n\\n\";\n    $message .= \"\u3010\u9810\u7d04\u7de8\u865f\u3011APT\" . str_pad($booking_id, 6, '0', STR_PAD_LEFT) . \"\\n\";\n    $message .= \"\u3010\u5ba2\u6236\u59d3\u540d\u3011{$booking_data['customer_name']}\\n\";\n    $message .= \"\u3010\u5ba2\u6236\u96fb\u8a71\u3011{$booking_data['customer_phone']}\\n\";\n    \n    if (!empty($booking_data['customer_email'])) {\n        $message .= \"\u3010\u5ba2\u6236Email\u3011{$booking_data['customer_email']}\\n\";\n    } else {\n        $message .= \"\u3010\u5ba2\u6236Email\u3011\u672a\u63d0\u4f9b\\n\";\n    }\n    \n    $message .= \"\u3010\u670d\u52d9\u985e\u578b\u3011\" . ($booking_data['service_type'] === 'pickup' ? '\u63a5\u6a5f' : '\u9001\u6a5f');\n    $message .= \" \/ \" . ($booking_data['trip_type'] === 'roundtrip' ? '\u4f86\u56de' : '\u55ae\u7a0b') . \"\\n\";\n    $message .= \"\u3010\u65e5\u671f\u6642\u9593\u3011{$booking_data['date']} {$booking_data['time']}\\n\";\n    \n    if ($booking_data['name_board'] === 'yes') {\n        $message .= \"\u3010\u8209\u724c\u670d\u52d9\u3011\u9700\u8981\u8209\u724c\\n\";\n    }\n    \n    $message .= \"\u3010\u7e3d\u91d1\u984d\u3011NT$ \" . number_format($booking_data['total_price']) . \"\\n\";\n    \n    $edit_link = admin_url('post.php?post=' . $booking_id . '&action=edit');\n    $message .= \"\\n\u3010\u7ba1\u7406\u9023\u7d50\u3011{$edit_link}\\n\";\n    \n    $headers = array(\n        'Content-Type: text\/plain; charset=UTF-8'\n    );\n    \n    wp_mail($admin_email, $subject, $message, $headers);\n}\n\n\/\/ ========================================\n\/\/ \u6e2c\u8a66\u7aef\u9ede\n\/\/ ========================================\nadd_action('wp_ajax_test_airport_ajax', 'test_airport_ajax');\nadd_action('wp_ajax_nopriv_test_airport_ajax', 'test_airport_ajax');\n\nfunction test_airport_ajax() {\n    wp_send_json_success(array(\n        'message' => 'AJAX \u7cfb\u7d71\u6b63\u5e38\u904b\u4f5c',\n        'timestamp' => current_time('mysql'),\n        'api_key_set' => defined('GOOGLE_MAPS_API_KEY'),\n        'php_version' => phpversion(),\n        'wp_version' => get_bloginfo('version')\n    ));\n    wp_die();\n}","active":true,"priority":15,"modified":"2025-09-15 12:35:51","revision":"1"}]}