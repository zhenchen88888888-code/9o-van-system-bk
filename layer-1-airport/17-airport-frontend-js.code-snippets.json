{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":92,"name":"17-Airport-Frontend-JS","code":"\/**\n * ============================================================================\n * Module: 17-Airport-Frontend-JS\n * Title: \u6a5f\u5834\u63a5\u9001\u524d\u7aef JavaScript \u908f\u8f2f\n * Description: \u8655\u7406\u8868\u55ae\u4e92\u52d5\u3001AJAX \u8acb\u6c42\u3001\u5373\u6642\u9a57\u8b49\u3001\u50f9\u683c\u8a08\u7b97\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-14\n * Modified: 2025-09-14\n * ============================================================================\n *\/\n\n(function() {\n    if (typeof jQuery === 'undefined') {\n        setTimeout(arguments.callee, 100);\n        return;\n    }\n    \n    jQuery(document).ready(function($) {\n        'use strict';\n        \n        \/\/ \u6aa2\u67e5\u662f\u5426\u5728\u6a5f\u5834\u63a5\u9001\u9801\u9762\n        if (!$('#airport-booking-form').length && !$('.9o-van-airport-booking').length) {\n            return;\n        }\n        \n        console.log('\ud83d\ude80 \u958b\u59cb\u8f09\u5165\u6a5f\u5834\u63a5\u9001\u7cfb\u7d71...');\n        \n        \/\/ ========================================\n        \/\/ \u5168\u57df\u914d\u7f6e\n        \/\/ ========================================\n        const CONFIG = {\n            \/\/ \u81ea\u52d5\u5075\u6e2c WordPress AJAX URL\n            ajaxUrl: window.ajaxurl || window.wp_ajax?.ajax_url || '\/wp-admin\/admin-ajax.php',\n            minDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n            maxStops: 5,\n            cities: {\n                'taipei-city': '\u53f0\u5317\u5e02',\n                'new-taipei': '\u65b0\u5317\u5e02',\n                'keelung': '\u57fa\u9686\u5e02',\n                'taoyuan': '\u6843\u5712\u5e02',\n                'yilan': '\u5b9c\u862d\u7e23',\n                'hsinchu-area': '\u65b0\u7af9(\u5e02\/\u7e23)',\n                'miaoli': '\u82d7\u6817\u7e23',\n                'taichung': '\u53f0\u4e2d\u5e02',\n                'changhua': '\u5f70\u5316\u7e23',\n                'nantou': '\u5357\u6295\u7e23',\n                'yunlin': '\u96f2\u6797\u7e23',\n                'chiayi-area': '\u5609\u7fa9(\u5e02\/\u7e23)',\n                'tainan': '\u53f0\u5357\u5e02',\n                'kaohsiung': '\u9ad8\u96c4\u5e02',\n                'pingtung': '\u5c4f\u6771\u7e23',\n                'hualien': '\u82b1\u84ee\u7e23',\n                'taitung': '\u53f0\u6771\u7e23'\n            },\n            debug: true\n        };\n        \n        \/\/ ========================================\n        \/\/ \u6a5f\u5834\u63a5\u9001\u61c9\u7528\u7a0b\u5f0f\n        \/\/ ========================================\n        const AirportBooking = {\n            \/\/ \u72c0\u614b\u7ba1\u7406\n            state: {\n                stopovers: [],\n                returnStopovers: [],\n                calcTimeout: null,\n                isSubmitting: false,\n                lastTotalPrice: 0\n            },\n            \n            \/\/ \u521d\u59cb\u5316\n            init() {\n                console.log('\ud83d\udccb \u521d\u59cb\u5316\u6a5f\u5834\u63a5\u9001\u7cfb\u7d71...');\n                console.log('AJAX URL:', CONFIG.ajaxUrl);\n                \n                \/\/ \u6aa2\u67e5\u8868\u55ae\u662f\u5426\u5b58\u5728\n                if (!$('#airport-booking-form').length) {\n                    console.error('\u274c \u627e\u4e0d\u5230\u6a5f\u5834\u9810\u7d04\u8868\u55ae\uff01');\n                    return false;\n                }\n                \n                this.bindEvents();\n                this.initializeForm();\n                \n                \/\/ \u5ef6\u9072\u521d\u59cb\u8a08\u7b97\n                setTimeout(() => {\n                    console.log('\ud83d\udcb0 \u57f7\u884c\u521d\u59cb\u50f9\u683c\u8a08\u7b97...');\n                    this.calculatePrice();\n                }, 1000);\n                \n                console.log('\u2705 \u6a5f\u5834\u63a5\u9001\u7cfb\u7d71\u5df2\u555f\u52d5');\n                return true;\n            },\n            \n            \/\/ \u8868\u55ae\u521d\u59cb\u5316\n            initializeForm() {\n                console.log('\ud83d\udd27 \u521d\u59cb\u5316\u8868\u55ae...');\n                \n                \/\/ \u8a2d\u5b9a\u6700\u5c0f\u65e5\u671f\n                $('#date, #return_date').attr('min', CONFIG.minDate);\n                \n                \/\/ \u521d\u59cb\u5316 Radio \u6a23\u5f0f\n                $('.radio-item input[type=\"radio\"]:checked').closest('.radio-item').addClass('selected');\n                \n                \/\/ \u8a2d\u5b9a\u9810\u8a2d\u503c\n                if (!$('#date').val()) {\n                    $('#date').val(CONFIG.minDate);\n                }\n                if (!$('#time').val()) {\n                    $('#time').val('10:00');\n                }\n                if (!$('#passengers').val()) {\n                    $('#passengers').val(1);\n                }\n                \n                \/\/ \u78ba\u4fdd\u521d\u59cb\u72c0\u614b\u6b63\u78ba\n                $('[name=\"service_type\"]:checked').trigger('change');\n                $('[name=\"trip_type\"]:checked').trigger('change');\n                \n                console.log('\u2705 \u8868\u55ae\u521d\u59cb\u5316\u5b8c\u6210');\n            },\n            \n            \/\/ \u65b0\u589e\u505c\u9760\u9ede\n            addStop(containerId, address = '') {\n                const container = $(`#${containerId}`);\n                const stops = container.find('.stop-item').length;\n                \n                if (stops >= CONFIG.maxStops) {\n                    alert(`\u6700\u591a\u53ea\u80fd\u65b0\u589e${CONFIG.maxStops}\u500b\u505c\u9760\u9ede`);\n                    return;\n                }\n                \n                const stopId = `${containerId}_stop_${stops}`;\n                const stopHTML = `\n                    <div class=\"stop-item\" data-index=\"${stops}\">\n                        <input type=\"text\" id=\"${stopId}\" class=\"stop-input\"\n                               placeholder=\"\u505c\u9760\u9ede ${stops + 1} - \u8acb\u8f38\u5165\u5b8c\u6574\u5730\u5740\uff08\u542b\u7e23\u5e02\uff09\" \n                               value=\"${address}\">\n                        <div class=\"stop-controls\">\n                            <button type=\"button\" class=\"stop-btn\" data-action=\"up\" \n                                    data-container=\"${containerId}\" ${stops === 0 ? 'disabled' : ''}>\u2191<\/button>\n                            <button type=\"button\" class=\"stop-btn\" data-action=\"down\" \n                                    data-container=\"${containerId}\" disabled>\u2193<\/button>\n                            <button type=\"button\" class=\"stop-btn delete\" data-action=\"delete\" \n                                    data-container=\"${containerId}\">\u00d7<\/button>\n                        <\/div>\n                    <\/div>\n                `;\n                \n                container.append(stopHTML);\n                this.updateStopButtons(containerId);\n            },\n            \n            \/\/ \u66f4\u65b0\u505c\u9760\u9ede\u6309\u9215\u72c0\u614b\n            updateStopButtons(containerId) {\n                const items = $(`#${containerId} .stop-item`);\n                \n                items.each(function(index) {\n                    const $item = $(this);\n                    $item.attr('data-index', index);\n                    $item.find('.stop-input').attr('placeholder', `\u505c\u9760\u9ede ${index + 1} - \u8acb\u8f38\u5165\u5b8c\u6574\u5730\u5740\uff08\u542b\u7e23\u5e02\uff09`);\n                    \n                    const $upBtn = $item.find('[data-action=\"up\"]');\n                    const $downBtn = $item.find('[data-action=\"down\"]');\n                    \n                    $upBtn.prop('disabled', index === 0);\n                    $downBtn.prop('disabled', index === items.length - 1);\n                });\n                \n                \/\/ \u66f4\u65b0\u72c0\u614b\n                if (containerId === 'stops-container') {\n                    this.state.stopovers = items.map((i, el) => ({\n                        address: $(el).find('.stop-input').val()\n                    })).get();\n                } else {\n                    this.state.returnStopovers = items.map((i, el) => ({\n                        address: $(el).find('.stop-input').val()\n                    })).get();\n                }\n            },\n            \n            \/\/ \u9632\u6296\u8a08\u7b97\n            debouncedCalc() {\n                clearTimeout(this.state.calcTimeout);\n                this.state.calcTimeout = setTimeout(() => this.calculatePrice(), 500);\n            },\n            \n            \/\/ \u8a08\u7b97\u50f9\u683c\n            calculatePrice() {\n                if (CONFIG.debug) console.log('\ud83d\udcb5 \u958b\u59cb\u8a08\u7b97\u50f9\u683c...');\n                \n                \/\/ \u6536\u96c6\u505c\u9760\u9ede\n                const stopovers = [];\n                $('#stops-container .stop-input').each(function() {\n                    const val = $(this).val().trim();\n                    if (val) stopovers.push({address: val});\n                });\n                \n                const returnStopovers = [];\n                $('#return-stops-container .stop-input').each(function() {\n                    const val = $(this).val().trim();\n                    if (val) returnStopovers.push({address: val});\n                });\n                \n                \/\/ \u6e96\u5099\u8cc7\u6599\n                const formData = $('#airport-booking-form').serialize();\n                \n                \/\/ \u4fee\u6b63 airport \u503c\u70ba\u5927\u5beb\uff08\u91cd\u8981\uff01\uff09\n                let ajaxData = formData.replace(\/airport=tpe\/gi, 'airport=TPE')\n                                      .replace(\/airport=tsa\/gi, 'airport=TSA');\n                \n                ajaxData += '&action=calculate_airport_price' +\n                           '&stopovers=' + encodeURIComponent(JSON.stringify(stopovers)) +\n                           '&return_stopovers=' + encodeURIComponent(JSON.stringify(returnStopovers));\n                \n                if (CONFIG.debug) {\n                    console.log('\ud83d\udce1 AJAX URL:', CONFIG.ajaxUrl);\n                    console.log('\ud83d\udce6 \u767c\u9001\u8cc7\u6599:', ajaxData);\n                }\n                \n                \/\/ \u986f\u793a\u8f09\u5165\u4e2d\n                $('#price-panel .price-content').html('<div class=\"price-loading\">\u8a08\u7b97\u4e2d...<\/div>');\n                \n                \/\/ AJAX \u8acb\u6c42\n                $.ajax({\n                    url: CONFIG.ajaxUrl,\n                    type: 'POST',\n                    data: ajaxData,\n                    dataType: 'json',\n                    timeout: 10000,\n                    success: (response) => {\n                        if (CONFIG.debug) console.log('\u2705 \u50f9\u683c\u8a08\u7b97\u56de\u61c9:', response);\n                        \n                        if (response && response.success && response.data) {\n                            this.displayPrice(response.data);\n                            this.state.lastTotalPrice = response.data.total;\n                        } else {\n                            $('#price-panel .price-content').html('<div class=\"price-error\">\u8a08\u7b97\u5931\u6557\uff0c\u8acb\u91cd\u8a66<\/div>');\n                            if (CONFIG.debug) console.error('\u274c \u50f9\u683c\u8a08\u7b97\u5931\u6557:', response);\n                        }\n                    },\n                    error: (xhr, status, error) => {\n                        $('#price-panel .price-content').html('<div class=\"price-error\">\u7cfb\u7d71\u932f\u8aa4\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66<\/div>');\n                        if (CONFIG.debug) {\n                            console.error('\u274c AJAX Error:', status, error);\n                            console.error('Response:', xhr.responseText);\n                        }\n                    }\n                });\n            },\n            \n            \/\/ \u986f\u793a\u50f9\u683c\u660e\u7d30\n            displayPrice(data) {\n                let html = '';\n                \n                if (data.breakdown) {\n                    \/\/ \u57fa\u672c\u8cbb\u7528\n                    if (data.breakdown.base_price > 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span>\u57fa\u672c\u8cbb\u7528<\/span>\n                                <span>NT$ ${data.breakdown.base_price.toLocaleString()}<\/span>\n                            <\/div>\n                        `;\n                    }\n                    \n                    \/\/ \u591c\u9593\u52a0\u50f9\n                    if (data.breakdown.night_surcharge > 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span>\u591c\u9593\u52a0\u50f9 (22:00-08:00)<\/span>\n                                <span>NT$ ${data.breakdown.night_surcharge.toLocaleString()}<\/span>\n                            <\/div>\n                        `;\n                    }\n                    \n                    \/\/ \u504f\u9060\u5730\u5340\u52a0\u50f9\n                    if (data.breakdown.remote_surcharge > 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span>\u504f\u9060\u5730\u5340\u52a0\u50f9<\/span>\n                                <span>NT$ ${data.breakdown.remote_surcharge.toLocaleString()}<\/span>\n                            <\/div>\n                        `;\n                    }\n                    \n                    \/\/ \u505c\u9760\u9ede\u8cbb\u7528\n                    if (data.breakdown.stopover_charge > 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span>\u505c\u9760\u9ede\u8cbb\u7528<\/span>\n                                <span>NT$ ${data.breakdown.stopover_charge.toLocaleString()}<\/span>\n                            <\/div>\n                        `;\n                        \n                        \/\/ \u505c\u9760\u9ede\u8a73\u60c5\n                        if (data.breakdown.stopover_details && data.breakdown.stopover_details.length > 0) {\n                            html += '<div class=\"stopover-details\">';\n                            data.breakdown.stopover_details.forEach(function(detail) {\n                                const chargeText = detail.charged ? \n                                    'NT$ ' + detail.fee : \n                                    '\u514d\u8cbb\uff08\u4e0d\u8a08\u8cbb\u8def\u6bb5\uff09';\n                                const className = detail.charged ? '' : 'free';\n                                \n                                html += `\n                                    <div class=\"detail-item ${className}\">\n                                        ${detail.segment}: ${detail.distance}km - ${chargeText}\n                                    <\/div>\n                                `;\n                            });\n                            html += '<\/div>';\n                        }\n                    }\n                    \n                    \/\/ \u52a0\u8cfc\u9805\u76ee\n                    if (data.breakdown.addon_charge > 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span>\u52a0\u8cfc\u9805\u76ee<\/span>\n                                <span>NT$ ${data.breakdown.addon_charge.toLocaleString()}<\/span>\n                            <\/div>\n                        `;\n                        \n                        \/\/ \u8209\u724c\u670d\u52d9\n                        if (data.breakdown.name_board_charge > 0) {\n                            html += `\n                                <div class=\"price-item detail\">\n                                    <span>\u3000\u2022 \u8209\u724c\u670d\u52d9<\/span>\n                                    <span>NT$ 200<\/span>\n                                <\/div>\n                            `;\n                        }\n                    }\n                    \n                    \/\/ \u4f86\u56de\u7a0b\u6298\u6263\n                    if (data.breakdown.discount && data.breakdown.discount < 0) {\n                        html += `\n                            <div class=\"price-item\">\n                                <span style=\"color: #16a34a; font-weight: 600;\">\u4f86\u56de\u7a0b9\u6298\u512a\u60e0<\/span>\n                                <span style=\"color: #16a34a;\">\n                                    -NT$ ${Math.abs(data.breakdown.discount).toLocaleString()}\n                                <\/span>\n                            <\/div>\n                        `;\n                    }\n                }\n                \n                \/\/ \u7e3d\u8a08\n                html += `\n                    <div class=\"price-total\">\n                        <span>\u7e3d\u8a08(\u542b\u7a05)<\/span>\n                        <span>NT$ ${(data.total || 0).toLocaleString()}<\/span>\n                    <\/div>\n                `;\n                \n                \/\/ \u504f\u9060\u5730\u5340\u63d0\u793a\n                if ((data.breakdown && data.breakdown.remote_surcharge > 0) || \n                    (data.breakdown && data.breakdown.return_remote_surcharge > 0)) {\n                    html += `\n                        <div class=\"remote-area-notice\">\n                            <small>\ud83d\udccd \u60a8\u7684\u76ee\u7684\u5730\u4f4d\u65bc\u504f\u9060\u5730\u5340\uff0c\u5df2\u81ea\u52d5\u52a0\u6536\u504f\u9060\u5730\u5340\u670d\u52d9\u8cbb<\/small>\n                        <\/div>\n                    `;\n                }\n                \n                $('#price-panel .price-content').html(html);\n                $('#total_price').val(data.total || 0);\n            },\n            \n            \/\/ \u7d81\u5b9a\u4e8b\u4ef6\n            bindEvents() {\n                const self = this;\n                \n                console.log('\ud83d\udd17 \u7d81\u5b9a\u4e8b\u4ef6\u8655\u7406\u5668...');\n                \n                \/\/ \u670d\u52d9\u985e\u578b\u5207\u63db\uff08\u63a5\u6a5f\/\u9001\u6a5f\uff09\n                $(document).on('change', '[name=\"service_type\"]', function() {\n                    const isPickup = $(this).val() === 'pickup';\n                    if (CONFIG.debug) console.log('\ud83d\ude96 \u670d\u52d9\u985e\u578b\u8b8a\u66f4:', $(this).val());\n                    \n                    \/\/ \u53bb\u7a0b\u6b04\u4f4d\u986f\u793a\u908f\u8f2f\n                    $('.pickup-fields').toggle(isPickup);\n                    $('.dropoff-fields').toggle(!isPickup);\n                    \n                    \/\/ \u56de\u7a0b\u6b04\u4f4d\u986f\u793a\u908f\u8f2f\uff08\u76f8\u53cd\uff09\n                    $('.return-pickup-fields').toggle(!isPickup);\n                    $('.return-dropoff-fields').toggle(isPickup);\n                    \n                    \/\/ \u66f4\u65b0\u56de\u7a0b\u6a19\u7c64\u6587\u5b57\n                    if (isPickup) {\n                        $('.return-dropoff-label').html('\u56de\u7a0b\u4e0b\u8eca\u5730\u5740 <span class=\"required\">*<\/span>');\n                    } else {\n                        $('.return-pickup-label').html('\u56de\u7a0b\u4e0a\u8eca\u5730\u5740 <span class=\"required\">*<\/span>');\n                    }\n                    \n                    self.debouncedCalc();\n                });\n                \n                \/\/ \u884c\u7a0b\u985e\u578b\u5207\u63db\uff08\u55ae\u7a0b\/\u4f86\u56de\uff09\n                $(document).on('change', '[name=\"trip_type\"]', function() {\n                    const isRoundtrip = $(this).val() === 'roundtrip';\n                    if (CONFIG.debug) console.log('\ud83d\udd04 \u884c\u7a0b\u985e\u578b\u8b8a\u66f4:', $(this).val());\n                    \n                    $('.return-section, .return-addon-section').toggle(isRoundtrip);\n                    \n                    if (isRoundtrip) {\n                        \/\/ \u8a2d\u5b9a\u9810\u8a2d\u56de\u7a0b\u65e5\u671f\uff087\u5929\u5f8c\uff09\n                        const goDate = $('#date').val();\n                        if (goDate) {\n                            const returnDate = new Date(goDate);\n                            returnDate.setDate(returnDate.getDate() + 7);\n                            $('#return_date').val(returnDate.toISOString().split('T')[0]);\n                        }\n                        \n                        \/\/ \u8907\u88fd\u53bb\u7a0b\u503c\u5230\u56de\u7a0b\n                        $('#return_passengers').val($('#passengers').val());\n                        $('#return_child_seats').val($('#child_seats').val());\n                        $('#return_booster_seats').val($('#booster_seats').val());\n                    }\n                    \n                    self.debouncedCalc();\n                });\n                \n                \/\/ \u65b0\u589e\u505c\u9760\u9ede\u6309\u9215\n                $(document).on('click', '#add-stopover', function(e) {\n                    e.preventDefault();\n                    if (CONFIG.debug) console.log('\u2795 \u65b0\u589e\u505c\u9760\u9ede');\n                    self.addStop('stops-container');\n                    self.debouncedCalc();\n                });\n                \n                $(document).on('click', '#add-return-stopover', function(e) {\n                    e.preventDefault();\n                    if (CONFIG.debug) console.log('\u2795 \u65b0\u589e\u56de\u7a0b\u505c\u9760\u9ede');\n                    self.addStop('return-stops-container');\n                    self.debouncedCalc();\n                });\n                \n                \/\/ \u505c\u9760\u9ede\u64cd\u4f5c\u6309\u9215\n                $(document).on('click', '.stop-btn', function(e) {\n                    e.preventDefault();\n                    const $btn = $(this);\n                    const action = $btn.data('action');\n                    const containerId = $btn.data('container');\n                    const $item = $btn.closest('.stop-item');\n                    const itemIndex = $item.index();\n                    \n                    if (action === 'delete') {\n                        $item.fadeOut(200, function() {\n                            $(this).remove();\n                            self.updateStopButtons(containerId);\n                            self.debouncedCalc();\n                        });\n                    } else if (action === 'up' && itemIndex > 0) {\n                        $item.insertBefore($item.prev());\n                        self.updateStopButtons(containerId);\n                        self.debouncedCalc();\n                    } else if (action === 'down' && itemIndex < $item.siblings().length) {\n                        $item.insertAfter($item.next());\n                        self.updateStopButtons(containerId);\n                        self.debouncedCalc();\n                    }\n                });\n                \n                \/\/ Radio \u6a23\u5f0f\u66f4\u65b0\n                $(document).on('change', '.radio-item input[type=\"radio\"]', function() {\n                    const name = $(this).attr('name');\n                    $(`.radio-item input[name=\"${name}\"]`).closest('.radio-item').removeClass('selected');\n                    $(this).closest('.radio-item').addClass('selected');\n                });\n                \n                \/\/ \u50f9\u683c\u8a08\u7b97\u89f8\u767c\uff08\u6240\u6709\u76f8\u95dc\u6b04\u4f4d\u8b8a\u66f4\u6642\uff09\n                $(document).on('change', \n                    '#airport, #destination, #date, #time, #passengers, ' +\n                    '#child_seats, #booster_seats, [name=\"name_board\"], ' +\n                    '#return_date, #return_time, #return_passengers, ' +\n                    '#return_child_seats, #return_booster_seats, [name=\"return_name_board\"]', \n                    function() {\n                        if (CONFIG.debug) console.log('\ud83d\udcdd \u8868\u55ae\u6b04\u4f4d\u8b8a\u66f4\uff0c\u91cd\u65b0\u8a08\u7b97\u50f9\u683c');\n                        self.debouncedCalc();\n                    }\n                );\n                \n                \/\/ \u5730\u5740\u6b04\u4f4d\u5931\u7126\u6642\u8a08\u7b97\n                $(document).on('blur', \n                    '#pickup_address, #dropoff_address, #return_pickup_address, #return_dropoff_address, .stop-input', \n                    function() {\n                        if (CONFIG.debug) console.log('\ud83d\udccd \u5730\u5740\u6b04\u4f4d\u8b8a\u66f4\uff0c\u91cd\u65b0\u8a08\u7b97\u50f9\u683c');\n                        self.debouncedCalc();\n                    }\n                );\n                \n                \/\/ \u8868\u55ae\u63d0\u4ea4\n                $('#airport-booking-form').on('submit', function(e) {\n                    e.preventDefault();\n                    if (CONFIG.debug) console.log('\ud83d\udce4 \u63d0\u4ea4\u9810\u7d04');\n                    self.submitBooking();\n                });\n                \n                console.log('\u2705 \u4e8b\u4ef6\u7d81\u5b9a\u5b8c\u6210');\n            },\n            \n            \/\/ \u63d0\u4ea4\u9810\u7d04\n            submitBooking() {\n                if (this.state.isSubmitting) return;\n                \n                console.log('\ud83d\udccb \u958b\u59cb\u63d0\u4ea4\u9810\u7d04...');\n                \n                \/\/ \u57fa\u672c\u9a57\u8b49\n                const form = $('#airport-booking-form')[0];\n                if (!form.checkValidity()) {\n                    form.reportValidity();\n                    return;\n                }\n                \n                \/\/ \u4f86\u56de\u7a0b\u984d\u5916\u9a57\u8b49\n                if ($('[name=\"trip_type\"]:checked').val() === 'roundtrip') {\n                    const returnRequired = ['#return_date', '#return_time'];\n                    let hasError = false;\n                    \n                    returnRequired.forEach(function(field) {\n                        if (!$(field).val()) {\n                            $(field).focus();\n                            alert('\u8acb\u586b\u5beb\u56de\u7a0b\u8cc7\u8a0a');\n                            hasError = true;\n                            return false;\n                        }\n                    });\n                    \n                    if (hasError) return;\n                    \n                    \/\/ \u9a57\u8b49\u56de\u7a0b\u5730\u5740\n                    const serviceType = $('[name=\"service_type\"]:checked').val();\n                    if (serviceType === 'pickup') {\n                        if (!$('#return_pickup_address').val()) {\n                            $('#return_pickup_address').focus();\n                            alert('\u8acb\u586b\u5beb\u56de\u7a0b\u4e0a\u8eca\u5730\u5740');\n                            return;\n                        }\n                    } else {\n                        if (!$('#return_dropoff_address').val()) {\n                            $('#return_dropoff_address').focus();\n                            alert('\u8acb\u586b\u5beb\u56de\u7a0b\u4e0b\u8eca\u5730\u5740');\n                            return;\n                        }\n                    }\n                }\n                \n                this.state.isSubmitting = true;\n                $('#submit-booking, .btn-submit').prop('disabled', true)\n                    .find('.btn-text').hide().end()\n                    .find('.btn-loading').show();\n                \n                \/\/ \u6536\u96c6\u505c\u9760\u9ede\n                const stopovers = [];\n                $('#stops-container .stop-input').each(function() {\n                    const val = $(this).val().trim();\n                    if (val) stopovers.push({address: val});\n                });\n                \n                const returnStopovers = [];\n                $('#return-stops-container .stop-input').each(function() {\n                    const val = $(this).val().trim();\n                    if (val) returnStopovers.push({address: val});\n                });\n                \n                \/\/ \u6e96\u5099\u8cc7\u6599\n                const formData = $('#airport-booking-form').serialize();\n                \n                \/\/ \u4fee\u6b63 airport \u503c\u70ba\u5927\u5beb\n                let ajaxData = formData.replace(\/airport=tpe\/gi, 'airport=TPE')\n                                      .replace(\/airport=tsa\/gi, 'airport=TSA');\n                \n                ajaxData += '&action=submit_airport_booking' +\n                           '&stopovers=' + encodeURIComponent(JSON.stringify(stopovers)) +\n                           '&return_stopovers=' + encodeURIComponent(JSON.stringify(returnStopovers)) +\n                           '&total_price=' + this.state.lastTotalPrice;\n                \n                if (CONFIG.debug) console.log('\ud83d\udce4 \u63d0\u4ea4\u8cc7\u6599:', ajaxData);\n                \n                \/\/ \u63d0\u4ea4\n                $.ajax({\n                    url: CONFIG.ajaxUrl,\n                    type: 'POST',\n                    data: ajaxData,\n                    dataType: 'json',\n                    timeout: 15000,\n                    success: (res) => {\n                        if (CONFIG.debug) console.log('\u2705 \u63d0\u4ea4\u56de\u61c9:', res);\n                        \n                        if (res && res.success) {\n                            alert(res.data?.message || '\u9810\u7d04\u6210\u529f\uff01\u6211\u5011\u5c07\u76e1\u5feb\u8207\u60a8\u806f\u7e6b\u3002');\n                            \n                            \/\/ \u91cd\u7f6e\u8868\u55ae\n                            form.reset();\n                            this.state = {\n                                stopovers: [],\n                                returnStopovers: [],\n                                calcTimeout: null,\n                                isSubmitting: false,\n                                lastTotalPrice: 0\n                            };\n                            $('#stops-container').empty();\n                            $('#return-stops-container').empty();\n                            $('.return-section, .return-addon-section').hide();\n                            \n                            \/\/ \u91cd\u65b0\u521d\u59cb\u5316\n                            this.initializeForm();\n                            this.calculatePrice();\n                        } else {\n                            alert(res?.data?.message || '\u9810\u7d04\u5931\u6557\uff0c\u8acb\u6aa2\u67e5\u6240\u6709\u5fc5\u586b\u6b04\u4f4d');\n                        }\n                    },\n                    error: (xhr, status, error) => {\n                        alert('\u7cfb\u7d71\u932f\u8aa4\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66');\n                        console.error('\u274c Submit error:', status, error);\n                    },\n                    complete: () => {\n                        this.state.isSubmitting = false;\n                        $('#submit-booking, .btn-submit').prop('disabled', false)\n                            .find('.btn-text').show().end()\n                            .find('.btn-loading').hide();\n                    }\n                });\n            }\n        };\n        \n        \/\/ ========================================\n        \/\/ \u521d\u59cb\u5316\u61c9\u7528\u7a0b\u5f0f\n        \/\/ ========================================\n        console.log('\ud83d\ude80 \u6e96\u5099\u521d\u59cb\u5316\u6a5f\u5834\u63a5\u9001\u7cfb\u7d71...');\n        AirportBooking.init();\n        \n        \/\/ ========================================\n        \/\/ \u6e2c\u8a66 AJAX \u7aef\u9ede\uff08\u5075\u932f\u7528\uff09\n        \/\/ ========================================\n        if (CONFIG.debug) {\n            setTimeout(function() {\n                console.log('\ud83d\udd27 \u6e2c\u8a66 AJAX \u7aef\u9ede...');\n                $.ajax({\n                    url: CONFIG.ajaxUrl,\n                    type: 'POST',\n                    data: {\n                        action: 'test_airport_ajax'\n                    },\n                    success: function(response) {\n                        console.log('\u2705 AJAX \u6e2c\u8a66\u6210\u529f:', response);\n                    },\n                    error: function(xhr, status, error) {\n                        console.error('\u274c AJAX \u6e2c\u8a66\u5931\u6557:', status, error);\n                        console.error('\u8acb\u78ba\u8a8d AJAX \u8655\u7406\u5668\u662f\u5426\u6b63\u78ba\u8a3b\u518a');\n                    }\n                });\n            }, 3000);\n        }\n    });\n})();","scope":"site-footer-js","active":true,"priority":17,"modified":"2025-09-15 13:27:56","revision":"1"}]}