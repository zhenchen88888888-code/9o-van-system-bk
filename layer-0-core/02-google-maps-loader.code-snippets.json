{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":78,"name":"02-Google-Maps-Loader","code":"\/**\n * ============================================================================\n * Snippet: 02-Google-Maps-Loader\n * Title: Google Maps API \u8f09\u5165\u5668\n * Description: \u7ba1\u7406 Google Maps API \u7684\u8f09\u5165\u3001\u521d\u59cb\u5316\u548c\u57fa\u790e\u529f\u80fd\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-13\n * Modified: 2025-09-13\n * Priority: 3\n * Dependencies: 00-Global-Constants\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/**\n * Google Maps API \u8f09\u5165\u5668\u985e\u5225\n *\/\nclass NineOVan_Maps_Loader {\n    \n    private static $instance = null;\n    private $api_loaded = false;\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        add_action('wp_enqueue_scripts', array($this, 'enqueue_maps_api'));\n        add_action('admin_enqueue_scripts', array($this, 'enqueue_maps_api'));\n    }\n    \n    \/**\n     * \u8f09\u5165 Google Maps API\n     *\/\n    public function enqueue_maps_api() {\n        if (!$this->api_loaded) {\n            $api_url = 'https:\/\/maps.googleapis.com\/maps\/api\/js';\n            $api_params = array(\n                'key' => NINE_O_VAN_GOOGLE_API_KEY,\n                'libraries' => 'places,geometry',\n                'language' => 'zh-TW',\n                'region' => 'TW',\n                'callback' => 'initNineOVanMaps'\n            );\n            \n            wp_enqueue_script(\n                '9o-van-google-maps',\n                add_query_arg($api_params, $api_url),\n                array(),\n                null,\n                true\n            );\n            \n            \/\/ \u52a0\u5165\u521d\u59cb\u5316\u8173\u672c\n            wp_add_inline_script('9o-van-google-maps', $this->get_init_script(), 'before');\n            \n            $this->api_loaded = true;\n        }\n    }\n    \n    \/**\n     * \u53d6\u5f97\u521d\u59cb\u5316\u8173\u672c\n     *\/\n    private function get_init_script() {\n        return \"\n        window.NineOVanMaps = {\n            initialized: false,\n            geocoder: null,\n            placesService: null,\n            distanceService: null,\n            elevationService: null\n        };\n        \n        function initNineOVanMaps() {\n            if (typeof google !== 'undefined') {\n                NineOVanMaps.geocoder = new google.maps.Geocoder();\n                NineOVanMaps.distanceService = new google.maps.DistanceMatrixService();\n                NineOVanMaps.elevationService = new google.maps.ElevationService();\n                NineOVanMaps.initialized = true;\n                \n                \/\/ \u89f8\u767c\u81ea\u8a02\u4e8b\u4ef6\n                document.dispatchEvent(new Event('9o-van-maps-ready'));\n            }\n        }\";\n    }\n    \n    \/**\n     * \u5730\u5740\u8f49\u5ea7\u6a19 (Server Side)\n     *\/\n    public static function geocode($address) {\n        $url = 'https:\/\/maps.googleapis.com\/maps\/api\/geocode\/json';\n        $params = array(\n            'address' => $address,\n            'key' => NINE_O_VAN_GOOGLE_API_KEY,\n            'language' => 'zh-TW',\n            'region' => 'TW'\n        );\n        \n        $response = wp_remote_get(add_query_arg($params, $url));\n        \n        if (is_wp_error($response)) {\n            return false;\n        }\n        \n        $body = wp_remote_retrieve_body($response);\n        $data = json_decode($body, true);\n        \n        if ($data['status'] === 'OK' && !empty($data['results'])) {\n            $location = $data['results'][0]['geometry']['location'];\n            return array(\n                'lat' => $location['lat'],\n                'lng' => $location['lng'],\n                'formatted_address' => $data['results'][0]['formatted_address']\n            );\n        }\n        \n        return false;\n    }\n    \n    \/**\n     * \u8a08\u7b97\u5169\u9ede\u8ddd\u96e2 (Server Side)\n     *\/\n    public static function calculate_distance($origin, $destination) {\n        $url = 'https:\/\/maps.googleapis.com\/maps\/api\/distancematrix\/json';\n        $params = array(\n            'origins' => $origin,\n            'destinations' => $destination,\n            'key' => NINE_O_VAN_GOOGLE_API_KEY,\n            'language' => 'zh-TW',\n            'units' => 'metric'\n        );\n        \n        $response = wp_remote_get(add_query_arg($params, $url));\n        \n        if (is_wp_error($response)) {\n            return false;\n        }\n        \n        $body = wp_remote_retrieve_body($response);\n        $data = json_decode($body, true);\n        \n        if ($data['status'] === 'OK' && !empty($data['rows'][0]['elements'][0])) {\n            $element = $data['rows'][0]['elements'][0];\n            if ($element['status'] === 'OK') {\n                return array(\n                    'distance' => $element['distance']['value'] \/ 1000, \/\/ \u8f49\u63db\u70ba\u516c\u91cc\n                    'duration' => $element['duration']['value'] \/ 60,  \/\/ \u8f49\u63db\u70ba\u5206\u9418\n                    'distance_text' => $element['distance']['text'],\n                    'duration_text' => $element['duration']['text']\n                );\n            }\n        }\n        \n        return false;\n    }\n    \n    \/**\n     * \u53d6\u5f97\u6d77\u62d4\u9ad8\u5ea6 (Server Side)\n     *\/\n    public static function get_elevation($lat, $lng) {\n        $url = 'https:\/\/maps.googleapis.com\/maps\/api\/elevation\/json';\n        $params = array(\n            'locations' => \"$lat,$lng\",\n            'key' => NINE_O_VAN_GOOGLE_API_KEY\n        );\n        \n        $response = wp_remote_get(add_query_arg($params, $url));\n        \n        if (is_wp_error($response)) {\n            return false;\n        }\n        \n        $body = wp_remote_retrieve_body($response);\n        $data = json_decode($body, true);\n        \n        if ($data['status'] === 'OK' && !empty($data['results'])) {\n            return $data['results'][0]['elevation'];\n        }\n        \n        return false;\n    }\n    \n    \/**\n     * Places API \u641c\u5c0b (Server Side)\n     *\/\n    public static function search_place($query, $location = null) {\n        $url = 'https:\/\/maps.googleapis.com\/maps\/api\/place\/textsearch\/json';\n        $params = array(\n            'query' => $query,\n            'key' => NINE_O_VAN_GOOGLE_API_KEY,\n            'language' => 'zh-TW',\n            'region' => 'TW'\n        );\n        \n        if ($location) {\n            $params['location'] = $location;\n            $params['radius'] = 50000; \/\/ 50\u516c\u91cc\n        }\n        \n        $response = wp_remote_get(add_query_arg($params, $url));\n        \n        if (is_wp_error($response)) {\n            return false;\n        }\n        \n        $body = wp_remote_retrieve_body($response);\n        $data = json_decode($body, true);\n        \n        if ($data['status'] === 'OK' && !empty($data['results'])) {\n            return $data['results'];\n        }\n        \n        return false;\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\u8f09\u5165\u5668\nNineOVan_Maps_Loader::get_instance();\n\n\/**\n * \u5168\u57df\u51fd\u6578\uff1a\u5730\u5740\u8f49\u5ea7\u6a19\n *\/\nif (!function_exists('_9o_van_geocode')) {\n    function _9o_van_geocode($address) {\n        return NineOVan_Maps_Loader::geocode($address);\n    }\n}\n\n\/**\n * \u5168\u57df\u51fd\u6578\uff1a\u8a08\u7b97\u8ddd\u96e2\n *\/\nif (!function_exists('_9o_van_calculate_distance')) {\n    function _9o_van_calculate_distance($origin, $destination) {\n        return NineOVan_Maps_Loader::calculate_distance($origin, $destination);\n    }\n}\n\n\/**\n * \u5168\u57df\u51fd\u6578\uff1a\u53d6\u5f97\u6d77\u62d4\n *\/\nif (!function_exists('_9o_van_get_elevation')) {\n    function _9o_van_get_elevation($lat, $lng) {\n        return NineOVan_Maps_Loader::get_elevation($lat, $lng);\n    }\n}","active":true,"priority":3,"modified":"2025-09-13 14:20:44","revision":"1"}]}