{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":77,"name":"01-Database-Schema","code":"\/**\n * ============================================================================\n * Snippet: 01-Database-Schema\n * Title: 9o Van \u8cc7\u6599\u5eab\u67b6\u69cb\n * Description: \u5efa\u7acb\u7cfb\u7d71\u6240\u9700\u7684\u8cc7\u6599\u8868\u7d50\u69cb\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-13\n * Modified: 2025-09-13\n * Priority: 2\n * Dependencies: 00-Global-Constants\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u5efa\u7acb\u8cc7\u6599\u8868\u51fd\u6578\nif (!function_exists('_9o_van_create_tables')) {\n    function _9o_van_create_tables() {\n        global $wpdb;\n        \n        $charset_collate = $wpdb->get_charset_collate();\n        \n        \/\/ \u9810\u7d04\u4e3b\u8868\n        $table_bookings = $wpdb->prefix . '9o_van_bookings';\n        $sql_bookings = \"CREATE TABLE IF NOT EXISTS $table_bookings (\n            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,\n            booking_number varchar(20) NOT NULL,\n            service_type varchar(20) NOT NULL,\n            status varchar(20) NOT NULL DEFAULT 'pending',\n            customer_name varchar(100) NOT NULL,\n            customer_phone varchar(20) NOT NULL,\n            customer_email varchar(100),\n            service_date date NOT NULL,\n            service_time time NOT NULL,\n            service_data longtext,\n            price_data longtext,\n            total_amount decimal(10,2) NOT NULL,\n            payment_status varchar(20) NOT NULL DEFAULT 'pending',\n            notes text,\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            UNIQUE KEY booking_number (booking_number),\n            KEY service_type (service_type),\n            KEY status (status),\n            KEY service_date (service_date)\n        ) $charset_collate;\";\n        \n        \/\/ \u4ed8\u6b3e\u8a18\u9304\u8868\n        $table_payments = $wpdb->prefix . '9o_van_payments';\n        $sql_payments = \"CREATE TABLE IF NOT EXISTS $table_payments (\n            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,\n            booking_id bigint(20) UNSIGNED NOT NULL,\n            order_id bigint(20) UNSIGNED,\n            gateway varchar(50) NOT NULL,\n            transaction_id varchar(100),\n            amount decimal(10,2) NOT NULL,\n            currency varchar(3) DEFAULT 'TWD',\n            status varchar(20) NOT NULL,\n            gateway_response longtext,\n            paid_at datetime,\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            KEY booking_id (booking_id),\n            KEY status (status)\n        ) $charset_collate;\";\n        \n        \/\/ \u53f8\u6a5f\u6d3e\u55ae\u8868\n        $table_assignments = $wpdb->prefix . '9o_van_assignments';\n        $sql_assignments = \"CREATE TABLE IF NOT EXISTS $table_assignments (\n            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,\n            booking_id bigint(20) UNSIGNED NOT NULL,\n            driver_id bigint(20) UNSIGNED,\n            driver_name varchar(100),\n            vehicle_info varchar(200),\n            status varchar(20) NOT NULL DEFAULT 'pending',\n            notes text,\n            assigned_at datetime,\n            completed_at datetime,\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            KEY booking_id (booking_id),\n            KEY status (status)\n        ) $charset_collate;\";\n        \n        \/\/ \u7cfb\u7d71\u65e5\u8a8c\u8868\n        $table_logs = $wpdb->prefix . '9o_van_logs';\n        $sql_logs = \"CREATE TABLE IF NOT EXISTS $table_logs (\n            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,\n            level varchar(20) NOT NULL,\n            component varchar(50) NOT NULL,\n            message text NOT NULL,\n            context longtext,\n            user_id bigint(20) UNSIGNED,\n            ip_address varchar(45),\n            created_at datetime DEFAULT CURRENT_TIMESTAMP,\n            PRIMARY KEY (id),\n            KEY level (level),\n            KEY component (component),\n            KEY created_at (created_at)\n        ) $charset_collate;\";\n        \n        \/\/ \u57f7\u884c\u5efa\u7acb\u8cc7\u6599\u8868\n        require_once(ABSPATH . 'wp-admin\/includes\/upgrade.php');\n        dbDelta($sql_bookings);\n        dbDelta($sql_payments);\n        dbDelta($sql_assignments);\n        dbDelta($sql_logs);\n        \n        \/\/ \u6a19\u8a18\u8cc7\u6599\u8868\u5df2\u5efa\u7acb\n        update_option('9o_van_tables_created', true);\n        \n        return true;\n    }\n}\n\n\/\/ \u5728 admin_init \u6642\u6aa2\u67e5\u4e26\u5efa\u7acb\u8cc7\u6599\u8868\nadd_action('admin_init', function() {\n    \/\/ \u53ea\u5728\u5f8c\u53f0\u57f7\u884c\uff0c\u907f\u514d\u524d\u53f0\u8f09\u5165\n    if (!is_admin()) {\n        return;\n    }\n    \n    \/\/ \u6aa2\u67e5\u662f\u5426\u5df2\u5efa\u7acb\n    $tables_created = get_option('9o_van_tables_created', false);\n    \n    if (!$tables_created) {\n        _9o_van_create_tables();\n    }\n    \n    \/\/ \u63d0\u4f9b\u624b\u52d5\u91cd\u5efa\u8cc7\u6599\u8868\u7684\u9078\u9805\n    if (isset($_GET['9o_van_rebuild_tables']) && current_user_can('manage_options')) {\n        delete_option('9o_van_tables_created');\n        _9o_van_create_tables();\n        wp_redirect(remove_query_arg('9o_van_rebuild_tables'));\n        exit;\n    }\n});\n\n\/\/ \u63d0\u4f9b\u624b\u52d5\u5efa\u7acb\u8cc7\u6599\u8868\u7684\u9023\u7d50\uff08\u7528\u65bc\u9664\u932f\uff09\nadd_action('admin_notices', function() {\n    if (isset($_GET['page']) && strpos($_GET['page'], '9o-van') !== false) {\n        if (!get_option('9o_van_tables_created', false)) {\n            echo '<div class=\"notice notice-warning\"><p>';\n            echo '9o Van \u8cc7\u6599\u8868\u5c1a\u672a\u5efa\u7acb\u3002';\n            echo ' <a href=\"' . add_query_arg('9o_van_rebuild_tables', '1') . '\">\u7acb\u5373\u5efa\u7acb<\/a>';\n            echo '<\/p><\/div>';\n        }\n    }\n});","active":true,"priority":2,"modified":"2025-09-13 14:20:14","revision":"1"}]}