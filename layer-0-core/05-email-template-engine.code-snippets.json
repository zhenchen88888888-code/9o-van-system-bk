{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":81,"name":"05-Email-Template-Engine","code":"\/**\n * ============================================================================\n * Snippet: 05-Email-Template-Engine\n * Title: 9o Van \u90f5\u4ef6\u6a21\u677f\u5f15\u64ce\n * Description: \u63d0\u4f9b\u90f5\u4ef6\u6a21\u677f\u7ba1\u7406\u3001\u8b8a\u6578\u66ff\u63db\u3001HTML\/\u7d14\u6587\u5b57\u90f5\u4ef6\u767c\u9001\u529f\u80fd\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-13\n * Modified: 2025-09-13\n * Priority: 6\n * Dependencies: 00-Global-Constants, 03-Common-Utilities\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/**\n * \u90f5\u4ef6\u6a21\u677f\u5f15\u64ce\u985e\u5225\n *\/\nclass NineOVan_Email_Engine {\n    \n    private static $instance = null;\n    private $templates = array();\n    private $default_headers = array();\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        $this->init_templates();\n        $this->set_default_headers();\n        \n        \/\/ \u8a2d\u5b9a HTML \u90f5\u4ef6\n        add_filter('wp_mail_content_type', array($this, 'set_html_content_type'));\n        add_filter('wp_mail_from', array($this, 'set_mail_from'));\n        add_filter('wp_mail_from_name', array($this, 'set_mail_from_name'));\n    }\n    \n    \/**\n     * \u521d\u59cb\u5316\u90f5\u4ef6\u6a21\u677f\n     *\/\n    private function init_templates() {\n        \/\/ \u5ba2\u6236\u78ba\u8a8d\u4fe1\u6a21\u677f\n        $this->templates['customer_confirmation'] = array(\n            'subject' => '\u30109o Van\u3011\u9810\u7d04\u78ba\u8a8d - \u8a02\u55ae\u7de8\u865f {{booking_number}}',\n            'body' => $this->get_customer_confirmation_template()\n        );\n        \n        \/\/ \u7ba1\u7406\u54e1\u901a\u77e5\u6a21\u677f\n        $this->templates['admin_notification'] = array(\n            'subject' => '\u3010\u65b0\u9810\u7d04\u3011{{service_type}} - {{customer_name}}',\n            'body' => $this->get_admin_notification_template()\n        );\n        \n        \/\/ \u4ed8\u6b3e\u6210\u529f\u6a21\u677f\n        $this->templates['payment_success'] = array(\n            'subject' => '\u30109o Van\u3011\u4ed8\u6b3e\u6210\u529f\u901a\u77e5 - \u8a02\u55ae\u7de8\u865f {{booking_number}}',\n            'body' => $this->get_payment_success_template()\n        );\n        \n        \/\/ \u9810\u7d04\u53d6\u6d88\u6a21\u677f\n        $this->templates['booking_cancelled'] = array(\n            'subject' => '\u30109o Van\u3011\u9810\u7d04\u53d6\u6d88\u901a\u77e5 - \u8a02\u55ae\u7de8\u865f {{booking_number}}',\n            'body' => $this->get_cancellation_template()\n        );\n        \n        \/\/ \u53f8\u6a5f\u6d3e\u55ae\u901a\u77e5\n        $this->templates['driver_assignment'] = array(\n            'subject' => '\u3010\u6d3e\u55ae\u901a\u77e5\u3011{{service_date}} {{service_type}}',\n            'body' => $this->get_driver_assignment_template()\n        );\n        \n        \/\/ \u63d0\u9192\u901a\u77e5\n        $this->templates['service_reminder'] = array(\n            'subject' => '\u30109o Van\u3011\u670d\u52d9\u63d0\u9192 - \u660e\u65e5 {{service_time}}',\n            'body' => $this->get_reminder_template()\n        );\n    }\n    \n    \/**\n     * \u8a2d\u5b9a\u9810\u8a2d\u90f5\u4ef6\u6a19\u982d\n     *\/\n    private function set_default_headers() {\n        $this->default_headers = array(\n            'Content-Type: text\/html; charset=UTF-8',\n            'From: ' . NINE_O_VAN_FROM_NAME . ' <' . NINE_O_VAN_FROM_EMAIL . '>'\n        );\n    }\n    \n    \/**\n     * \u767c\u9001\u90f5\u4ef6\n     *\/\n    public function send($to, $template_name, $variables = array(), $attachments = array()) {\n        if (!isset($this->templates[$template_name])) {\n            _9o_van_debug('\u90f5\u4ef6\u6a21\u677f\u4e0d\u5b58\u5728: ' . $template_name);\n            return false;\n        }\n        \n        $template = $this->templates[$template_name];\n        \n        \/\/ \u66ff\u63db\u8b8a\u6578\n        $subject = $this->replace_variables($template['subject'], $variables);\n        $body = $this->replace_variables($template['body'], $variables);\n        \n        \/\/ \u5305\u88dd HTML\n        $body = $this->wrap_html($body);\n        \n        \/\/ \u767c\u9001\u90f5\u4ef6\n        $result = wp_mail($to, $subject, $body, $this->default_headers, $attachments);\n        \n        \/\/ \u8a18\u9304\u65e5\u8a8c\n        $this->log_email($to, $template_name, $result);\n        \n        return $result;\n    }\n    \n    \/**\n     * \u66ff\u63db\u6a21\u677f\u8b8a\u6578\n     *\/\n    private function replace_variables($content, $variables) {\n        foreach ($variables as $key => $value) {\n            \/\/ \u8655\u7406\u9663\u5217\u548c\u7269\u4ef6\n            if (is_array($value) || is_object($value)) {\n                $value = _9o_van_json_encode($value);\n            }\n            \n            $content = str_replace('{{' . $key . '}}', $value, $content);\n        }\n        \n        \/\/ \u6e05\u9664\u672a\u66ff\u63db\u7684\u8b8a\u6578\n        $content = preg_replace('\/\\{\\{.*?\\}\\}\/', '', $content);\n        \n        return $content;\n    }\n    \n    \/**\n     * \u5305\u88dd HTML \u6846\u67b6\n     *\/\n    private function wrap_html($body) {\n        $wrapper = '\n        <!DOCTYPE html>\n        <html lang=\"zh-TW\">\n        <head>\n            <meta charset=\"UTF-8\">\n            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n            <title>9o Van Strip<\/title>\n            <style>\n                body {\n                    font-family: \"Microsoft JhengHei\", Arial, sans-serif;\n                    line-height: 1.6;\n                    color: #333;\n                    max-width: 600px;\n                    margin: 0 auto;\n                    padding: 20px;\n                    background-color: #f5f5f5;\n                }\n                .email-container {\n                    background: white;\n                    border-radius: 8px;\n                    padding: 30px;\n                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                }\n                .header {\n                    text-align: center;\n                    padding-bottom: 20px;\n                    border-bottom: 2px solid #e74c3c;\n                    margin-bottom: 30px;\n                }\n                .header h1 {\n                    color: #e74c3c;\n                    margin: 0;\n                    font-size: 28px;\n                }\n                .content {\n                    padding: 20px 0;\n                }\n                .info-table {\n                    width: 100%;\n                    border-collapse: collapse;\n                    margin: 20px 0;\n                }\n                .info-table th,\n                .info-table td {\n                    padding: 10px;\n                    text-align: left;\n                    border-bottom: 1px solid #eee;\n                }\n                .info-table th {\n                    background-color: #f8f8f8;\n                    font-weight: bold;\n                    width: 30%;\n                }\n                .price-section {\n                    background: #f8f8f8;\n                    padding: 15px;\n                    border-radius: 5px;\n                    margin: 20px 0;\n                }\n                .total-price {\n                    font-size: 24px;\n                    color: #e74c3c;\n                    font-weight: bold;\n                    text-align: right;\n                    margin-top: 10px;\n                }\n                .footer {\n                    margin-top: 30px;\n                    padding-top: 20px;\n                    border-top: 1px solid #eee;\n                    text-align: center;\n                    color: #666;\n                    font-size: 14px;\n                }\n                .button {\n                    display: inline-block;\n                    padding: 12px 30px;\n                    background-color: #e74c3c;\n                    color: white;\n                    text-decoration: none;\n                    border-radius: 5px;\n                    margin: 10px 0;\n                }\n                .notice {\n                    background: #fff3cd;\n                    border-left: 4px solid #ffc107;\n                    padding: 10px 15px;\n                    margin: 15px 0;\n                }\n                .success {\n                    background: #d4edda;\n                    border-left: 4px solid #28a745;\n                    padding: 10px 15px;\n                    margin: 15px 0;\n                }\n            <\/style>\n        <\/head>\n        <body>\n            <div class=\"email-container\">\n                ' . $body . '\n                <div class=\"footer\">\n                    <p>9o Van Strip - \u5c08\u696d\u6a5f\u5834\u63a5\u9001\u8207\u5305\u8eca\u670d\u52d9<\/p>\n                    <p>\u5ba2\u670d\u96fb\u8a71\uff1a0800-123-456 | Email\uff1aservice@9ovanstrip.com<\/p>\n                    <p>\u00a9 2025 9o Van Strip. All rights reserved.<\/p>\n                <\/div>\n            <\/div>\n        <\/body>\n        <\/html>';\n        \n        return $wrapper;\n    }\n    \n    \/**\n     * \u8a18\u9304\u90f5\u4ef6\u767c\u9001\u65e5\u8a8c\n     *\/\n    private function log_email($to, $template, $success) {\n        _9o_van_log(\n            $success ? 'info' : 'error',\n            'email',\n            sprintf('\u90f5\u4ef6\u767c\u9001 %s: %s - %s', \n                $success ? '\u6210\u529f' : '\u5931\u6557',\n                $template,\n                is_array($to) ? implode(',', $to) : $to\n            ),\n            array(\n                'template' => $template,\n                'to' => $to,\n                'success' => $success\n            )\n        );\n    }\n    \n    \/**\n     * \u8a2d\u5b9a\u90f5\u4ef6\u5167\u5bb9\u985e\u578b\n     *\/\n    public function set_html_content_type() {\n        return 'text\/html';\n    }\n    \n    \/**\n     * \u8a2d\u5b9a\u5bc4\u4ef6\u8005\u4fe1\u7bb1\n     *\/\n    public function set_mail_from() {\n        return NINE_O_VAN_FROM_EMAIL;\n    }\n    \n    \/**\n     * \u8a2d\u5b9a\u5bc4\u4ef6\u8005\u540d\u7a31\n     *\/\n    public function set_mail_from_name() {\n        return NINE_O_VAN_FROM_NAME;\n    }\n    \n    \/\/ ===== \u90f5\u4ef6\u6a21\u677f\u5167\u5bb9 =====\n    \n    \/**\n     * \u5ba2\u6236\u78ba\u8a8d\u4fe1\u6a21\u677f\n     *\/\n    private function get_customer_confirmation_template() {\n        return '\n        <div class=\"header\">\n            <h1>9o Van Strip<\/h1>\n            <p>\u611f\u8b1d\u60a8\u7684\u9810\u7d04\uff01<\/p>\n        <\/div>\n        \n        <div class=\"content\">\n            <p>\u89aa\u611b\u7684 {{customer_name}} \u60a8\u597d\uff1a<\/p>\n            <p>\u60a8\u7684\u9810\u7d04\u5df2\u6210\u529f\u5efa\u7acb\uff0c\u4ee5\u4e0b\u662f\u60a8\u7684\u9810\u7d04\u8a73\u60c5\uff1a<\/p>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u8a02\u55ae\u7de8\u865f<\/th>\n                    <td>{{booking_number}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u985e\u578b<\/th>\n                    <td>{{service_type_display}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u65e5\u671f<\/th>\n                    <td>{{service_date}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u6642\u9593<\/th>\n                    <td>{{service_time}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4e0a\u8eca\u5730\u9ede<\/th>\n                    <td>{{pickup_location}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4e0b\u8eca\u5730\u9ede<\/th>\n                    <td>{{dropoff_location}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            <div class=\"price-section\">\n                <h3>\u8cbb\u7528\u660e\u7d30<\/h3>\n                {{price_breakdown}}\n                <div class=\"total-price\">\n                    \u7e3d\u8a08\uff1aNT$ {{total_amount}}\n                <\/div>\n            <\/div>\n            \n            <div class=\"notice\">\n                <strong>\u91cd\u8981\u63d0\u9192\uff1a<\/strong>\n                <ul>\n                    <li>\u8acb\u65bc\u642d\u8eca\u524d10\u5206\u9418\u62b5\u9054\u6307\u5b9a\u5730\u9ede<\/li>\n                    <li>\u5982\u9700\u4fee\u6539\u6216\u53d6\u6d88\uff0c\u8acb\u63d0\u524d24\u5c0f\u6642\u901a\u77e5<\/li>\n                    <li>\u53f8\u6a5f\u8cc7\u8a0a\u5c07\u65bc\u670d\u52d9\u524d\u4e00\u5929\u767c\u9001\u7d66\u60a8<\/li>\n                <\/ul>\n            <\/div>\n            \n            {{payment_instructions}}\n        <\/div>';\n    }\n    \n    \/**\n     * \u7ba1\u7406\u54e1\u901a\u77e5\u6a21\u677f\n     *\/\n    private function get_admin_notification_template() {\n        return '\n        <div class=\"header\">\n            <h1>\u65b0\u9810\u7d04\u901a\u77e5<\/h1>\n        <\/div>\n        \n        <div class=\"content\">\n            <div class=\"success\">\n                <strong>\u6709\u65b0\u7684\u9810\u7d04\u8a02\u55ae\uff01<\/strong>\n            <\/div>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u8a02\u55ae\u7de8\u865f<\/th>\n                    <td>{{booking_number}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u5ba2\u6236\u59d3\u540d<\/th>\n                    <td>{{customer_name}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u806f\u7d61\u96fb\u8a71<\/th>\n                    <td>{{customer_phone}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>Email<\/th>\n                    <td>{{customer_email}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u985e\u578b<\/th>\n                    <td>{{service_type_display}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u65e5\u671f\u6642\u9593<\/th>\n                    <td>{{service_date}} {{service_time}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u7e3d\u91d1\u984d<\/th>\n                    <td>NT$ {{total_amount}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            <h3>\u670d\u52d9\u8a73\u60c5<\/h3>\n            {{service_details}}\n            \n            <h3>\u5099\u8a3b<\/h3>\n            <p>{{notes}}<\/p>\n            \n            <div style=\"text-align: center; margin-top: 30px;\">\n                <a href=\"{{admin_url}}\" class=\"button\">\u524d\u5f80\u5f8c\u53f0\u7ba1\u7406<\/a>\n            <\/div>\n        <\/div>';\n    }\n    \n    \/**\n     * \u4ed8\u6b3e\u6210\u529f\u6a21\u677f\n     *\/\n    private function get_payment_success_template() {\n        return '\n        <div class=\"header\">\n            <h1>\u4ed8\u6b3e\u6210\u529f<\/h1>\n        <\/div>\n        \n        <div class=\"content\">\n            <div class=\"success\">\n                <strong>\u60a8\u7684\u4ed8\u6b3e\u5df2\u6210\u529f\u5b8c\u6210\uff01<\/strong>\n            <\/div>\n            \n            <p>\u89aa\u611b\u7684 {{customer_name}} \u60a8\u597d\uff1a<\/p>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u8a02\u55ae\u7de8\u865f<\/th>\n                    <td>{{booking_number}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4ed8\u6b3e\u91d1\u984d<\/th>\n                    <td>NT$ {{payment_amount}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4ed8\u6b3e\u65b9\u5f0f<\/th>\n                    <td>{{payment_method}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4ea4\u6613\u7de8\u865f<\/th>\n                    <td>{{transaction_id}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4ed8\u6b3e\u6642\u9593<\/th>\n                    <td>{{payment_time}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            <p>\u6211\u5011\u5df2\u6536\u5230\u60a8\u7684\u4ed8\u6b3e\uff0c\u670d\u52d9\u8a73\u60c5\u5c07\u53e6\u884c\u901a\u77e5\u3002<\/p>\n        <\/div>';\n    }\n    \n    \/**\n     * \u53d6\u6d88\u901a\u77e5\u6a21\u677f\n     *\/\n    private function get_cancellation_template() {\n        return '\n        <div class=\"header\">\n            <h1>\u9810\u7d04\u53d6\u6d88\u901a\u77e5<\/h1>\n        <\/div>\n        \n        <div class=\"content\">\n            <p>\u89aa\u611b\u7684 {{customer_name}} \u60a8\u597d\uff1a<\/p>\n            <p>\u60a8\u7684\u9810\u7d04\u5df2\u6210\u529f\u53d6\u6d88\u3002<\/p>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u8a02\u55ae\u7de8\u865f<\/th>\n                    <td>{{booking_number}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u53d6\u6d88\u6642\u9593<\/th>\n                    <td>{{cancel_time}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u53d6\u6d88\u539f\u56e0<\/th>\n                    <td>{{cancel_reason}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            {{refund_info}}\n            \n            <p>\u671f\u5f85\u4e0b\u6b21\u70ba\u60a8\u670d\u52d9\uff01<\/p>\n        <\/div>';\n    }\n    \n    \/**\n     * \u53f8\u6a5f\u6d3e\u55ae\u6a21\u677f\n     *\/\n    private function get_driver_assignment_template() {\n        return '\n        <div class=\"header\">\n            <h1>\u6d3e\u55ae\u901a\u77e5<\/h1>\n        <\/div>\n        \n        <div class=\"content\">\n            <p>\u60a8\u6709\u65b0\u7684\u6d3e\u55ae\u4efb\u52d9\uff1a<\/p>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u8a02\u55ae\u7de8\u865f<\/th>\n                    <td>{{booking_number}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u65e5\u671f<\/th>\n                    <td>{{service_date}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u6642\u9593<\/th>\n                    <td>{{service_time}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u5ba2\u6236\u59d3\u540d<\/th>\n                    <td>{{customer_name}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u806f\u7d61\u96fb\u8a71<\/th>\n                    <td>{{customer_phone}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            <h3>\u8def\u7dda\u8cc7\u8a0a<\/h3>\n            {{route_details}}\n            \n            <div style=\"text-align: center; margin-top: 30px;\">\n                <a href=\"{{confirm_url}}\" class=\"button\">\u78ba\u8a8d\u63a5\u55ae<\/a>\n            <\/div>\n        <\/div>';\n    }\n    \n    \/**\n     * \u670d\u52d9\u63d0\u9192\u6a21\u677f\n     *\/\n    private function get_reminder_template() {\n        return '\n        <div class=\"header\">\n            <h1>\u670d\u52d9\u63d0\u9192<\/h1>\n        <\/div>\n        \n        <div class=\"content\">\n            <p>\u89aa\u611b\u7684 {{customer_name}} \u60a8\u597d\uff1a<\/p>\n            <p>\u63d0\u9192\u60a8\uff0c\u660e\u5929\u6709\u9810\u7d04\u7684\u670d\u52d9\uff1a<\/p>\n            \n            <table class=\"info-table\">\n                <tr>\n                    <th>\u670d\u52d9\u65e5\u671f<\/th>\n                    <td>{{service_date}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u670d\u52d9\u6642\u9593<\/th>\n                    <td>{{service_time}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u4e0a\u8eca\u5730\u9ede<\/th>\n                    <td>{{pickup_location}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u53f8\u6a5f\u59d3\u540d<\/th>\n                    <td>{{driver_name}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u53f8\u6a5f\u96fb\u8a71<\/th>\n                    <td>{{driver_phone}}<\/td>\n                <\/tr>\n                <tr>\n                    <th>\u8eca\u724c\u865f\u78bc<\/th>\n                    <td>{{vehicle_number}}<\/td>\n                <\/tr>\n            <\/table>\n            \n            <div class=\"notice\">\n                <strong>\u6eab\u99a8\u63d0\u9192\uff1a<\/strong>\n                <ul>\n                    <li>\u8acb\u63d0\u524d10\u5206\u9418\u5230\u9054\u4e0a\u8eca\u5730\u9ede<\/li>\n                    <li>\u8acb\u6e96\u5099\u597d\u76f8\u95dc\u8b49\u4ef6<\/li>\n                    <li>\u5982\u6709\u4efb\u4f55\u554f\u984c\uff0c\u8acb\u806f\u7e6b\u53f8\u6a5f\u6216\u5ba2\u670d<\/li>\n                <\/ul>\n            <\/div>\n        <\/div>';\n    }\n}\n\n\/\/ \u521d\u59cb\u5316\u90f5\u4ef6\u5f15\u64ce\nNineOVan_Email_Engine::get_instance();\n\n\/**\n * \u5168\u57df\u51fd\u6578\uff1a\u767c\u9001\u90f5\u4ef6\n *\/\nif (!function_exists('_9o_van_send_email')) {\n    function _9o_van_send_email($to, $template, $variables = array(), $attachments = array()) {\n        $engine = NineOVan_Email_Engine::get_instance();\n        return $engine->send($to, $template, $variables, $attachments);\n    }\n}","active":true,"priority":6,"modified":"2025-09-13 14:25:52","revision":"1"}]}