{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":79,"name":"03-Common-Utilities","code":"\/**\n * ============================================================================\n * Snippet: 03-Common-Utilities\n * Title: 9o Van \u5171\u7528\u5de5\u5177\u51fd\u6578\n * Description: \u63d0\u4f9b\u7cfb\u7d71\u5171\u7528\u7684\u5de5\u5177\u51fd\u6578\uff0c\u5982\u683c\u5f0f\u5316\u3001\u9a57\u8b49\u3001\u8f49\u63db\u7b49\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-13\n * Modified: 2025-09-13\n * Priority: 4\n * Dependencies: 00-Global-Constants\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/**\n * \u683c\u5f0f\u5316\u96fb\u8a71\u865f\u78bc\u70ba\u570b\u969b\u683c\u5f0f\n *\/\nif (!function_exists('_9o_van_format_phone')) {\n    function _9o_van_format_phone($phone) {\n        \/\/ \u79fb\u9664\u6240\u6709\u975e\u6578\u5b57\u5b57\u7b26\n        $phone = preg_replace('\/[^0-9+]\/', '', $phone);\n        \n        \/\/ \u5982\u679c\u662f\u53f0\u7063\u624b\u6a5f\u865f\u78bc\u683c\u5f0f\n        if (preg_match('\/^09[0-9]{8}$\/', $phone)) {\n            return '+886' . substr($phone, 1);\n        }\n        \n        \/\/ \u5982\u679c\u5df2\u7d93\u662f\u570b\u969b\u683c\u5f0f\n        if (strpos($phone, '+886') === 0) {\n            return $phone;\n        }\n        \n        \/\/ \u5982\u679c\u662f886\u958b\u982d\u4f46\u6c92\u6709+\n        if (strpos($phone, '886') === 0) {\n            return '+' . $phone;\n        }\n        \n        return $phone;\n    }\n}\n\n\/**\n * \u9a57\u8b49\u96fb\u8a71\u865f\u78bc\n *\/\nif (!function_exists('_9o_van_validate_phone')) {\n    function _9o_van_validate_phone($phone) {\n        $phone = _9o_van_format_phone($phone);\n        \n        \/\/ \u53f0\u7063\u624b\u6a5f\u865f\u78bc\u683c\u5f0f\n        if (preg_match('\/^\\+8869[0-9]{8}$\/', $phone)) {\n            return true;\n        }\n        \n        \/\/ \u53f0\u7063\u5e02\u8a71\u683c\u5f0f\n        if (preg_match('\/^\\+886[2-8][0-9]{7,8}$\/', $phone)) {\n            return true;\n        }\n        \n        return false;\n    }\n}\n\n\/**\n * \u9a57\u8b49Email\n *\/\nif (!function_exists('_9o_van_validate_email')) {\n    function _9o_van_validate_email($email) {\n        return filter_var($email, FILTER_VALIDATE_EMAIL) !== false;\n    }\n}\n\n\/**\n * \u683c\u5f0f\u5316\u91d1\u984d\n *\/\nif (!function_exists('_9o_van_format_price')) {\n    function _9o_van_format_price($price, $currency = 'NT$') {\n        return $currency . ' ' . number_format($price, 0, '.', ',');\n    }\n}\n\n\/**\n * \u7522\u751f\u8a02\u55ae\u7de8\u865f\n *\/\nif (!function_exists('_9o_van_generate_booking_number')) {\n    function _9o_van_generate_booking_number($prefix = '') {\n        $date = date('Ymd');\n        $random = strtoupper(substr(md5(uniqid()), 0, 4));\n        return $prefix . $date . $random;\n    }\n}\n\n\/**\n * \u53d6\u5f97\u7e23\u5e02\u5c0d\u61c9\u8868\n *\/\nif (!function_exists('_9o_van_get_city_mapping')) {\n    function _9o_van_get_city_mapping() {\n        return array(\n            'taipei' => '\u53f0\u5317\u5e02',\n            'new_taipei' => '\u65b0\u5317\u5e02',\n            'keelung' => '\u57fa\u9686\u5e02',\n            'taoyuan' => '\u6843\u5712\u5e02',\n            'hsinchu' => '\u65b0\u7af9',\n            'miaoli' => '\u82d7\u6817\u7e23',\n            'taichung' => '\u53f0\u4e2d\u5e02',\n            'changhua' => '\u5f70\u5316\u7e23',\n            'nantou' => '\u5357\u6295\u7e23',\n            'yunlin' => '\u96f2\u6797\u7e23',\n            'chiayi' => '\u5609\u7fa9',\n            'tainan' => '\u53f0\u5357\u5e02',\n            'kaohsiung' => '\u9ad8\u96c4\u5e02',\n            'pingtung' => '\u5c4f\u6771\u7e23',\n            'yilan' => '\u5b9c\u862d\u7e23',\n            'hualien' => '\u82b1\u84ee\u7e23',\n            'taitung' => '\u53f0\u6771\u7e23',\n            'penghu' => '\u6f8e\u6e56\u7e23',\n            'kinmen' => '\u91d1\u9580\u7e23',\n            'lienchiang' => '\u9023\u6c5f\u7e23'\n        );\n    }\n}\n\n\/**\n * \u5224\u65b7\u5730\u5740\u6240\u5728\u7e23\u5e02\n *\/\nif (!function_exists('_9o_van_detect_city')) {\n    function _9o_van_detect_city($address) {\n        $cities = array(\n            '\u53f0\u5317\u5e02', '\u81fa\u5317\u5e02', '\u65b0\u5317\u5e02', '\u57fa\u9686\u5e02', '\u6843\u5712\u5e02',\n            '\u65b0\u7af9\u5e02', '\u65b0\u7af9\u7e23', '\u82d7\u6817\u7e23', '\u53f0\u4e2d\u5e02', '\u81fa\u4e2d\u5e02',\n            '\u5f70\u5316\u7e23', '\u5357\u6295\u7e23', '\u96f2\u6797\u7e23', '\u5609\u7fa9\u5e02', '\u5609\u7fa9\u7e23',\n            '\u53f0\u5357\u5e02', '\u81fa\u5357\u5e02', '\u9ad8\u96c4\u5e02', '\u5c4f\u6771\u7e23', '\u5b9c\u862d\u7e23',\n            '\u82b1\u84ee\u7e23', '\u53f0\u6771\u5e02', '\u81fa\u6771\u7e23', '\u6f8e\u6e56\u7e23', '\u91d1\u9580\u7e23', '\u9023\u6c5f\u7e23'\n        );\n        \n        foreach ($cities as $city) {\n            if (strpos($address, $city) !== false) {\n                return $city;\n            }\n        }\n        \n        return false;\n    }\n}\n\n\/**\n * \u5b89\u5168\u7684JSON\u7de8\u78bc\n *\/\nif (!function_exists('_9o_van_json_encode')) {\n    function _9o_van_json_encode($data) {\n        return json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);\n    }\n}\n\n\/**\n * \u5b89\u5168\u7684JSON\u89e3\u78bc\n *\/\nif (!function_exists('_9o_van_json_decode')) {\n    function _9o_van_json_decode($json, $assoc = true) {\n        if (empty($json)) {\n            return $assoc ? array() : new stdClass();\n        }\n        \n        $result = json_decode($json, $assoc);\n        \n        if (json_last_error() !== JSON_ERROR_NONE) {\n            return $assoc ? array() : new stdClass();\n        }\n        \n        return $result;\n    }\n}\n\n\/**\n * \u8a18\u9304\u9664\u932f\u8a0a\u606f\n *\/\nif (!function_exists('_9o_van_debug')) {\n    function _9o_van_debug($message, $data = null) {\n        if (!defined('NINE_O_VAN_DEBUG') || !NINE_O_VAN_DEBUG) {\n            return;\n        }\n        \n        if (is_array($message) || is_object($message)) {\n            $message = print_r($message, true);\n        }\n        \n        if ($data !== null) {\n            $message .= ' | Data: ' . print_r($data, true);\n        }\n        \n        error_log('[9o Van Debug] ' . $message);\n    }\n}\n\n\/**\n * \u6e05\u7406\u7528\u6236\u8f38\u5165\n *\/\nif (!function_exists('_9o_van_sanitize_input')) {\n    function _9o_van_sanitize_input($input, $type = 'text') {\n        switch ($type) {\n            case 'email':\n                return sanitize_email($input);\n            case 'phone':\n                return preg_replace('\/[^0-9+\\-\\s()]\/', '', $input);\n            case 'number':\n                return intval($input);\n            case 'price':\n                return floatval($input);\n            case 'date':\n                return preg_replace('\/[^0-9\\-]\/', '', $input);\n            case 'time':\n                return preg_replace('\/[^0-9:]\/', '', $input);\n            case 'textarea':\n                return sanitize_textarea_field($input);\n            default:\n                return sanitize_text_field($input);\n        }\n    }\n}\n\n\/**\n * \u53d6\u5f97IP\u5730\u5740\n *\/\nif (!function_exists('_9o_van_get_client_ip')) {\n    function _9o_van_get_client_ip() {\n        $ip_keys = array('HTTP_CLIENT_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR');\n        \n        foreach ($ip_keys as $key) {\n            if (array_key_exists($key, $_SERVER) === true) {\n                $ip = $_SERVER[$key];\n                if (strpos($ip, ',') !== false) {\n                    $ip = explode(',', $ip)[0];\n                }\n                \n                if (filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) {\n                    return $ip;\n                }\n            }\n        }\n        \n        return isset($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_ADDR'] : '0.0.0.0';\n    }\n}\n\n\/**\n * \u8a18\u9304\u7cfb\u7d71\u65e5\u8a8c\n *\/\nif (!function_exists('_9o_van_log')) {\n    function _9o_van_log($level, $component, $message, $context = array()) {\n        global $wpdb;\n        \n        if (!defined('NINE_O_VAN_LOG_ERRORS') || !NINE_O_VAN_LOG_ERRORS) {\n            return;\n        }\n        \n        $table = _9o_van_table('logs');\n        \n        if (!$table) {\n            return;\n        }\n        \n        $wpdb->insert(\n            $table,\n            array(\n                'level' => $level,\n                'component' => $component,\n                'message' => $message,\n                'context' => _9o_van_json_encode($context),\n                'user_id' => get_current_user_id(),\n                'ip_address' => _9o_van_get_client_ip()\n            )\n        );\n    }\n}\n\n\/**\n * \u6aa2\u67e5\u662f\u5426\u70ba\u624b\u6a5f\u88dd\u7f6e\n *\/\nif (!function_exists('_9o_van_is_mobile')) {\n    function _9o_van_is_mobile() {\n        if (empty($_SERVER['HTTP_USER_AGENT'])) {\n            return false;\n        }\n        \n        $user_agent = $_SERVER['HTTP_USER_AGENT'];\n        $mobile_agents = array(\n            'Mobile', 'Android', 'iPhone', 'iPad', 'Windows Phone',\n            'BlackBerry', 'Kindle', 'Opera Mini', 'Opera Mobi'\n        );\n        \n        foreach ($mobile_agents as $agent) {\n            if (stripos($user_agent, $agent) !== false) {\n                return true;\n            }\n        }\n        \n        return false;\n    }\n}\n\n\/**\n * \u53d6\u5f97\u65e5\u671f\u6642\u9593\u683c\u5f0f\n *\/\nif (!function_exists('_9o_van_date_format')) {\n    function _9o_van_date_format($timestamp = null, $format = 'Y-m-d H:i:s') {\n        if ($timestamp === null) {\n            $timestamp = current_time('timestamp');\n        }\n        \n        return wp_date($format, $timestamp);\n    }\n}\n\n\/**\n * \u8a08\u7b97\u5169\u500b\u65e5\u671f\u4e4b\u9593\u7684\u5929\u6578\n *\/\nif (!function_exists('_9o_van_days_between')) {\n    function _9o_van_days_between($date1, $date2) {\n        $datetime1 = new DateTime($date1);\n        $datetime2 = new DateTime($date2);\n        $interval = $datetime1->diff($datetime2);\n        \n        return $interval->days;\n    }\n}\n\n\/**\n * \u6aa2\u67e5\u6642\u9593\u662f\u5426\u5728\u6307\u5b9a\u7bc4\u570d\u5167\n *\/\nif (!function_exists('_9o_van_time_in_range')) {\n    function _9o_van_time_in_range($time, $start, $end) {\n        $time = strtotime($time);\n        $start = strtotime($start);\n        $end = strtotime($end);\n        \n        if ($end < $start) {\n            \/\/ \u8de8\u65e5\u7684\u60c5\u6cc1\uff08\u5982 22:00 - 08:00\uff09\n            return $time >= $start || $time <= $end;\n        }\n        \n        return $time >= $start && $time <= $end;\n    }\n}\n\n\/**\n * \u9663\u5217\u8f49\u63db\u70ba\u9078\u9805HTML\n *\/\nif (!function_exists('_9o_van_array_to_options')) {\n    function _9o_van_array_to_options($array, $selected = '') {\n        $html = '';\n        foreach ($array as $value => $label) {\n            $selected_attr = selected($selected, $value, false);\n            $html .= sprintf('<option value=\"%s\" %s>%s<\/option>', \n                esc_attr($value), \n                $selected_attr, \n                esc_html($label)\n            );\n        }\n        return $html;\n    }\n}","active":true,"priority":4,"modified":"2025-09-13 14:22:51","revision":"1"}]}