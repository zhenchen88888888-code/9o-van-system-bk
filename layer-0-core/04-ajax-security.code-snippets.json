{"generator":"Code Snippets v3.7.0","date_created":"2025-09-15 14:39","snippets":[{"id":80,"name":" 04-Ajax-Security","code":"\/**\n * ============================================================================\n * Snippet: 04-Ajax-Security\n * Title: AJAX \u5b89\u5168\u6846\u67b6\n * Description: \u63d0\u4f9bAJAX\u8acb\u6c42\u7684\u5b89\u5168\u9a57\u8b49\u3001\u9650\u6d41\u3001CORS\u8655\u7406\u7b49\u529f\u80fd\n * Version: 1.0.0\n * Author: 9o Van Development Team\n * Created: 2025-09-13\n * Modified: 2025-09-13\n * Priority: 5\n * Dependencies: 00-Global-Constants, 03-Common-Utilities\n * Hook: Run everywhere\n * ============================================================================\n *\/\n\n\/\/ \u9632\u6b62\u76f4\u63a5\u8a2a\u554f\nif (!defined('ABSPATH')) {\n    exit;\n}\n\n\/**\n * AJAX \u5b89\u5168\u6846\u67b6\u985e\u5225\n *\/\nclass NineOVan_Ajax_Security {\n    \n    private static $instance = null;\n    private $nonce_action = '9o_van_ajax_nonce';\n    private $rate_limit_transient = '9o_van_rate_limit_';\n    \n    \/**\n     * \u53d6\u5f97\u55ae\u4f8b\u5be6\u4f8b\n     *\/\n    public static function get_instance() {\n        if (null === self::$instance) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n    \/**\n     * \u5efa\u69cb\u51fd\u5f0f\n     *\/\n    private function __construct() {\n        add_action('wp_enqueue_scripts', array($this, 'localize_ajax'));\n        add_action('admin_enqueue_scripts', array($this, 'localize_ajax_admin'));\n        add_action('wp_ajax_nopriv_9o_van_ajax', array($this, 'handle_public_ajax'));\n        add_action('wp_ajax_9o_van_ajax', array($this, 'handle_ajax'));\n    }\n    \n    \/**\n     * \u672c\u5730\u5316AJAX\u8a2d\u5b9a\uff08\u524d\u53f0\uff09\n     *\/\n    public function localize_ajax() {\n        wp_localize_script('jquery', 'nineOVanAjax', array(\n            'url' => admin_url('admin-ajax.php'),\n            'nonce' => wp_create_nonce($this->nonce_action),\n            'debug' => defined('NINE_O_VAN_DEBUG') ? NINE_O_VAN_DEBUG : false\n        ));\n    }\n    \n    \/**\n     * \u672c\u5730\u5316AJAX\u8a2d\u5b9a\uff08\u5f8c\u53f0\uff09\n     *\/\n    public function localize_ajax_admin() {\n        wp_localize_script('jquery', 'nineOVanAjaxAdmin', array(\n            'url' => admin_url('admin-ajax.php'),\n            'nonce' => wp_create_nonce($this->nonce_action . '_admin'),\n            'debug' => defined('NINE_O_VAN_DEBUG') ? NINE_O_VAN_DEBUG : false\n        ));\n    }\n    \n    \/**\n     * \u8655\u7406\u516c\u958bAJAX\u8acb\u6c42\n     *\/\n    public function handle_public_ajax() {\n        $this->handle_ajax(true);\n    }\n    \n    \/**\n     * \u8655\u7406AJAX\u8acb\u6c42\n     *\/\n    public function handle_ajax($is_public = false) {\n        \/\/ \u9a57\u8b49nonce\n        if (!$this->verify_nonce($is_public)) {\n            $this->send_error('\u5b89\u5168\u9a57\u8b49\u5931\u6557', 403);\n        }\n        \n        \/\/ \u53d6\u5f97\u52d5\u4f5c\n        $action = isset($_POST['sub_action']) ? sanitize_text_field($_POST['sub_action']) : '';\n        \n        if (empty($action)) {\n            $this->send_error('\u672a\u6307\u5b9a\u52d5\u4f5c', 400);\n        }\n        \n        \/\/ \u6aa2\u67e5\u9650\u6d41\n        if (!$this->check_rate_limit($action)) {\n            $this->send_error('\u8acb\u6c42\u904e\u65bc\u983b\u7e41\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66', 429);\n        }\n        \n        \/\/ \u8a18\u9304\u8acb\u6c42\n        $this->log_request($action, $is_public);\n        \n        \/\/ \u89f8\u767c\u5c0d\u61c9\u7684\u52d5\u4f5c\n        $hook = $is_public ? 'wp_ajax_nopriv_' : 'wp_ajax_';\n        do_action($hook . '9o_van_' . $action);\n        \n        \/\/ \u5982\u679c\u6c92\u6709\u8655\u7406\u5668\uff0c\u8fd4\u56de\u932f\u8aa4\n        $this->send_error('\u672a\u77e5\u7684\u8acb\u6c42\u52d5\u4f5c: ' . $action, 404);\n    }\n    \n    \/**\n     * \u9a57\u8b49nonce\n     *\/\n    private function verify_nonce($is_public = false) {\n        $nonce = isset($_POST['nonce']) ? $_POST['nonce'] : '';\n        $action = $is_public ? $this->nonce_action : $this->nonce_action . '_admin';\n        return wp_verify_nonce($nonce, $action);\n    }\n    \n    \/**\n     * \u6aa2\u67e5\u9650\u6d41\n     *\/\n    private function check_rate_limit($action, $limit = 10, $window = 60) {\n        \/\/ \u53d6\u5f97\u7528\u6236\u8b58\u5225\n        $ip = _9o_van_get_client_ip();\n        $user_id = get_current_user_id();\n        $identifier = $user_id > 0 ? 'user_' . $user_id : 'ip_' . md5($ip);\n        \n        \/\/ \u5efa\u7acb\u9650\u6d41\u9375\n        $key = $this->rate_limit_transient . $action . '_' . $identifier;\n        \n        \/\/ \u53d6\u5f97\u7576\u524d\u8a08\u6578\n        $count = get_transient($key);\n        \n        if ($count === false) {\n            \/\/ \u9996\u6b21\u8acb\u6c42\n            set_transient($key, 1, $window);\n            return true;\n        }\n        \n        if ($count >= $limit) {\n            \/\/ \u8d85\u904e\u9650\u5236\n            return false;\n        }\n        \n        \/\/ \u589e\u52a0\u8a08\u6578\n        set_transient($key, $count + 1, $window);\n        return true;\n    }\n    \n    \/**\n     * \u8a18\u9304\u8acb\u6c42\n     *\/\n    private function log_request($action, $is_public) {\n        if (!defined('NINE_O_VAN_LOG_ERRORS') || !NINE_O_VAN_LOG_ERRORS) {\n            return;\n        }\n        \n        _9o_van_log(\n            'info',\n            'ajax',\n            sprintf('AJAX\u8acb\u6c42: %s (%s)', $action, $is_public ? '\u516c\u958b' : '\u767b\u5165'),\n            array(\n                'action' => $action,\n                'is_public' => $is_public,\n                'post_data' => $_POST\n            )\n        );\n    }\n    \n    \/**\n     * \u767c\u9001\u6210\u529f\u56de\u61c9\n     *\/\n    public static function send_success($data = null, $message = '\u6210\u529f') {\n        wp_send_json_success(array(\n            'message' => $message,\n            'data' => $data\n        ));\n    }\n    \n    \/**\n     * \u767c\u9001\u932f\u8aa4\u56de\u61c9\n     *\/\n    public static function send_error($message = '\u767c\u751f\u932f\u8aa4', $code = 400, $data = null) {\n        status_header($code);\n        wp_send_json_error(array(\n            'message' => $message,\n            'code' => $code,\n            'data' => $data\n        ));\n    }\n    \n    \/**\n     * \u8a3b\u518aAJAX\u8655\u7406\u5668\n     *\/\n    public static function register_handler($action, $callback, $public = true) {\n        add_action('wp_ajax_9o_van_' . $action, $callback);\n        \n        if ($public) {\n            add_action('wp_ajax_nopriv_9o_van_' . $action, $callback);\n        }\n    }\n    \n    \/**\n     * \u9a57\u8b49\u8acb\u6c42\u8cc7\u6599\n     *\/\n    public static function validate_request($required_fields = array()) {\n        $errors = array();\n        \n        foreach ($required_fields as $field => $rules) {\n            $value = isset($_POST[$field]) ? $_POST[$field] : '';\n            \n            \/\/ \u6aa2\u67e5\u5fc5\u586b\n            if (in_array('required', $rules) && empty($value)) {\n                $errors[$field] = $field . ' \u70ba\u5fc5\u586b\u6b04\u4f4d';\n                continue;\n            }\n            \n            \/\/ \u6aa2\u67e5Email\n            if (in_array('email', $rules) && !empty($value)) {\n                if (!_9o_van_validate_email($value)) {\n                    $errors[$field] = 'Email \u683c\u5f0f\u4e0d\u6b63\u78ba';\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u96fb\u8a71\n            if (in_array('phone', $rules) && !empty($value)) {\n                if (!_9o_van_validate_phone($value)) {\n                    $errors[$field] = '\u96fb\u8a71\u683c\u5f0f\u4e0d\u6b63\u78ba';\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u6578\u5b57\n            if (in_array('numeric', $rules) && !empty($value)) {\n                if (!is_numeric($value)) {\n                    $errors[$field] = $field . ' \u5fc5\u9808\u662f\u6578\u5b57';\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u65e5\u671f\n            if (in_array('date', $rules) && !empty($value)) {\n                if (!preg_match('\/^\\d{4}-\\d{2}-\\d{2}$\/', $value)) {\n                    $errors[$field] = '\u65e5\u671f\u683c\u5f0f\u5fc5\u9808\u70ba YYYY-MM-DD';\n                }\n            }\n            \n            \/\/ \u6aa2\u67e5\u6642\u9593\n            if (in_array('time', $rules) && !empty($value)) {\n                if (!preg_match('\/^\\d{2}:\\d{2}(:\\d{2})?$\/', $value)) {\n                    $errors[$field] = '\u6642\u9593\u683c\u5f0f\u5fc5\u9808\u70ba HH:MM';\n                }\n            }\n        }\n        \n        if (!empty($errors)) {\n            self::send_error('\u8cc7\u6599\u9a57\u8b49\u5931\u6557', 400, $errors);\n        }\n        \n        return true;\n    }\n    \n    \/**\n     * \u53d6\u5f97\u6e05\u7406\u904e\u7684POST\u8cc7\u6599\n     *\/\n    public static function get_sanitized_data($fields = array()) {\n        $data = array();\n        \n        foreach ($fields as $field => $type) {\n            if (isset($_POST[$field])) {\n                $data[$field] = _9o_van_sanitize_input($_POST[$field], $type);\n            }\n        }\n        \n        return $data;\n    }\n}\n\n\/\/ \u521d\u59cb\u5316AJAX\u5b89\u5168\u6846\u67b6\nNineOVan_Ajax_Security::get_instance();\n\n\/**\n * \u5feb\u901f\u8a3b\u518aAJAX\u8655\u7406\u5668\n *\/\nif (!function_exists('_9o_van_ajax_handler')) {\n    function _9o_van_ajax_handler($action, $callback, $public = true) {\n        NineOVan_Ajax_Security::register_handler($action, $callback, $public);\n    }\n}\n\n\/**\n * \u767c\u9001AJAX\u6210\u529f\u56de\u61c9\n *\/\nif (!function_exists('_9o_van_ajax_success')) {\n    function _9o_van_ajax_success($data = null, $message = '\u6210\u529f') {\n        NineOVan_Ajax_Security::send_success($data, $message);\n    }\n}\n\n\/**\n * \u767c\u9001AJAX\u932f\u8aa4\u56de\u61c9\n *\/\nif (!function_exists('_9o_van_ajax_error')) {\n    function _9o_van_ajax_error($message = '\u767c\u751f\u932f\u8aa4', $code = 400, $data = null) {\n        NineOVan_Ajax_Security::send_error($message, $code, $data);\n    }\n}\n\n\/**\n * \u7bc4\u4f8b\uff1a\u8a3b\u518a\u4e00\u500b\u6e2c\u8a66AJAX\u8655\u7406\u5668\n *\/\n_9o_van_ajax_handler('test', function() {\n    \/\/ \u9a57\u8b49\u5fc5\u586b\u6b04\u4f4d\n    NineOVan_Ajax_Security::validate_request(array(\n        'name' => array('required'),\n        'email' => array('required', 'email')\n    ));\n    \n    \/\/ \u53d6\u5f97\u6e05\u7406\u904e\u7684\u8cc7\u6599\n    $data = NineOVan_Ajax_Security::get_sanitized_data(array(\n        'name' => 'text',\n        'email' => 'email'\n    ));\n    \n    \/\/ \u8655\u7406\u908f\u8f2f\n    _9o_van_ajax_success($data, '\u6e2c\u8a66\u6210\u529f');\n}, true);","active":true,"priority":5,"modified":"2025-09-13 14:24:06","revision":"1"}]}